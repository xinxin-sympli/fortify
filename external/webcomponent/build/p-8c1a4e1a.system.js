var __extends=this&&this.__extends||function(){var e=function(t,r){e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return e(t,r)};return function(t,r){e(t,r);function n(){this.constructor=t}t.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();var __awaiter=this&&this.__awaiter||function(e,t,r,n){function i(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function a(e){try{u(n.next(e))}catch(t){o(t)}}function s(e){try{u(n["throw"](e))}catch(t){o(t)}}function u(e){e.done?r(e.value):i(e.value).then(a,s)}u((n=n.apply(e,t||[])).next())}))};var __generator=this&&this.__generator||function(e,t){var r={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,a;return a={next:s(0),throw:s(1),return:s(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function s(e){return function(t){return u([e,t])}}function u(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,i&&(o=a[0]&2?i["return"]:a[0]?i["throw"]||((o=i["return"])&&o.call(i),0):i.next)&&!(o=o.call(i,a[1])).done)return o;if(i=0,o)a=[a[0]&2,o.value];switch(a[0]){case 0:case 1:o=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;i=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(o=r.trys,o=o.length>0&&o[o.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(a[0]===6&&r.label<o[1]){r.label=o[1];o=a;break}if(o&&r.label<o[2]){r.label=o[2];r.ops.push(a);break}if(o[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(s){a=[6,s];i=0}finally{n=o=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;for(var n=Array(e),i=0,t=0;t<r;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)n[i]=o[a];return n};System.register([],(function(){"use strict";return{execute:function(){var e=function(e,t,r,n){r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r["default"]:r;n=n&&Object.prototype.hasOwnProperty.call(n,"default")?n["default"]:n;function i(e){if(typeof Buffer!=="undefined"&&Buffer.isBuffer(e)){return new Uint8Array(e)}else if(ArrayBuffer.isView(e)){return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}else{return new Uint8Array(e)}}var o=function(){function e(){}e.ToString=function(e,t){if(t===void 0){t="utf8"}var r=i(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);default:throw new Error("Unknown type of encoding '"+t+"'")}};e.FromString=function(e,t){if(t===void 0){t="utf8"}switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);default:throw new Error("Unknown type of encoding '"+t+"'")}};e.ToBase64=function(e){var t=i(e);if(typeof btoa!=="undefined"){var r=this.ToString(t,"binary");return btoa(r)}else{return Buffer.from(t).toString("base64")}};e.FromBase64=function(e){e=e.replace(/\n/g,"").replace(/\r/g,"").replace(/\t/g,"").replace(/\s/g,"");if(typeof atob!=="undefined"){return this.FromBinary(atob(e))}else{return new Uint8Array(Buffer.from(e,"base64")).buffer}};e.FromBase64Url=function(e){return this.FromBase64(this.Base64Padding(e.replace(/\-/g,"+").replace(/\_/g,"/")))};e.ToBase64Url=function(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")};e.FromUtf8String=function(e){var t=unescape(encodeURIComponent(e));var r=new Uint8Array(t.length);for(var n=0;n<t.length;n++){r[n]=t.charCodeAt(n)}return r.buffer};e.ToUtf8String=function(e){var t=i(e);var r=String.fromCharCode.apply(null,t);var n=decodeURIComponent(escape(r));return n};e.FromBinary=function(e){var t=e.length;var r=new Uint8Array(t);for(var n=0;n<t;n++){r[n]=e.charCodeAt(n)}return r.buffer};e.ToBinary=function(e){var t=i(e);var r="";var n=t.length;for(var o=0;o<n;o++){r=r+String.fromCharCode(t[o])}return r};e.ToHex=function(e){var t=i(e);var r="";var n=[];var o=t.length;for(var a=0;a<o;a++){var s=t[a].toString(16);n.push(s.length===1?"0"+s:s)}return n.join(r)};e.FromHex=function(e){var t=new Uint8Array(e.length/2);for(var r=0;r<e.length;r=r+2){var n=e.slice(r,r+2);t[r/2]=parseInt(n,16)}return t.buffer};e.Base64Padding=function(e){var t=4-e.length%4;if(t<4){for(var r=0;r<t;r++){e+="="}}return e};return e}();var a=function(){function e(){}e.toArrayBuffer=function(e){var t=this.toUint8Array(e);if(t.byteOffset||t.length){return t.buffer.slice(t.byteOffset,t.byteOffset+t.length)}return t.buffer};e.toUint8Array=function(e){if(typeof Buffer!=="undefined"&&Buffer.isBuffer(e)){return new Uint8Array(e)}if(ArrayBuffer.isView(e)){return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}if(e instanceof ArrayBuffer){return new Uint8Array(e)}throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")};e.isBufferSource=function(e){return ArrayBuffer.isView(e)||e instanceof ArrayBuffer};return e}();function s(e){var t=[];for(var r=1;r<arguments.length;r++){t[r-1]=arguments[r]}var n=arguments[0];for(var i=1;i<arguments.length;i++){var o=arguments[i];for(var a in o){n[a]=o[a]}}return n}function u(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}var r=e.map((function(e){return e.byteLength})).reduce((function(e,t){return e+t}));var n=new Uint8Array(r);var i=0;e.map((function(e){return new Uint8Array(e)})).forEach((function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];n[i++]=o}}));return n.buffer}function c(e,t){if(!(e&&t)){return false}if(e.byteLength!==t.byteLength){return false}var r=new Uint8Array(e);var n=new Uint8Array(t);for(var i=0;i<e.byteLength;i++){if(r[i]!==n[i]){return false}}return true}
/*! *****************************************************************************
                Copyright (c) Microsoft Corporation.
                Permission to use, copy, modify, and/or distribute this software for any
                purpose with or without fee is hereby granted.
                THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
                REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
                AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
                INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
                LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
                OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
                PERFORMANCE OF THIS SOFTWARE.
                ***************************************************************************** */function l(e,t,r,n){var i=arguments.length,o=i<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)if(a=e[s])o=(i<3?a(o):i>3?a(t,r,o):a(t,r))||o;return i>3&&o&&Object.defineProperty(t,r,o),o}var f=function(){function e(){}e.set=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Uint8Array(e)]}))}))};e.get=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Uint8Array(e).buffer]}))}))};return e}();function h(e){return function(r){var n=r;n.localName=e.name||n.name||n.toString().match(/^function\s*([^\s(]+)/)[1];n.items=n.items||{};n.target=r;n.items=s({},n.items);var i=new t.Type(n.localName);for(var o in n.items){var a=n.items[o];var u=void 0;if(a.repeated){u="repeated"}else if(a.required){u="required"}i.add(new t.Field(a.name,a.id,a.type,u))}n.protobuf=i}}function v(e,t,r){var n="_"+t;var i={set:function(e){if(this[n]!==e){this.raw=null;this[n]=e}},get:function(){if(this[n]===void 0){var e=r.defaultValue;if(r.parser&&!r.repeated){e=new r.parser}this[n]=e}return this[n]},enumerable:true};Object.defineProperty(e,n,{writable:true,enumerable:false});Object.defineProperty(e,t,i)}function p(e){return function(t,r){var n=t.constructor;var i=r;n.items=n.items||{};if(n.target!==n){n.items=s({},n.items);n.target=n}n.items[i]={id:e.id,type:e.type||"bytes",defaultValue:e.defaultValue,converter:e.converter||null,parser:e.parser||null};e.name=e.name||i;n.items[i].name=e.name;n.items[i].required=e.required||false;n.items[i].repeated=e.repeated||false;v(t,i,n.items[i])}}var d=function(){function e(){}e.importProto=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t=new this;return[4,t.importProto(e)];case 1:r.sent();return[2,t]}}))}))};e.prototype.isEmpty=function(){return this.raw===undefined};e.prototype.hasChanged=function(){if(this.raw===null){return true}var e=this.constructor;var t=this;for(var r in e.items){var n=e.items[r];if(n.repeated){if(n.parser){return t[r].some((function(e){return e.hasChanged()}))}}else{if(n.parser&&t[r]&&t[r].hasChanged()){return true}}}return false};e.prototype.importProto=function(t){return me(this,void 0,void 0,(function(){var r,n,i,o,a,s,u,c,l,f,h,v,p,d,y,g,m;return __generator(this,(function(b){switch(b.label){case 0:r=this.constructor;n=this;if(!(t instanceof e))return[3,2];return[4,t.exportProto()];case 1:o=b.sent();return[3,3];case 2:o=t;b.label=3;case 3:try{i=r.protobuf.decode(new Uint8Array(o))}catch(w){throw new Error("Error: Cannot decode message for "+r.localName+".\n$ProtobufError: "+w.message)}a=[];for(s in r.items)a.push(s);u=0;b.label=4;case 4:if(!(u<a.length))return[3,11];c=a[u];l=r.items[c];f=i[l.name];if(ArrayBuffer.isView(f)){f=new Uint8Array(f)}if(!Array.isArray(f)){if(l.repeated){n[c]=f=[]}else{f=[f]}}if(l.repeated&&!n[c]){n[c]=[]}h=0,v=f;b.label=5;case 5:if(!(h<v.length))return[3,10];p=v[h];if(!l.repeated)return[3,7];y=(d=n[c]).push;return[4,this.importItem(l,p)];case 6:y.apply(d,[b.sent()]);return[3,9];case 7:g=n;m=c;return[4,this.importItem(l,p)];case 8:g[m]=b.sent();b.label=9;case 9:h++;return[3,5];case 10:u++;return[3,4];case 11:this.raw=o;return[2]}}))}))};e.prototype.exportProto=function(){return me(this,void 0,void 0,(function(){var e,t,r,n,i,o,a,s,u,c,l,f,h;return __generator(this,(function(v){switch(v.label){case 0:if(!this.hasChanged()){return[2,this.raw]}e=this.constructor;t=this;r={};n=[];for(i in e.items)n.push(i);o=0;v.label=1;case 1:if(!(o<n.length))return[3,6];a=n[o];s=e.items[a];u=t[a];if(!Array.isArray(u)){u=u===void 0?[]:[u]}c=0,l=u;v.label=2;case 2:if(!(c<l.length))return[3,5];f=l[c];return[4,this.exportItem(s,f)];case 3:h=v.sent();if(s.repeated){if(!r[s.name]){r[s.name]=[]}r[s.name].push(h)}else{r[s.name]=h}v.label=4;case 4:c++;return[3,2];case 5:o++;return[3,1];case 6:this.raw=new Uint8Array(e.protobuf.encode(r).finish()).buffer;return[2,this.raw]}}))}))};e.prototype.exportItem=function(e,t){return me(this,void 0,void 0,(function(){var r,n,i,o;return __generator(this,(function(a){switch(a.label){case 0:r=this.constructor;if(!e.parser)return[3,2];i=t;return[4,i.exportProto()];case 1:o=a.sent();if(e.required&&!o){throw new Error("Error: Paramter '"+e.name+"' is required in '"+r.localName+"' protobuf message.")}if(o){n=new Uint8Array(o)}return[3,6];case 2:if(e.required&&t===void 0){throw new Error("Error: Paramter '"+e.name+"' is required in '"+r.localName+"' protobuf message.")}if(!e.converter)return[3,5];if(!t)return[3,4];return[4,e.converter.set(t)];case 3:n=a.sent();a.label=4;case 4:return[3,6];case 5:if(t instanceof ArrayBuffer){t=new Uint8Array(t)}n=t;a.label=6;case 6:return[2,n]}}))}))};e.prototype.importItem=function(e,t){return me(this,void 0,void 0,(function(){var r,n,i;return __generator(this,(function(o){switch(o.label){case 0:r=this.constructor;if(!e.parser)return[3,4];i=e.parser;if(!(t&&t.byteLength))return[3,2];return[4,i.importProto(new Uint8Array(t).buffer)];case 1:n=o.sent();return[3,3];case 2:if(e.required){throw new Error("Error: Parameter '"+e.name+"' is required in '"+r.localName+"' protobuf message.")}o.label=3;case 3:return[3,9];case 4:if(!e.converter)return[3,8];if(!(t&&t.byteLength))return[3,6];return[4,e.converter.get(t)];case 5:n=o.sent();return[3,7];case 6:if(e.required){throw new Error("Error: Parameter '"+e.name+"' is required in '"+r.localName+"' protobuf message.")}o.label=7;case 7:return[3,9];case 8:n=t;o.label=9;case 9:return[2,n]}}))}))};return e}();function y(){}y.prototype=Object.create(null);function g(){g.init.call(this)}g.EventEmitter=g;g.usingDomains=false;g.prototype.domain=undefined;g.prototype._events=undefined;g.prototype._maxListeners=undefined;g.defaultMaxListeners=10;g.init=function(){this.domain=null;if(!this._events||this._events===Object.getPrototypeOf(this)._events){this._events=new y;this._eventsCount=0}this._maxListeners=this._maxListeners||undefined};g.prototype.setMaxListeners=function e(t){if(typeof t!=="number"||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');this._maxListeners=t;return this};function m(e){if(e._maxListeners===undefined)return g.defaultMaxListeners;return e._maxListeners}g.prototype.getMaxListeners=function e(){return m(this)};function b(e,t,r){if(t)e.call(r);else{var n=e.length;var i=x(e,n);for(var o=0;o<n;++o)i[o].call(r)}}function w(e,t,r,n){if(t)e.call(r,n);else{var i=e.length;var o=x(e,i);for(var a=0;a<i;++a)o[a].call(r,n)}}function k(e,t,r,n,i){if(t)e.call(r,n,i);else{var o=e.length;var a=x(e,o);for(var s=0;s<o;++s)a[s].call(r,n,i)}}function B(e,t,r,n,i,o){if(t)e.call(r,n,i,o);else{var a=e.length;var s=x(e,a);for(var u=0;u<a;++u)s[u].call(r,n,i,o)}}function _(e,t,r,n){if(t)e.apply(r,n);else{var i=e.length;var o=x(e,i);for(var a=0;a<i;++a)o[a].apply(r,n)}}g.prototype.emit=function e(t){var r,n,i,o,a,s,u;var c=t==="error";s=this._events;if(s)c=c&&s.error==null;else if(!c)return false;u=this.domain;if(c){r=arguments[1];if(u){if(!r)r=new Error('Uncaught, unspecified "error" event');r.domainEmitter=this;r.domain=u;r.domainThrown=false;u.emit("error",r)}else if(r instanceof Error){throw r}else{var l=new Error('Uncaught, unspecified "error" event. ('+r+")");l.context=r;throw l}return false}n=s[t];if(!n)return false;var f=typeof n==="function";i=arguments.length;switch(i){case 1:b(n,f,this);break;case 2:w(n,f,this,arguments[1]);break;case 3:k(n,f,this,arguments[1],arguments[2]);break;case 4:B(n,f,this,arguments[1],arguments[2],arguments[3]);break;default:o=new Array(i-1);for(a=1;a<i;a++)o[a-1]=arguments[a];_(n,f,this,o)}return true};function N(e,t,r,n){var i;var o;var a;if(typeof r!=="function")throw new TypeError('"listener" argument must be a function');o=e._events;if(!o){o=e._events=new y;e._eventsCount=0}else{if(o.newListener){e.emit("newListener",t,r.listener?r.listener:r);o=e._events}a=o[t]}if(!a){a=o[t]=r;++e._eventsCount}else{if(typeof a==="function"){a=o[t]=n?[r,a]:[a,r]}else{if(n){a.unshift(r)}else{a.push(r)}}if(!a.warned){i=m(e);if(i&&i>0&&a.length>i){a.warned=true;var s=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+t+" listeners added. "+"Use emitter.setMaxListeners() to increase limit");s.name="MaxListenersExceededWarning";s.emitter=e;s.type=t;s.count=a.length;E(s)}}}return e}function E(e){typeof console.warn==="function"?console.warn(e):console.log(e)}g.prototype.addListener=function e(t,r){return N(this,t,r,false)};g.prototype.on=g.prototype.addListener;g.prototype.prependListener=function e(t,r){return N(this,t,r,true)};function A(e,t,r){var n=false;function i(){e.removeListener(t,i);if(!n){n=true;r.apply(e,arguments)}}i.listener=r;return i}g.prototype.once=function e(t,r){if(typeof r!=="function")throw new TypeError('"listener" argument must be a function');this.on(t,A(this,t,r));return this};g.prototype.prependOnceListener=function e(t,r){if(typeof r!=="function")throw new TypeError('"listener" argument must be a function');this.prependListener(t,A(this,t,r));return this};g.prototype.removeListener=function e(t,r){var n,i,o,a,s;if(typeof r!=="function")throw new TypeError('"listener" argument must be a function');i=this._events;if(!i)return this;n=i[t];if(!n)return this;if(n===r||n.listener&&n.listener===r){if(--this._eventsCount===0)this._events=new y;else{delete i[t];if(i.removeListener)this.emit("removeListener",t,n.listener||r)}}else if(typeof n!=="function"){o=-1;for(a=n.length;a-- >0;){if(n[a]===r||n[a].listener&&n[a].listener===r){s=n[a].listener;o=a;break}}if(o<0)return this;if(n.length===1){n[0]=undefined;if(--this._eventsCount===0){this._events=new y;return this}else{delete i[t]}}else{S(n,o)}if(i.removeListener)this.emit("removeListener",t,s||r)}return this};g.prototype.removeAllListeners=function e(t){var r,n;n=this._events;if(!n)return this;if(!n.removeListener){if(arguments.length===0){this._events=new y;this._eventsCount=0}else if(n[t]){if(--this._eventsCount===0)this._events=new y;else delete n[t]}return this}if(arguments.length===0){var i=Object.keys(n);for(var o=0,a;o<i.length;++o){a=i[o];if(a==="removeListener")continue;this.removeAllListeners(a)}this.removeAllListeners("removeListener");this._events=new y;this._eventsCount=0;return this}r=n[t];if(typeof r==="function"){this.removeListener(t,r)}else if(r){do{this.removeListener(t,r[r.length-1])}while(r[0])}return this};g.prototype.listeners=function e(t){var r;var n;var i=this._events;if(!i)n=[];else{r=i[t];if(!r)n=[];else if(typeof r==="function")n=[r.listener||r];else n=D(r)}return n};g.listenerCount=function(e,t){if(typeof e.listenerCount==="function"){return e.listenerCount(t)}else{return I.call(e,t)}};g.prototype.listenerCount=I;function I(e){var t=this._events;if(t){var r=t[e];if(typeof r==="function"){return 1}else if(r){return r.length}}return 0}g.prototype.eventNames=function e(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};function S(e,t){for(var r=t,n=r+1,i=e.length;n<i;r+=1,n+=1)e[r]=e[n];e.pop()}function x(e,t){var r=new Array(t);while(t--)r[t]=e[t];return r}function D(e){var t=new Array(e.length);for(var r=0;r<t.length;++r){t[r]=e[r].listener||e[r]}return t}var C="ECDSA";var O="ECDH";var K="AES-CBC";var T="SHA-256";var U="HMAC";var L=20;var H=o.FromBinary("InfoText");var X=o.FromBinary("InfoRatchet");var R=o.FromBinary("InfoMessageKeys");var P=null;if(typeof self!=="undefined"){P={crypto:self.crypto,name:"WebCrypto"}}function q(e,t){P={crypto:t,name:e}}function j(){if(!P){throw new Error("WebCrypto engine is empty. Use setEngine to resolve it.")}return P}var V=function(){var e=function(){function e(){}e.generateKeyPair=function(e,t){return me(this,void 0,void 0,(function(){var r,n,i,o,a;return __generator(this,(function(s){switch(s.label){case 0:r=e;n=e==="ECDSA"?["sign","verify"]:["deriveKey","deriveBits"];return[4,j().crypto.subtle.generateKey({name:r,namedCurve:this.NAMED_CURVE},t,n)];case 1:i=s.sent();return[4,M.create(i.publicKey)];case 2:o=s.sent();a={privateKey:i.privateKey,publicKey:o};return[2,a]}}))}))};e.deriveBytes=function(e,t){return j().crypto.subtle.deriveBits({name:"ECDH",public:t.key},e,256)};e.verify=function(e,t,r){return j().crypto.subtle.verify({name:"ECDSA",hash:this.DIGEST_ALGORITHM},e.key,r,t)};e.sign=function(e,t){return me(this,void 0,void 0,(function(){return __generator(this,(function(r){return[2,j().crypto.subtle.sign({name:"ECDSA",hash:this.DIGEST_ALGORITHM},e,t)]}))}))};e.ecKeyPairToJson=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t={privateKey:e.privateKey,publicKey:e.publicKey.key};return[4,e.publicKey.thumbprint()];case 1:return[2,(t.thumbprint=r.sent(),t)]}}))}))};e.ecKeyPairFromJson=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t={privateKey:e.privateKey};return[4,M.create(e.publicKey)];case 1:return[2,(t.publicKey=r.sent(),t)]}}))}))};return e}();e.NAMED_CURVE="P-256";e.DIGEST_ALGORITHM="SHA-512";return e}();var J={name:"AES-CBC",length:256};var F=function(){function e(){}e.randomBytes=function(e){var t=new Uint8Array(e);j().crypto.getRandomValues(t);return t.buffer};e.digest=function(e,t){return j().crypto.subtle.digest(e,t)};e.encrypt=function(e,t,r){return j().crypto.subtle.encrypt({name:K,iv:new Uint8Array(r)},e,t)};e.decrypt=function(e,t,r){return j().crypto.subtle.decrypt({name:K,iv:new Uint8Array(r)},e,t)};e.importHMAC=function(e){return j().crypto.subtle.importKey("raw",e,{name:U,hash:{name:T}},false,["sign","verify"])};e.importAES=function(e){return j().crypto.subtle.importKey("raw",e,J,false,["encrypt","decrypt"])};e.sign=function(e,t){return me(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,j().crypto.subtle.sign({name:U,hash:T},e,t)];case 1:return[2,r.sent()]}}))}))};e.HKDF=function(e,t,r,n){if(t===void 0){t=1}if(n===void 0){n=new ArrayBuffer(0)}return me(this,void 0,void 0,(function(){var i,o,a,s,c,l;return __generator(this,(function(f){switch(f.label){case 0:if(!!r)return[3,2];return[4,this.importHMAC(new Uint8Array(32).buffer)];case 1:r=f.sent();f.label=2;case 2:return[4,this.sign(r,e)];case 3:i=f.sent();return[4,this.importHMAC(i)];case 4:o=f.sent();a=[new ArrayBuffer(0)];s=0;f.label=5;case 5:if(!(s<t))return[3,8];c=a;l=s+1;return[4,this.sign(o,u(a[s],n,new Uint8Array([s+1]).buffer))];case 6:c[l]=f.sent();f.label=7;case 7:s++;return[3,5];case 8:return[2,a.slice(1)]}}))}))};return e}();var M=function(){function e(){}e.create=function(e){return me(this,void 0,void 0,(function(){var t,r,n,i,a,s,u;return __generator(this,(function(c){switch(c.label){case 0:t=new this;r=e.algorithm.name.toUpperCase();if(!(r==="ECDH"||r==="ECDSA")){throw new Error("Error: Unsupported asymmetric key algorithm.")}if(e.type!=="public"){throw new Error("Error: Expected key type to be public but it was not.")}t.key=e;return[4,j().crypto.subtle.exportKey("jwk",e)];case 1:n=c.sent();if(!(n.x&&n.y)){throw new Error("Wrong JWK data for EC public key. Parameters x and y are required.")}i=o.FromBase64Url(n.x);a=o.FromBase64Url(n.y);s=o.ToBinary(i)+o.ToBinary(a);t.serialized=o.FromBinary(s);u=t;return[4,t.thumbprint()];case 2:u.id=c.sent();return[2,t]}}))}))};e.importKey=function(t,r){return me(this,void 0,void 0,(function(){var n,i,a,s,u,c;return __generator(this,(function(l){switch(l.label){case 0:n=o.ToBase64Url(t.slice(0,32));i=o.ToBase64Url(t.slice(32));a={crv:V.NAMED_CURVE,kty:"EC",x:n,y:i};s=r==="ECDSA"?["verify"]:[];return[4,j().crypto.subtle.importKey("jwk",a,{name:r,namedCurve:V.NAMED_CURVE},true,s)];case 1:u=l.sent();return[4,e.create(u)];case 2:c=l.sent();return[2,c]}}))}))};e.prototype.serialize=function(){return this.serialized};e.prototype.thumbprint=function(){return me(this,void 0,void 0,(function(){var e,t;return __generator(this,(function(r){switch(r.label){case 0:return[4,this.serialize()];case 1:e=r.sent();return[4,F.digest("SHA-256",e)];case 2:t=r.sent();return[2,o.ToHex(t)]}}))}))};e.prototype.isEqual=function(t){return me(this,void 0,void 0,(function(){return __generator(this,(function(r){if(!(t&&t instanceof e)){return[2,false]}return[2,c(this.serialized,t.serialized)]}))}))};return e}();var G=function(){function e(e,t,r){this.id=e;this.signingKey=t;this.exchangeKey=r;this.preKeys=[];this.signedPreKeys=[]}e.fromJSON=function(e){return me(this,void 0,void 0,(function(){var t,r,n;return __generator(this,(function(i){switch(i.label){case 0:return[4,V.ecKeyPairFromJson(e.signingKey)];case 1:t=i.sent();return[4,V.ecKeyPairFromJson(e.exchangeKey)];case 2:r=i.sent();n=new this(e.id,t,r);n.createdAt=new Date(e.createdAt);return[4,n.fromJSON(e)];case 3:i.sent();return[2,n]}}))}))};e.create=function(t,r,n,i){if(r===void 0){r=0}if(n===void 0){n=0}if(i===void 0){i=false}return me(this,void 0,void 0,(function(){var o,a,s,u,c,l,u,f,h;return __generator(this,(function(v){switch(v.label){case 0:return[4,V.generateKeyPair(C,i)];case 1:o=v.sent();return[4,V.generateKeyPair(O,i)];case 2:a=v.sent();s=new e(t,o,a);s.createdAt=new Date;u=0;v.label=3;case 3:if(!(u<n))return[3,6];l=(c=s.preKeys).push;return[4,V.generateKeyPair("ECDH",i)];case 4:l.apply(c,[v.sent()]);v.label=5;case 5:u++;return[3,3];case 6:u=0;v.label=7;case 7:if(!(u<r))return[3,10];h=(f=s.signedPreKeys).push;return[4,V.generateKeyPair("ECDH",i)];case 8:h.apply(f,[v.sent()]);v.label=9;case 9:u++;return[3,7];case 10:return[2,s]}}))}))};e.prototype.toJSON=function(){return me(this,void 0,void 0,(function(){var e,t,r,n,i,o,a,s,u,i,c,l,f;return __generator(this,(function(h){switch(h.label){case 0:e=[];t=[];r=0,n=this.preKeys;h.label=1;case 1:if(!(r<n.length))return[3,4];i=n[r];a=(o=e).push;return[4,V.ecKeyPairToJson(i)];case 2:a.apply(o,[h.sent()]);h.label=3;case 3:r++;return[3,1];case 4:s=0,u=this.signedPreKeys;h.label=5;case 5:if(!(s<u.length))return[3,8];i=u[s];l=(c=t).push;return[4,V.ecKeyPairToJson(i)];case 6:l.apply(c,[h.sent()]);h.label=7;case 7:s++;return[3,5];case 8:f={createdAt:this.createdAt.toISOString()};return[4,V.ecKeyPairToJson(this.exchangeKey)];case 9:f.exchangeKey=h.sent(),f.id=this.id,f.preKeys=e,f.signedPreKeys=t;return[4,V.ecKeyPairToJson(this.signingKey)];case 10:return[2,(f.signingKey=h.sent(),f)]}}))}))};e.prototype.fromJSON=function(e){return me(this,void 0,void 0,(function(){var t,r,n,i,o,a,s,u,c,o,l,f;return __generator(this,(function(h){switch(h.label){case 0:this.id=e.id;t=this;return[4,V.ecKeyPairFromJson(e.signingKey)];case 1:t.signingKey=h.sent();r=this;return[4,V.ecKeyPairFromJson(e.exchangeKey)];case 2:r.exchangeKey=h.sent();this.preKeys=[];n=0,i=e.preKeys;h.label=3;case 3:if(!(n<i.length))return[3,6];o=i[n];s=(a=this.preKeys).push;return[4,V.ecKeyPairFromJson(o)];case 4:s.apply(a,[h.sent()]);h.label=5;case 5:n++;return[3,3];case 6:this.signedPreKeys=[];u=0,c=e.signedPreKeys;h.label=7;case 7:if(!(u<c.length))return[3,10];o=c[u];f=(l=this.signedPreKeys).push;return[4,V.ecKeyPairFromJson(o)];case 8:f.apply(l,[h.sent()]);h.label=9;case 9:u++;return[3,7];case 10:return[2]}}))}))};return e}();var z=function(){function e(){}e.fill=function(t){var r=new e;r.fill(t);return r};e.fromJSON=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t=new this;return[4,t.fromJSON(e)];case 1:r.sent();return[2,t]}}))}))};e.prototype.fill=function(e){this.signingKey=e.signingKey;this.exchangeKey=e.exchangeKey;this.signature=e.signature;this.createdAt=e.createdAt};e.prototype.verify=function(){return V.verify(this.signingKey,this.exchangeKey.serialize(),this.signature)};e.prototype.toJSON=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:e={createdAt:this.createdAt.toISOString()};return[4,this.exchangeKey.key];case 1:e.exchangeKey=t.sent(),e.id=this.id,e.signature=this.signature;return[4,this.signingKey.key];case 2:e.signingKey=t.sent();return[4,this.signingKey.thumbprint()];case 3:return[2,(e.thumbprint=t.sent(),e)]}}))}))};e.prototype.fromJSON=function(e){return me(this,void 0,void 0,(function(){var t,r,n;return __generator(this,(function(i){switch(i.label){case 0:this.id=e.id;this.signature=e.signature;t=this;return[4,M.create(e.signingKey)];case 1:t.signingKey=i.sent();r=this;return[4,M.create(e.exchangeKey)];case 2:r.exchangeKey=i.sent();this.createdAt=new Date(e.createdAt);return[4,this.verify()];case 3:n=i.sent();if(!n){throw new Error("Error: Wrong signature for RemoteIdentity")}return[2]}}))}))};return e}();var W=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(d);l([p({id:0,type:"uint32",defaultValue:1})],e.prototype,"version",void 0);e=l([h({name:"Base"})],e);return e}();var Y=function(){function e(){}e.set=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Uint8Array(e.serialize())]}))}))};e.get=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,M.importKey(e.buffer,"ECDSA")]}))}))};return e}();var Z=function(){function e(){}e.set=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Uint8Array(e.serialize())]}))}))};e.get=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,M.importKey(e.buffer,"ECDH")]}))}))};return e}();var $=function(){function e(){}e.set=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Uint8Array(o.FromString(e.toISOString()))]}))}))};e.get=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Date(o.ToString(e))]}))}))};return e}();var Q=function(){var e;var t=e=function(t){__extends(r,t);function r(){return t!==null&&t.apply(this,arguments)||this}r.fill=function(t){return me(this,void 0,void 0,(function(){var r;return __generator(this,(function(n){switch(n.label){case 0:r=new e;return[4,r.fill(t)];case 1:n.sent();return[2,r]}}))}))};r.prototype.sign=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t=this;return[4,V.sign(e,this.exchangeKey.serialize())];case 1:t.signature=r.sent();return[2]}}))}))};r.prototype.verify=function(){return me(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,V.verify(this.signingKey,this.exchangeKey.serialize(),this.signature)];case 1:return[2,e.sent()]}}))}))};r.prototype.fill=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:this.signingKey=e.signingKey.publicKey;this.exchangeKey=e.exchangeKey.publicKey;this.createdAt=e.createdAt;return[4,this.sign(e.signingKey.privateKey)];case 1:t.sent();return[2]}}))}))};return r}(W);l([p({id:1,converter:Y})],t.prototype,"signingKey",void 0);l([p({id:2,converter:Z})],t.prototype,"exchangeKey",void 0);l([p({id:3})],t.prototype,"signature",void 0);l([p({id:4,converter:$})],t.prototype,"createdAt",void 0);t=e=l([h({name:"Identity"})],t);return t}();var ee=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(W);l([p({id:1,converter:Z,required:true})],e.prototype,"senderRatchetKey",void 0);l([p({id:2,type:"uint32",required:true})],e.prototype,"counter",void 0);l([p({id:3,type:"uint32",required:true})],e.prototype,"previousCounter",void 0);l([p({id:4,converter:f,required:true})],e.prototype,"cipherText",void 0);e=l([h({name:"Message"})],e);return e}();var te=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.sign=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t=this;return[4,this.signHMAC(e)];case 1:t.signature=r.sent();return[2]}}))}))};t.prototype.verify=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return[4,this.signHMAC(e)];case 1:t=r.sent();return[2,c(t,this.signature)]}}))}))};t.prototype.getSignedRaw=function(){return me(this,void 0,void 0,(function(){var e,t,r,n;return __generator(this,(function(i){switch(i.label){case 0:e=this.receiverKey.serialize();t=this.senderKey.serialize();return[4,this.message.exportProto()];case 1:r=i.sent();n=u(e,t,r);return[2,n]}}))}))};t.prototype.signHMAC=function(e){return me(this,void 0,void 0,(function(){var t,r;return __generator(this,(function(n){switch(n.label){case 0:return[4,this.getSignedRaw()];case 1:t=n.sent();return[4,F.sign(e,t)];case 2:r=n.sent();return[2,r]}}))}))};return t}(W);l([p({id:1,converter:Y,required:true})],e.prototype,"senderKey",void 0);l([p({id:2,parser:ee,required:true})],e.prototype,"message",void 0);l([p({id:3,required:true})],e.prototype,"signature",void 0);e=l([h({name:"MessageSigned"})],e);return e}();var re=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(W);l([p({id:1,type:"uint32",required:true})],e.prototype,"registrationId",void 0);l([p({id:2,type:"uint32"})],e.prototype,"preKeyId",void 0);l([p({id:3,type:"uint32",required:true})],e.prototype,"preKeySignedId",void 0);l([p({id:4,converter:Z,required:true})],e.prototype,"baseKey",void 0);l([p({id:5,parser:Q,required:true})],e.prototype,"identity",void 0);l([p({id:6,parser:te,required:true})],e.prototype,"signedMessage",void 0);e=l([h({name:"PreKeyMessage"})],e);return e}();var ne=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(W);l([p({id:1,type:"uint32",required:true})],e.prototype,"id",void 0);l([p({id:2,converter:Z,required:true})],e.prototype,"key",void 0);e=l([h({name:"PreKey"})],e);return e}();var ie=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.sign=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t=this;return[4,V.sign(e,this.key.serialize())];case 1:t.signature=r.sent();return[2]}}))}))};t.prototype.verify=function(e){return V.verify(e,this.key.serialize(),this.signature)};return t}(ne);l([p({id:3,converter:f,required:true})],e.prototype,"signature",void 0);e=l([h({name:"PreKeySigned"})],e);return e}();var oe=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(W);l([p({id:1,type:"uint32",required:true})],e.prototype,"registrationId",void 0);l([p({id:2,parser:Q,required:true})],e.prototype,"identity",void 0);l([p({id:3,parser:ne})],e.prototype,"preKey",void 0);l([p({id:4,parser:ie,required:true})],e.prototype,"preKeySigned",void 0);e=l([h({name:"PreKeyBundle"})],e);return e}();var ae=function(){function e(e){if(e===void 0){e=20}this.items=[];this.maxSize=e}Object.defineProperty(e.prototype,"length",{get:function(){return this.items.length},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"latest",{get:function(){return this.items[this.length-1]},enumerable:true,configurable:true});e.prototype.push=function(e){if(this.length===this.maxSize){this.items=this.items.slice(1)}this.items.push(e)};e.prototype.toJSON=function(){return me(this,void 0,void 0,(function(){var e,t,r,n,i,o;return __generator(this,(function(a){switch(a.label){case 0:e=[];t=0,r=this.items;a.label=1;case 1:if(!(t<r.length))return[3,4];n=r[t];o=(i=e).push;return[4,n.toJSON()];case 2:o.apply(i,[a.sent()]);a.label=3;case 3:t++;return[3,1];case 4:return[2,e]}}))}))};e.prototype.fromJSON=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){this.items=e;return[2]}))}))};return e}();var se=new Uint8Array([1]).buffer;var ue=new Uint8Array([2]).buffer;var ce=function(){function e(e){this.counter=0;this.rootKey=e}e.fromJSON=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){t=new this(e.rootKey);t.fromJSON(e);return[2,t]}))}))};e.prototype.toJSON=function(){return me(this,void 0,void 0,(function(){return __generator(this,(function(e){return[2,{counter:this.counter,rootKey:this.rootKey}]}))}))};e.prototype.fromJSON=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){this.counter=e.counter;this.rootKey=e.rootKey;return[2]}))}))};e.prototype.calculateKey=function(e){return me(this,void 0,void 0,(function(){var t,r,n,i;return __generator(this,(function(o){switch(o.label){case 0:return[4,F.sign(e,se)];case 1:t=o.sent();return[4,F.sign(e,ue)];case 2:r=o.sent();i={cipher:t};return[4,F.importHMAC(r)];case 3:n=(i.rootKey=o.sent(),i);return[2,n]}}))}))};e.prototype.click=function(){return me(this,void 0,void 0,(function(){var e,t;return __generator(this,(function(r){switch(r.label){case 0:e=this.rootKey;return[4,this.calculateKey(e)];case 1:t=r.sent();this.rootKey=t.rootKey;this.counter++;return[2,t.cipher]}}))}))};return e}();var le=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.encrypt=function(e){return me(this,void 0,void 0,(function(){var t,r,n,i,o,a;return __generator(this,(function(s){switch(s.label){case 0:return[4,this.click()];case 1:t=s.sent();return[4,F.HKDF(t,3,void 0,R)];case 2:r=s.sent();return[4,F.importAES(r[0])];case 3:n=s.sent();return[4,F.importHMAC(r[1])];case 4:i=s.sent();o=r[2].slice(0,16);return[4,F.encrypt(n,e,o)];case 5:a=s.sent();return[2,{cipherText:a,hmacKey:i}]}}))}))};return t}(ce);var fe=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.keys=[];return t}t.prototype.toJSON=function(){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return[4,e.prototype.toJSON.call(this)];case 1:t=r.sent();t.keys=this.keys;return[2,t]}}))}))};t.prototype.fromJSON=function(t){return me(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,e.prototype.fromJSON.call(this,t)];case 1:r.sent();this.keys=t.keys;return[2]}}))}))};t.prototype.decrypt=function(e,t){return me(this,void 0,void 0,(function(){var r,n,i,o,a,s;return __generator(this,(function(u){switch(u.label){case 0:return[4,this.getKey(t)];case 1:r=u.sent();return[4,F.HKDF(r,3,void 0,R)];case 2:n=u.sent();return[4,F.importAES(n[0])];case 3:i=u.sent();return[4,F.importHMAC(n[1])];case 4:o=u.sent();a=n[2].slice(0,16);return[4,F.decrypt(i,e,a)];case 5:s=u.sent();return[2,{cipherText:s,hmacKey:o}]}}))}))};t.prototype.getKey=function(e){return me(this,void 0,void 0,(function(){var t,r;return __generator(this,(function(n){switch(n.label){case 0:if(!(this.counter<=e))return[3,2];return[4,this.click()];case 1:t=n.sent();this.keys.push(t);return[3,0];case 2:r=this.keys[e];return[2,r]}}))}))};return t}(ce);function he(e,t,r,n,i){return me(this,void 0,void 0,(function(){var o,a,s,c,l,f,h,v,p;return __generator(this,(function(d){switch(d.label){case 0:return[4,V.deriveBytes(e.exchangeKey.privateKey,n)];case 1:o=d.sent();return[4,V.deriveBytes(t.privateKey,r)];case 2:a=d.sent();return[4,V.deriveBytes(t.privateKey,n)];case 3:s=d.sent();c=new ArrayBuffer(0);if(!i)return[3,5];return[4,V.deriveBytes(t.privateKey,i)];case 4:c=d.sent();d.label=5;case 5:l=new Uint8Array(32);for(f=0;f<l.length;f++){l[f]=255}h=l.buffer;v=u(h,o,a,s,c);return[4,F.HKDF(v,1,void 0,H)];case 6:p=d.sent();return[4,F.importHMAC(p[0])];case 7:return[2,d.sent()]}}))}))}function ve(e,t,r,n,i){return me(this,void 0,void 0,(function(){var o,a,s,c,l,f,h,v,p;return __generator(this,(function(d){switch(d.label){case 0:return[4,V.deriveBytes(t.privateKey,r)];case 1:o=d.sent();return[4,V.deriveBytes(e.exchangeKey.privateKey,n)];case 2:a=d.sent();return[4,V.deriveBytes(t.privateKey,n)];case 3:s=d.sent();c=new ArrayBuffer(0);if(!i)return[3,5];return[4,V.deriveBytes(i,n)];case 4:c=d.sent();d.label=5;case 5:l=new Uint8Array(32);for(f=0;f<l.length;f++){l[f]=255}h=l.buffer;v=u(h,o,a,s,c);return[4,F.HKDF(v,1,void 0,H)];case 6:p=d.sent();return[4,F.importHMAC(p[0])];case 7:return[2,d.sent()]}}))}))}var pe=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this)||this;r.options=t;r.counter=0;r.currentStep=new de;r.steps=new ye(L);r.promises={};return r}t.create=function(e,r,n){if(n===void 0){n={}}return me(this,void 0,void 0,(function(){var i,o,a,s,u;return __generator(this,(function(c){switch(c.label){case 0:o=new t(n);if(!(r instanceof oe))return[3,5];return[4,r.identity.verify()];case 1:if(!c.sent()){throw new Error("Error: Remote client's identity key is invalid.")}return[4,r.preKeySigned.verify(r.identity.signingKey)];case 2:if(!c.sent()){throw new Error("Error: Remote client's signed prekey is invalid.")}a=o;return[4,o.generateRatchetKey()];case 3:a.currentRatchetKey=c.sent();o.currentStep.remoteRatchetKey=r.preKeySigned.key;o.remoteIdentity=z.fill(r.identity);o.remoteIdentity.id=r.registrationId;o.remotePreKeyId=r.preKey.id;o.remotePreKeySignedId=r.preKeySigned.id;return[4,he(e,o.currentRatchetKey,r.identity.exchangeKey,r.preKeySigned.key,r.preKey.key)];case 4:i=c.sent();return[3,8];case 5:return[4,r.identity.verify()];case 6:if(!c.sent()){throw new Error("Error: Remote client's identity key is invalid.")}s=e.signedPreKeys[r.preKeySignedId];if(!s){throw new Error("Error: PreKey with id "+r.preKeySignedId+" not found")}u=void 0;if(r.preKeyId!==void 0){u=e.preKeys[r.preKeyId]}o.remoteIdentity=z.fill(r.identity);o.currentRatchetKey=s;return[4,ve(e,o.currentRatchetKey,r.identity.exchangeKey,r.signedMessage.message.senderRatchetKey,u&&u.privateKey)];case 7:i=c.sent();c.label=8;case 8:o.identity=e;o.id=e.id;o.rootKey=i;return[2,o]}}))}))};t.fromJSON=function(e,r,n){return me(this,void 0,void 0,(function(){var i;return __generator(this,(function(o){switch(o.label){case 0:i=new t;i.identity=e;i.remoteIdentity=r;return[4,i.fromJSON(n)];case 1:o.sent();return[2,i]}}))}))};t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)};t.prototype.once=function(t,r){return e.prototype.once.call(this,t,r)};t.prototype.decrypt=function(e){return me(this,void 0,void 0,(function(){var t=this;return __generator(this,(function(r){return[2,this.queuePromise("encrypt",(function(){return me(t,void 0,void 0,(function(){var t,r,n,i,o,a;return __generator(this,(function(s){switch(s.label){case 0:t=e.message.senderRatchetKey;r=e.message;if(e.message.previousCounter<this.counter-L){throw new Error("Error: Too old message")}n=this.steps.getStep(t);if(!n){i=new de;i.remoteRatchetKey=t;this.steps.push(i);this.currentStep=i;n=i}if(!!n.receivingChain)return[3,2];o=n;return[4,this.createChain(this.currentRatchetKey.privateKey,t,fe)];case 1:o.receivingChain=s.sent();s.label=2;case 2:return[4,n.receivingChain.decrypt(r.cipherText,r.counter)];case 3:a=s.sent();this.update();e.senderKey=this.remoteIdentity.signingKey;e.receiverKey=this.identity.signingKey.publicKey;return[4,e.verify(a.hmacKey)];case 4:if(!s.sent()){throw new Error("Error: The Message did not successfully verify!")}return[2,a.cipherText]}}))}))}))]}))}))};t.prototype.encrypt=function(e){return me(this,void 0,void 0,(function(){var t=this;return __generator(this,(function(r){return[2,this.queuePromise("encrypt",(function(){return me(t,void 0,void 0,(function(){var t,r,n,i,o;return __generator(this,(function(a){switch(a.label){case 0:if(!(this.currentStep.receivingChain&&!this.currentStep.sendingChain))return[3,2];this.counter++;t=this;return[4,this.generateRatchetKey()];case 1:t.currentRatchetKey=a.sent();a.label=2;case 2:if(!!this.currentStep.sendingChain)return[3,4];if(!this.currentStep.remoteRatchetKey){throw new Error("currentStep has empty remoteRatchetKey")}r=this.currentStep;return[4,this.createChain(this.currentRatchetKey.privateKey,this.currentStep.remoteRatchetKey,le)];case 3:r.sendingChain=a.sent();a.label=4;case 4:return[4,this.currentStep.sendingChain.encrypt(e)];case 5:n=a.sent();this.update();if(!(this.steps.length===0&&!this.currentStep.receivingChain&&this.currentStep.sendingChain.counter===1))return[3,7];i=new re;i.registrationId=this.identity.id;i.preKeyId=this.remotePreKeyId;i.preKeySignedId=this.remotePreKeySignedId;i.baseKey=this.currentRatchetKey.publicKey;return[4,i.identity.fill(this.identity)];case 6:a.sent();a.label=7;case 7:o=new te;o.receiverKey=this.remoteIdentity.signingKey;o.senderKey=this.identity.signingKey.publicKey;o.message.cipherText=n.cipherText;o.message.counter=this.currentStep.sendingChain.counter-1;o.message.previousCounter=this.counter;o.message.senderRatchetKey=this.currentRatchetKey.publicKey;return[4,o.sign(n.hmacKey)];case 8:a.sent();if(i){i.signedMessage=o;return[2,i]}else{return[2,o]}return[2]}}))}))}))]}))}))};t.prototype.hasRatchetKey=function(e){return me(this,void 0,void 0,(function(){var t,r,n,i;return __generator(this,(function(o){switch(o.label){case 0:if(!!(e instanceof M))return[3,2];return[4,M.create(e)];case 1:t=o.sent();return[3,3];case 2:t=e;o.label=3;case 3:r=0,n=this.steps.items;o.label=4;case 4:if(!(r<n.length))return[3,7];i=n[r];return[4,i.remoteRatchetKey.isEqual(t)];case 5:if(o.sent()){return[2,true]}o.label=6;case 6:r++;return[3,4];case 7:return[2,false]}}))}))};t.prototype.toJSON=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:e={counter:this.counter};return[4,V.ecKeyPairToJson(this.currentRatchetKey)];case 1:e.ratchetKey=t.sent();return[4,this.remoteIdentity.signingKey.thumbprint()];case 2:e.remoteIdentity=t.sent(),e.rootKey=this.rootKey;return[4,this.steps.toJSON()];case 3:return[2,(e.steps=t.sent(),e)]}}))}))};t.prototype.fromJSON=function(e){return me(this,void 0,void 0,(function(){var t,r,n,i,o;return __generator(this,(function(a){switch(a.label){case 0:t=this;return[4,V.ecKeyPairFromJson(e.ratchetKey)];case 1:t.currentRatchetKey=a.sent();this.counter=e.counter;this.rootKey=e.rootKey;r=0,n=e.steps;a.label=2;case 2:if(!(r<n.length))return[3,5];i=n[r];o=this;return[4,de.fromJSON(i)];case 3:o.currentStep=a.sent();this.steps.push(this.currentStep);a.label=4;case 4:r++;return[3,2];case 5:return[2]}}))}))};t.prototype.update=function(){this.emit("update")};t.prototype.generateRatchetKey=function(){return V.generateKeyPair("ECDH",!!this.options.exportableKeys)};t.prototype.createChain=function(e,t,r){return me(this,void 0,void 0,(function(){var n,i,o,a,s;return __generator(this,(function(u){switch(u.label){case 0:return[4,V.deriveBytes(e,t)];case 1:n=u.sent();return[4,F.HKDF(n,2,this.rootKey,X)];case 2:i=u.sent();return[4,F.importHMAC(i[0])];case 3:o=u.sent();return[4,F.importHMAC(i[1])];case 4:a=u.sent();s=new r(a);this.rootKey=o;return[2,s]}}))}))};t.prototype.queuePromise=function(e,t){var r=this;var n=this.promises[e]||Promise.resolve();var i=this.promises[e]=n.then(t,t);i.then((function(){if(r.promises[e]===i){delete r.promises[e]}}));return i};return t}(g);var de=function(){function e(){}e.fromJSON=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t=new this;return[4,t.fromJSON(e)];case 1:r.sent();return[2,t]}}))}))};e.prototype.toJSON=function(){return me(this,void 0,void 0,(function(){var e,t,r;return __generator(this,(function(n){switch(n.label){case 0:e={};if(this.remoteRatchetKey){e.remoteRatchetKey=this.remoteRatchetKey.key}if(!this.sendingChain)return[3,2];t=e;return[4,this.sendingChain.toJSON()];case 1:t.sendingChain=n.sent();n.label=2;case 2:if(!this.receivingChain)return[3,4];r=e;return[4,this.receivingChain.toJSON()];case 3:r.receivingChain=n.sent();n.label=4;case 4:return[2,e]}}))}))};e.prototype.fromJSON=function(e){return me(this,void 0,void 0,(function(){var t,r,n;return __generator(this,(function(i){switch(i.label){case 0:if(!e.remoteRatchetKey)return[3,2];t=this;return[4,M.create(e.remoteRatchetKey)];case 1:t.remoteRatchetKey=i.sent();i.label=2;case 2:if(!e.sendingChain)return[3,4];r=this;return[4,le.fromJSON(e.sendingChain)];case 3:r.sendingChain=i.sent();i.label=4;case 4:if(!e.receivingChain)return[3,6];n=this;return[4,fe.fromJSON(e.receivingChain)];case 5:n.receivingChain=i.sent();i.label=6;case 6:return[2]}}))}))};return e}();var ye=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.getStep=function(e){var t;this.items.some((function(r){if(r.remoteRatchetKey.id===e.id){t=r}return!!t}));return t};return t}(ae);
/*! *****************************************************************************
                Copyright (c) Microsoft Corporation.
                Permission to use, copy, modify, and/or distribute this software for any
                purpose with or without fee is hereby granted.
                THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
                REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
                AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
                INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
                LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
                OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
                PERFORMANCE OF THIS SOFTWARE.
                ***************************************************************************** */function ge(e,t,r,n){var i=arguments.length,o=i<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)if(a=e[s])o=(i<3?a(o):i>3?a(t,r,o):a(t,r))||o;return i>3&&o&&Object.defineProperty(t,r,o),o}function me(e,t,r,n){function i(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function a(e){try{u(n.next(e))}catch(t){o(t)}}function s(e){try{u(n["throw"](e))}catch(t){o(t)}}function u(e){e.done?r(e.value):i(e.value).then(a,s)}u((n=n.apply(e,t||[])).next())}))}var be=function(){function e(){}e.set=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Uint8Array(o.FromUtf8String(e.toISOString()))]}))}))};e.get=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Date(o.ToUtf8String(e))]}))}))};return e}();var we=function(){function e(){}e.set=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,new Uint8Array(o.FromHex(e))]}))}))};e.get=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,o.ToHex(e)]}))}))};return e}();var ke=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.version=0;return t}return t}(d);t.INDEX=1;ge([p({id:e.INDEX++,type:"uint32",required:true,defaultValue:1})],t.prototype,"version",void 0);t=e=ge([h({name:"BaseMessage"})],t);return t}();var Be=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.call(this)||this;t.actionId="";t.action=t.constructor.ACTION;return t}return t}(ke);t.INDEX=ke.INDEX;t.ACTION="action";ge([p({id:e.INDEX++,type:"string",required:true})],t.prototype,"action",void 0);ge([p({id:e.INDEX++,type:"string",required:false})],t.prototype,"actionId",void 0);t=e=ge([h({name:"Action"})],t);return t}();var _e=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.name="";return t}t.prototype.isEmpty=function(){return!this.name};t.prototype.toAlgorithm=function(){return{name:this.name}};t.prototype.fromAlgorithm=function(e){this.name=e.name};return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,type:"string",required:true})],t.prototype,"name",void 0);t=e=ge([h({name:"BaseAlgorithm"})],t);return t}();var Ne=function(){var e;var t=e=function(t){__extends(r,t);function r(){return t!==null&&t.apply(this,arguments)||this}r.prototype.toAlgorithm=function(){var e={};var t=this.constructor;for(var r in t.items){if(r==="version"){continue}var n=this[r];if(r==="labelStr"){e.label=n;continue}if(n!==void 0){if(n instanceof _e){if(!n.isEmpty()){e[r]=n.toAlgorithm()}}else{e[r]=n}}}return e};r.prototype.fromAlgorithm=function(t){if(t instanceof e){t=t.toAlgorithm()}var r=this.constructor;for(var n in t){if(!r.items){continue}if(n in r.items){var i=r.items[n];if(i.parser){switch(i.parser){case _e:{this[n].fromAlgorithm(t[n]);break}default:throw new Error("Unsupported parser '"+i.parser.name+"'")}}else{if(n==="label"&&typeof t.label==="string"){this.labelStr=t.label}else{this[n]=t[n]}}}}};return r}(_e);t.INDEX=_e.INDEX;ge([p({id:e.INDEX++,type:"bytes",parser:_e})],t.prototype,"hash",void 0);ge([p({id:e.INDEX++,type:"bytes"})],t.prototype,"publicExponent",void 0);ge([p({id:e.INDEX++,type:"uint32"})],t.prototype,"modulusLength",void 0);ge([p({id:e.INDEX++,type:"uint32"})],t.prototype,"saltLength",void 0);ge([p({id:e.INDEX++,type:"bytes"})],t.prototype,"label",void 0);ge([p({id:e.INDEX++,type:"string"})],t.prototype,"namedCurve",void 0);ge([p({id:e.INDEX++,converter:f})],t.prototype,"public",void 0);ge([p({id:e.INDEX++,type:"uint32"})],t.prototype,"length",void 0);ge([p({id:e.INDEX++})],t.prototype,"iv",void 0);ge([p({id:e.INDEX++,type:"bool"})],t.prototype,"token",void 0);ge([p({id:e.INDEX++,type:"bool"})],t.prototype,"sensitive",void 0);ge([p({id:e.INDEX++,type:"string"})],t.prototype,"labelStr",void 0);t=e=ge([h({name:"Algorithm"})],t);return t}();var Ee=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.providerID="";t.id="";t.type="";return t}return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,type:"string",required:true})],t.prototype,"providerID",void 0);ge([p({id:e.INDEX++,type:"bytes",required:true,converter:we})],t.prototype,"id",void 0);ge([p({id:e.INDEX++,type:"string",required:true})],t.prototype,"type",void 0);t=e=ge([h({name:"CryptoItem"})],t);return t}();var Ae=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.type="secret";t.algorithm=new Ne;t.extractable=false;t.usages=[];return t}return t}(Ee);t.INDEX=Ee.INDEX;ge([p({id:e.INDEX++,type:"bytes",required:true,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,type:"bool"})],t.prototype,"extractable",void 0);ge([p({id:e.INDEX++,type:"string",repeated:true})],t.prototype,"usages",void 0);t=e=ge([h({name:"CryptoKey"})],t);return t}();var Ie=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.privateKey=new Ae;t.publicKey=new Ae;return t}return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,name:"privateKey",type:"bytes",required:true,parser:Ae})],t.prototype,"privateKey",void 0);ge([p({id:e.INDEX++,name:"publicKey",type:"bytes",parser:Ae})],t.prototype,"publicKey",void 0);t=e=ge([h({name:"CryptoKeyPair"})],t);return t}();var Se=function(){var e;var t=e=function(e){__extends(t,e);function t(t,r,n){if(r===void 0){r=0}if(n===void 0){n="error"}var i=e.call(this)||this;i.code=0;i.type="error";i.message="";i.name="Error";i.stack="";if(t){i.message=t;i.code=r;i.type=n}return i}return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,type:"uint32",defaultValue:0})],t.prototype,"code",void 0);ge([p({id:e.INDEX++,type:"string",defaultValue:"error"})],t.prototype,"type",void 0);ge([p({id:e.INDEX++,type:"string",defaultValue:""})],t.prototype,"message",void 0);ge([p({id:e.INDEX++,type:"string",defaultValue:"Error"})],t.prototype,"name",void 0);ge([p({id:e.INDEX++,type:"string",defaultValue:""})],t.prototype,"stack",void 0);t=e=ge([h({name:"Error"})],t);return t}();var xe=function(){var e;var t=e=function(e){__extends(t,e);function t(t){var r=e.call(this)||this;r.status=false;if(t){r.actionId=t.actionId;r.action=t.action}return r}return t}(Be);t.INDEX=Be.INDEX;ge([p({id:e.INDEX++,type:"bool",defaultValue:false})],t.prototype,"status",void 0);ge([p({id:e.INDEX++,type:"bytes",parser:Se})],t.prototype,"error",void 0);ge([p({id:e.INDEX++,type:"bytes",converter:f})],t.prototype,"data",void 0);t=e=ge([h({name:"Result"})],t);return t}();var De=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Be);e.INDEX=Be.INDEX;e.ACTION="auth";e=ge([h({name:"AuthRequest"})],e);return e}();var Ce=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Be);e.INDEX=Be.INDEX;e.ACTION="server/login";e=ge([h({})],e);return e}();var Oe=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Be);e.INDEX=Be.INDEX;e.ACTION="server/isLoggedIn";e=ge([h({})],e);return e}();var Ke=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Be);e.INDEX=Be.INDEX;e.ACTION="cardReader";e=ge([h({})],e);return e}();var Te=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Be);e.INDEX=Be.INDEX;e.ACTION="cardReader/readers";e=ge([h({})],e);return e}();var Ue=function(){var e;var t=e=function(e){__extends(t,e);function t(t,r){var n=e.call(this)||this;n.reader="";n.atr="";if(t&&r){n.reader=t;n.atr=r}return n}return t}(Ke);t.INDEX=Ke.INDEX;ge([p({id:e.INDEX++,required:true,type:"string",defaultValue:""})],t.prototype,"reader",void 0);ge([p({id:e.INDEX++,required:true,converter:we})],t.prototype,"atr",void 0);t=e=ge([h({})],t);return t}();var Le=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Ue);e.INDEX=Ue.INDEX;e.ACTION=Ue.ACTION+"/insert";e=ge([h({})],e);return e}();var He=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Ue);e.INDEX=Ue.INDEX;e.ACTION=Ue.ACTION+"/remove";e=ge([h({})],e);return e}();var Xe=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.providerID="";return t}return t}(Be);t.INDEX=Be.INDEX;t.ACTION="crypto";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"providerID",void 0);t=e=ge([h({})],t);return t}();var Re=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/login";e=ge([h({})],e);return e}();var Pe=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/logout";e=ge([h({})],e);return e}();var qe=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/isLoggedIn";e=ge([h({})],e);return e}();var je=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/reset";e=ge([h({})],e);return e}();var Ve=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.id="";t.publicKey=new Ae;t.type="x509";t.label="";t.token=false;t.sensitive=false;return t}return t}(Ee);t.INDEX=Ee.INDEX;ge([p({id:e.INDEX++,required:true,converter:we})],t.prototype,"id",void 0);ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"publicKey",void 0);ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"type",void 0);ge([p({id:e.INDEX++,type:"string",defaultValue:""})],t.prototype,"label",void 0);ge([p({id:e.INDEX++,type:"bool",defaultValue:false})],t.prototype,"token",void 0);ge([p({id:e.INDEX++,type:"bool",defaultValue:false})],t.prototype,"sensitive",void 0);t=e=ge([h({})],t);return t}();var Je=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.type="x509";t.serialNumber="";t.issuerName="";t.subjectName="";t.notBefore=new Date;t.notAfter=new Date;return t}return t}(Ve);t.INDEX=Ve.INDEX;ge([p({id:e.INDEX++,required:true,converter:we})],t.prototype,"serialNumber",void 0);ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"issuerName",void 0);ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"subjectName",void 0);ge([p({id:e.INDEX++,required:true,converter:be})],t.prototype,"notBefore",void 0);ge([p({id:e.INDEX++,required:true,converter:be})],t.prototype,"notAfter",void 0);t=e=ge([h({})],t);return t}();var Fe=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.type="request";t.subjectName="";return t}return t}(Ve);t.INDEX=Ve.INDEX;ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"subjectName",void 0);t=e=ge([h({})],t);return t}();var Me=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.type="";t.value=new ArrayBuffer(0);return t}return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"type",void 0);ge([p({id:e.INDEX++,required:true,converter:f})],t.prototype,"value",void 0);t=e=ge([h({})],t);return t}();var Ge=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.items=[];return t}return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,required:true,repeated:true,parser:Me})],t.prototype,"items",void 0);t=e=ge([h({})],t);return t}();var ze=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.item=new Ve;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/certificateStorage/setItem";ge([p({id:e.INDEX++,required:true,parser:Ve})],t.prototype,"item",void 0);t=e=ge([h({})],t);return t}();var We=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.key="";t.algorithm=new Ne;t.keyUsages=[];return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/certificateStorage/getItem";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"key",void 0);ge([p({id:e.INDEX++,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,repeated:true,type:"string"})],t.prototype,"keyUsages",void 0);t=e=ge([h({})],t);return t}();var Ye=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/certificateStorage/keys";e=ge([h({})],e);return e}();var Ze=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.key="";return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/certificateStorage/removeItem";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"key",void 0);t=e=ge([h({})],t);return t}();var $e=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/certificateStorage/clear";e=ge([h({})],e);return e}();var Qe=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.format="raw";t.data=new ArrayBuffer(0);t.algorithm=new Ne;t.keyUsages=[];return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/certificateStorage/import";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"format",void 0);ge([p({id:e.INDEX++,required:true,converter:f})],t.prototype,"data",void 0);ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,repeated:true,type:"string"})],t.prototype,"keyUsages",void 0);t=e=ge([h({})],t);return t}();var et=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.format="raw";t.item=new Ve;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/certificateStorage/export";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"format",void 0);ge([p({id:e.INDEX++,required:true,parser:Ve})],t.prototype,"item",void 0);t=e=ge([h({})],t);return t}();var tt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.item=new Ve;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/certificateStorage/indexOf";ge([p({id:e.INDEX++,required:true,parser:Ve})],t.prototype,"item",void 0);t=e=ge([h({})],t);return t}();var rt=function(){var e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.item=new Ve;return t}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/certificateStorage/getChain";ge([p({id:ze.INDEX++,required:true,parser:Ve})],e.prototype,"item",void 0);e=ge([h({})],e);return e}();var nt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.url="";return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/certificateStorage/getCRL";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"url",void 0);t=e=ge([h({})],t);return t}();var it=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.method="get";return t}return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,required:false,type:"string",defaultValue:"get"})],t.prototype,"method",void 0);t=e=ge([h({})],t);return t}();var ot=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.url="";t.request=new ArrayBuffer(0);t.options=new it;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/certificateStorage/getOCSP";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"url",void 0);ge([p({id:e.INDEX++,required:true,converter:f})],t.prototype,"request",void 0);ge([p({id:e.INDEX++,required:false,parser:it})],t.prototype,"options",void 0);t=e=ge([h({})],t);return t}();var at=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.item=new Ae;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/keyStorage/setItem";ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"item",void 0);t=e=ge([h({})],t);return t}();var st=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.key="";t.algorithm=new Ne;t.extractable=false;t.keyUsages=[];return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/keyStorage/getItem";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"key",void 0);ge([p({id:e.INDEX++,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,type:"bool"})],t.prototype,"extractable",void 0);ge([p({id:e.INDEX++,repeated:true,type:"string"})],t.prototype,"keyUsages",void 0);t=e=ge([h({})],t);return t}();var ut=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/keyStorage/keys";e=ge([h({})],e);return e}();var ct=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.key="";return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/keyStorage/removeItem";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"key",void 0);t=e=ge([h({})],t);return t}();var lt=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Xe);e.INDEX=Xe.INDEX;e.ACTION="crypto/keyStorage/clear";e=ge([h({})],e);return e}();var ft=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.item=new Ae;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/keyStorage/indexOf";ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"item",void 0);t=e=ge([h({})],t);return t}();var ht=function(){var e;var t=e=function(e){__extends(t,e);function t(t){var r=e.call(this)||this;r.id="";r.name="";r.readOnly=false;r.algorithms=[];r.isRemovable=false;r.atr="";r.isHardware=false;r.card="";if(t){s(r,t)}return r}return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"id",void 0);ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"name",void 0);ge([p({id:e.INDEX++,type:"bool",defaultValue:false})],t.prototype,"readOnly",void 0);ge([p({id:e.INDEX++,repeated:true,type:"string"})],t.prototype,"algorithms",void 0);ge([p({id:e.INDEX++,type:"bool",defaultValue:false})],t.prototype,"isRemovable",void 0);ge([p({id:e.INDEX++,type:"string"})],t.prototype,"atr",void 0);ge([p({id:e.INDEX++,type:"bool",defaultValue:false})],t.prototype,"isHardware",void 0);ge([p({id:e.INDEX++,type:"string"})],t.prototype,"card",void 0);t=e=ge([h({})],t);return t}();var vt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.name="";t.providers=[];return t}return t}(ke);t.INDEX=ke.INDEX;ge([p({id:e.INDEX++,type:"string",required:true})],t.prototype,"name",void 0);ge([p({id:e.INDEX++,repeated:true,parser:ht})],t.prototype,"providers",void 0);t=e=ge([h({})],t);return t}();var pt=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Be);e.INDEX=Be.INDEX;e.ACTION="provider/action/info";e=ge([h({})],e);return e}();var dt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.cryptoID="";return t}return t}(Be);t.INDEX=Be.INDEX;t.ACTION="provider/action/getCrypto";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"cryptoID",void 0);t=e=ge([h({})],t);return t}();var yt=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Be);e.INDEX=Be.INDEX;e.ACTION="provider/event/authorized";e=ge([h({})],e);return e}();var gt=function(){var e;var t=e=function(e){__extends(t,e);function t(t){var r=e.call(this)||this;r.added=[];r.removed=[];if(t){s(r,t)}return r}return t}(Be);t.INDEX=Be.INDEX;t.ACTION="provider/event/token";ge([p({id:e.INDEX++,repeated:true,parser:ht})],t.prototype,"added",void 0);ge([p({id:e.INDEX++,repeated:true,parser:ht})],t.prototype,"removed",void 0);ge([p({id:e.INDEX++,type:"bytes",parser:Se})],t.prototype,"error",void 0);t=e=ge([h({name:"ProviderTokenEvent"})],t);return t}();var mt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.algorithm=new Ne;t.data=new ArrayBuffer(0);return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/digest";ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,required:true,converter:f})],t.prototype,"data",void 0);t=e=ge([h({})],t);return t}();var bt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.algorithm=new Ne;t.extractable=false;t.usage=[];return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/generateKey";ge([p({id:e.INDEX++,type:"bytes",required:true,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,type:"bool",required:true})],t.prototype,"extractable",void 0);ge([p({id:e.INDEX++,type:"string",repeated:true})],t.prototype,"usage",void 0);t=e=ge([h({})],t);return t}();var wt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.algorithm=new Ne;t.key=new Ae;t.data=new ArrayBuffer(0);return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/sign";ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"key",void 0);ge([p({id:e.INDEX++,required:true,converter:f})],t.prototype,"data",void 0);t=e=ge([h({})],t);return t}();var kt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.signature=new ArrayBuffer(0);return t}return t}(wt);t.INDEX=wt.INDEX;t.ACTION="crypto/subtle/verify";ge([p({id:e.INDEX++,required:true,converter:f})],t.prototype,"signature",void 0);t=e=ge([h({})],t);return t}();var Bt=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(wt);e.INDEX=wt.INDEX;e.ACTION="crypto/subtle/encrypt";e=ge([h({})],e);return e}();var _t=function(){var e=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(wt);e.INDEX=wt.INDEX;e.ACTION="crypto/subtle/decrypt";e=ge([h({})],e);return e}();var Nt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.algorithm=new Ne;t.key=new Ae;t.length=0;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/deriveBits";ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"key",void 0);ge([p({id:e.INDEX++,required:true,type:"uint32"})],t.prototype,"length",void 0);t=e=ge([h({})],t);return t}();var Et=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.algorithm=new Ne;t.key=new Ae;t.derivedKeyType=new Ne;t.extractable=false;t.usage=[];return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/deriveKey";ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"key",void 0);ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"derivedKeyType",void 0);ge([p({id:e.INDEX++,type:"bool"})],t.prototype,"extractable",void 0);ge([p({id:e.INDEX++,type:"string",repeated:true})],t.prototype,"usage",void 0);t=e=ge([h({})],t);return t}();var At=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.format="";t.wrappedKey=new ArrayBuffer(0);t.unwrappingKey=new Ae;t.unwrapAlgorithm=new Ne;t.unwrappedKeyAlgorithm=new Ne;t.extractable=false;t.keyUsage=[];return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/unwrapKey";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"format",void 0);ge([p({id:e.INDEX++,required:true,converter:f})],t.prototype,"wrappedKey",void 0);ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"unwrappingKey",void 0);ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"unwrapAlgorithm",void 0);ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"unwrappedKeyAlgorithm",void 0);ge([p({id:e.INDEX++,type:"bool"})],t.prototype,"extractable",void 0);ge([p({id:e.INDEX++,type:"string",repeated:true})],t.prototype,"keyUsage",void 0);t=e=ge([h({})],t);return t}();var It=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.format="";t.key=new Ae;t.wrappingKey=new Ae;t.wrapAlgorithm=new Ne;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/wrapKey";ge([p({id:e.INDEX++,required:true,type:"string"})],t.prototype,"format",void 0);ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"key",void 0);ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"wrappingKey",void 0);ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"wrapAlgorithm",void 0);t=e=ge([h({})],t);return t}();var St=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.format="";t.key=new Ae;return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/exportKey";ge([p({id:e.INDEX++,type:"string",required:true})],t.prototype,"format",void 0);ge([p({id:e.INDEX++,required:true,parser:Ae})],t.prototype,"key",void 0);t=e=ge([h({})],t);return t}();var xt=function(){var e;var t=e=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.format="";t.keyData=new ArrayBuffer(0);t.algorithm=new Ne;t.extractable=false;t.keyUsages=[];return t}return t}(Xe);t.INDEX=Xe.INDEX;t.ACTION="crypto/subtle/importKey";ge([p({id:e.INDEX++,type:"string",required:true})],t.prototype,"format",void 0);ge([p({id:e.INDEX++,required:true,converter:f})],t.prototype,"keyData",void 0);ge([p({id:e.INDEX++,required:true,parser:Ne})],t.prototype,"algorithm",void 0);ge([p({id:e.INDEX++,required:true,type:"bool"})],t.prototype,"extractable",void 0);ge([p({id:e.INDEX++,type:"string",repeated:true})],t.prototype,"keyUsages",void 0);t=e=ge([h({})],t);return t}();var Dt=function(e){__extends(t,e);function t(t){var r=e.call(this)||this;r.client=t;r.onEvent=r.onEvent.bind(r);r.client.on("listening",(function(){r.client.on("event",r.onEvent)})).on("close",(function(){r.client.removeListener("event",r.onEvent)}));return r}t.prototype.readers=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:return[4,this.client.send(new Te)];case 1:e=t.sent();return[2,JSON.parse(o.ToString(e))]}}))}))};t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)};t.prototype.emit=function(t){var r=[];for(var n=1;n<arguments.length;n++){r[n-1]=arguments[n]}return e.prototype.emit.apply(this,__spreadArrays([t],r))};t.prototype.onEvent=function(e){var t=this;(function(){return me(t,void 0,void 0,(function(){var t,r,n;return __generator(this,(function(i){switch(i.label){case 0:t=e.action;switch(t){case Le.ACTION:return[3,1];case He.ACTION:return[3,3]}return[3,5];case 1:r=this.onInsert;return[4,Le.importProto(e)];case 2:r.apply(this,[i.sent()]);return[3,5];case 3:n=this.onRemove;return[4,He.importProto(e)];case 4:n.apply(this,[i.sent()]);return[3,5];case 5:return[2]}}))}))})().catch((function(e){return t.emit("error",e)}))};t.prototype.onInsert=function(e){this.emit("insert",e)};t.prototype.onRemove=function(e){this.emit("remove",e)};return t}(g);function Ct(e,t){return me(this,void 0,void 0,(function(){var r,n,i,a;return __generator(this,(function(s){switch(s.label){case 0:return[4,e.thumbprint()];case 1:r=s.sent();return[4,t.thumbprint()];case 2:n=s.sent();i=o.FromHex(r+n);return[4,j().crypto.subtle.digest("SHA-256",i)];case 3:a=s.sent();return[2,parseInt(o.ToHex(a),16).toString().substr(2,6)]}}))}))}var Ot="/.well-known/webcrypto-socket";var Kt=function(){function e(e,t){this.target=e;this.event=t}return e}();var Tt=function(e){__extends(t,e);function t(t){var r=e.call(this,t.message)||this;r.name="CryptoServerError";r.code=t.code;r.type=t.type;return r}return t}(Error);var Ut=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Kt);var Lt=function(e){__extends(t,e);function t(t,r,n,i){var o=e.call(this,t,"close")||this;o.remoteAddress=r;o.reasonCode=n;o.description=i;return o}return t}(Ut);var Ht=function(e){__extends(t,e);function t(t,r){var n=e.call(this,t,"error")||this;n.error=r;return n}return t}(Ut);var Xt=function(e){__extends(t,e);function t(t,r){var n=e.call(this,t,"listening")||this;n.address=r;return n}return t}(Ut);function Rt(){return/firefox/i.test(self.navigator.userAgent)}function Pt(){return/edge\/([\d\.]+)/i.test(self.navigator.userAgent)}function qt(){return!!window.document.documentMode}var jt={name:"ECDH",namedCurve:"P-256"};var Vt={name:"ECDSA",namedCurve:"P-256"};var Jt={name:"AES-CBC",iv:new ArrayBuffer(16)};function Ft(e){return me(this,void 0,void 0,(function(){var t,r,n,i,a,s,u,c,l,f;return __generator(this,(function(h){switch(h.label){case 0:t=e.algorithm.name.toUpperCase();if(!(t==="ECDH"||t==="ECDSA")){throw new Error("Error: Unsupported asymmetric key algorithm.")}if(e.type!=="public"){throw new Error("Error: Expected key type to be public but it was not.")}return[4,j().crypto.subtle.exportKey("jwk",e)];case 1:r=h.sent();if(!(r.x&&r.y)){throw new Error("Wrong JWK data for EC public key. Parameters x and y are required.")}n=o.FromBase64Url(r.x);i=o.FromBase64Url(r.y);a=o.ToBinary(n)+o.ToBinary(i);s=e;u=o.FromBinary(a);f=(l=o).ToHex;return[4,j().crypto.subtle.digest("SHA-256",u)];case 2:c=f.apply(l,[h.sent()]);return[2,{id:c,key:s,serialized:u}]}}))}))}function Mt(e,t){return me(this,void 0,void 0,(function(){var r;return __generator(this,(function(n){switch(n.label){case 0:return[4,Ft(t)];case 1:r=n.sent();e.id=r.id;e.key=r.key;e.serialized=r.serialized;return[2]}}))}))}var Gt;(function(e){e[e["connecting"]=0]="connecting";e[e["open"]=1]="open";e[e["closing"]=2]="closing";e[e["closed"]=3]="closed"})(Gt||(Gt={}));var zt=function(e){__extends(t,e);function t(t){var r=e.call(this)||this;r.stack={};r.messageCounter=0;r.storage=t;return r}Object.defineProperty(t.prototype,"state",{get:function(){if(this.socket){return this.socket.readyState}else{return Gt.closed}},enumerable:true,configurable:true});t.prototype.connect=function(e,t){var r=this;this.getServerInfo(e).then((function(i){r.serviceInfo=i;var a="wss://"+e;r.socket=t?new n(a,undefined,t):new n(a);r.socket.binaryType="arraybuffer";r.socket.onerror=function(e){r.emit("error",new Ht(r,e.error))};r.socket.onopen=function(){(function(){return me(r,void 0,void 0,(function(){var t,r,n,a;return __generator(this,(function(s){switch(s.label){case 0:return[4,this.storage.loadIdentity()];case 1:t=s.sent();if(!!t)return[3,4];return[4,G.create(1,0,0,qt()||Pt()||Rt())];case 2:t=s.sent();return[4,this.storage.saveIdentity(t)];case 3:s.sent();s.label=4;case 4:r="0";return[4,oe.importProto(o.FromBase64(i.preKey))];case 5:n=s.sent();a=this;return[4,pe.create(t,n)];case 6:a.cipher=s.sent();return[4,this.storage.saveRemoteIdentity(r,this.cipher.remoteIdentity)];case 7:s.sent();this.emit("listening",new Xt(this,e));return[2]}}))}))})().catch((function(e){return r.emit("error",new Ht(r,e))}))};r.socket.onclose=function(t){for(var n in r.stack){var i=r.stack[n];i.reject(new Error("Cannot finish operation. Session was closed"))}r.emit("close",new Lt(r,e,t.code,t.reason))};r.socket.onmessage=function(e){if(e.data instanceof ArrayBuffer){te.importProto(e.data).then((function(e){if(!r.cipher){throw new Error("Client cipher is not initialized")}return r.cipher.decrypt(e)})).then((function(e){r.onMessage(e)})).catch((function(e){r.emit("error",new Ht(r,e))}))}}})).catch((function(e){r.emit("error",new Ht(r,e))}));return this};t.prototype.close=function(){if(this.socket){this.socket.close()}};t.prototype.on=function(t,r){return e.prototype.on.call(this,t,r)};t.prototype.once=function(t,r){return e.prototype.once.call(this,t,r)};t.prototype.challenge=function(){return me(this,void 0,void 0,(function(){return __generator(this,(function(e){if(!this.cipher){throw new Error("Client cipher is not initialized")}return[2,Ct(this.cipher.remoteIdentity.signingKey,this.cipher.identity.signingKey.publicKey)]}))}))};t.prototype.isLoggedIn=function(){return me(this,void 0,void 0,(function(){var e,t;return __generator(this,(function(r){switch(r.label){case 0:e=new Oe;return[4,this.send(e)];case 1:t=r.sent();return[2,t?!!new Uint8Array(t)[0]:false]}}))}))};t.prototype.login=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:e=new Ce;return[4,this.send(e)];case 1:t.sent();return[2]}}))}))};t.prototype.send=function(e){var t=this;return new Promise((function(r,n){t.checkSocketState();if(!e){e=new Be}e.action=e.action;e.actionId=(t.messageCounter++).toString();e.exportProto().then((function(e){if(!t.cipher){throw new Error("Client cipher is not initialized")}return t.cipher.encrypt(e).then((function(e){return e.exportProto()}))})).then((function(i){if(!t.socket){throw new Error("Client socket is not initialized")}t.stack[e.actionId]={resolve:r,reject:n};t.socket.send(i)})).catch(n)}))};t.prototype.getServerInfo=function(e){return me(this,void 0,void 0,(function(){var t,n,i;return __generator(this,(function(o){switch(o.label){case 0:t="https://"+e+Ot;return[4,r(t)];case 1:n=o.sent();if(!(n.status!==200))return[3,2];throw new Error("Cannot get wellknown link");case 2:return[4,n.json()];case 3:i=o.sent();return[2,i]}}))}))};t.prototype.checkSocketState=function(){if(this.state!==Gt.open){throw new Error("Socket connection is not open")}};t.prototype.onMessage=function(e){return me(this,void 0,void 0,(function(){var t,r,n,i,o,a,s;return __generator(this,(function(u){switch(u.label){case 0:return[4,Be.importProto(e)];case 1:t=u.sent();r=this.stack[t.actionId];if(!r)return[3,4];delete this.stack[t.actionId];o=(i=xe).importProto;return[4,t.exportProto()];case 2:return[4,o.apply(i,[u.sent()])];case 3:n=u.sent();if(n.error&&n.error.message){a=n.error;s=new Tt(a);r.reject(s)}else{r.resolve(n.data)}return[3,5];case 4:this.emit("event",t);u.label=5;case 5:return[2]}}))}))};return t}(g);
/*! *****************************************************************************
                Copyright (c) Microsoft Corporation.
                Permission to use, copy, modify, and/or distribute this software for any
                purpose with or without fee is hereby granted.
                THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
                REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
                AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
                INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
                LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
                OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
                PERFORMANCE OF THIS SOFTWARE.
                ***************************************************************************** */function Wt(e,t,r,n){var i=arguments.length,o=i<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)if(a=e[s])o=(i<3?a(o):i>3?a(t,r,o):a(t,r))||o;return i>3&&o&&Object.defineProperty(t,r,o),o}function Yt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e["default"]:e}function Zt(e,t){return t={exports:{}},e(t,t.exports),t.exports}function $t(e){return new Date(e.getTime()+e.getTimezoneOffset()*6e4)}function Qt(e,t,r){if(e instanceof Object===false)return r;if(t in e)return e[t];return r}function er(e,t,r,n){if(t===void 0){t=0}if(r===void 0){r=e.byteLength-t}if(n===void 0){n=false}var i="";for(var o=0,a=new Uint8Array(e,t,r);o<a.length;o++){var s=a[o];var u=s.toString(16).toUpperCase();if(u.length===1)i+="0";i+=u;if(n)i+=" "}return i.trim()}function tr(e,t,r,n){if(t instanceof ArrayBuffer===false){e.error='Wrong parameter: inputBuffer must be "ArrayBuffer"';return false}if(t.byteLength===0){e.error="Wrong parameter: inputBuffer has zero length";return false}if(r<0){e.error="Wrong parameter: inputOffset less than zero";return false}if(n<0){e.error="Wrong parameter: inputLength less than zero";return false}if(t.byteLength-r-n<0){e.error="End of input reached before message was fully decoded (inconsistent offset and length values)";return false}return true}function rr(e,t){var r=0;if(e.length===1)return e[0];for(var n=e.length-1;n>=0;n--)r+=e[e.length-1-n]*Math.pow(2,t*n);return r}function nr(e,t,r){if(r===void 0){r=-1}var n=r;var i=e;var o=0;var a=Math.pow(2,t);for(var s=1;s<8;s++){if(e<a){var u=void 0;if(n<0){u=new ArrayBuffer(s);o=s}else{if(n<s)return new ArrayBuffer(0);u=new ArrayBuffer(n);o=n}var c=new Uint8Array(u);for(var l=s-1;l>=0;l--){var f=Math.pow(2,l*t);c[o-l-1]=Math.floor(i/f);i-=c[o-l-1]*f}return u}a*=Math.pow(2,t)}return new ArrayBuffer(0)}function ir(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}var r=0;var n=0;for(var i=0,o=e;i<o.length;i++){var a=o[i];r+=a.byteLength}var s=new ArrayBuffer(r);var u=new Uint8Array(s);for(var c=0,l=e;c<l.length;c++){var a=l[c];u.set(new Uint8Array(a),n);n+=a.byteLength}return s}function or(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}var r=0;var n=0;for(var i=0,o=e;i<o.length;i++){var a=o[i];r+=a.length}var s=new ArrayBuffer(r);var u=new Uint8Array(s);for(var c=0,l=e;c<l.length;c++){var a=l[c];u.set(a,n);n+=a.length}return u}function ar(){var e=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){var t=e[0]===255&&e[1]&128;var r=e[0]===0&&(e[1]&128)===0;if(t||r)this.warnings.push("Needlessly long format")}var n=new ArrayBuffer(this.valueHex.byteLength);var i=new Uint8Array(n);for(var o=0;o<this.valueHex.byteLength;o++)i[o]=0;i[0]=e[0]&128;var a=rr(i,8);var s=new ArrayBuffer(this.valueHex.byteLength);var u=new Uint8Array(s);for(var c=0;c<this.valueHex.byteLength;c++)u[c]=e[c];u[0]&=127;var l=rr(u,8);return l-a}function sr(e){var t=e<0?e*-1:e;var r=128;for(var n=1;n<8;n++){if(t<=r){if(e<0){var i=r-t;var o=nr(i,8,n);var a=new Uint8Array(o);a[0]|=128;return o}var s=nr(t,8,n);var u=new Uint8Array(s);if(u[0]&128){var c=s.slice(0);var l=new Uint8Array(c);s=new ArrayBuffer(s.byteLength+1);u=new Uint8Array(s);for(var f=0;f<c.byteLength;f++)u[f+1]=l[f];u[0]=0}return s}r*=Math.pow(2,8)}return new ArrayBuffer(0)}function ur(e,t){if(e.byteLength!==t.byteLength)return false;var r=new Uint8Array(e);var n=new Uint8Array(t);for(var i=0;i<r.length;i++){if(r[i]!==n[i])return false}return true}function cr(e,t){var r=e.toString(10);if(t<r.length)return"";var n=t-r.length;var i=new Array(n);for(var o=0;o<n;o++)i[o]="0";var a=i.join("");return a.concat(r)}var lr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var fr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=";function hr(e,t,r,n){if(t===void 0){t=false}if(r===void 0){r=false}if(n===void 0){n=false}var i=0;var o=0;var a=0;var s="";var u=t?fr:lr;if(n){var c=0;for(var l=0;l<e.length;l++){if(e.charCodeAt(l)!==0){c=l;break}}e=e.slice(c)}while(i<e.length){var f=e.charCodeAt(i++);if(i>=e.length)o=1;var h=e.charCodeAt(i++);if(i>=e.length)a=1;var v=e.charCodeAt(i++);var p=f>>2;var d=(f&3)<<4|h>>4;var y=(h&15)<<2|v>>6;var g=v&63;if(o===1){y=g=64}else{if(a===1){g=64}}if(r){if(y===64)s+=""+u.charAt(p)+u.charAt(d);else{if(g===64)s+=""+u.charAt(p)+u.charAt(d)+u.charAt(y);else s+=""+u.charAt(p)+u.charAt(d)+u.charAt(y)+u.charAt(g)}}else s+=""+u.charAt(p)+u.charAt(d)+u.charAt(y)+u.charAt(g)}return s}function vr(e,t,r){if(t===void 0){t=false}if(r===void 0){r=false}var n=t?fr:lr;function i(e){for(var t=0;t<64;t++){if(n.charAt(t)===e)return t}return 64}function o(e){return e===64?0:e}var a=0;var s="";while(a<e.length){var u=i(e.charAt(a++));var c=a>=e.length?0:i(e.charAt(a++));var l=a>=e.length?0:i(e.charAt(a++));var f=a>=e.length?0:i(e.charAt(a++));var h=o(u)<<2|o(c)>>4;var v=(o(c)&15)<<4|o(l)>>2;var p=(o(l)&3)<<6|o(f);s+=String.fromCharCode(h);if(l!==64)s+=String.fromCharCode(v);if(f!==64)s+=String.fromCharCode(p)}if(r){var d=s.length;var y=-1;for(var g=d-1;g>=0;g--){if(s.charCodeAt(g)!==0){y=g;break}}if(y!==-1)s=s.slice(0,y+1);else s=""}return s}function pr(e){var t="";var r=new Uint8Array(e);for(var n=0,i=r;n<i.length;n++){var o=i[n];t+=String.fromCharCode(o)}return t}function dr(e){var t=e.length;var r=new ArrayBuffer(t);var n=new Uint8Array(r);for(var i=0;i<t;i++)n[i]=e.charCodeAt(i);return r}var yr=Math.log(2);function gr(e){var t=Math.log(e)/yr;var r=Math.floor(t);var n=Math.round(t);return r===n?r:n}function mr(e,t){for(var r=0,n=t;r<n.length;r++){var i=n[r];delete e[i]}}var br=Object.freeze({__proto__:null,getUTCDate:$t,getParametersValue:Qt,bufferToHexCodes:er,checkBufferParams:tr,utilFromBase:rr,utilToBase:nr,utilConcatBuf:ir,utilConcatView:or,utilDecodeTC:ar,utilEncodeTC:sr,isEqualBuffer:ur,padNumber:cr,toBase64:hr,fromBase64:vr,arrayBufferToString:pr,stringToArrayBuffer:dr,nearestPowerOf2:gr,clearProps:mr});var wr=Zt((function(e,t){Object.defineProperty(t,"__esModule",{value:true});t.fromBER=ce;t.compareSchema=le;t.verifySchema=fe;t.fromJSON=he;t.RawData=t.Repeated=t.Any=t.Choice=t.TIME=t.Duration=t.DateTime=t.TimeOfDay=t.DATE=t.GeneralizedTime=t.UTCTime=t.CharacterString=t.GeneralString=t.VisibleString=t.GraphicString=t.IA5String=t.VideotexString=t.TeletexString=t.PrintableString=t.NumericString=t.UniversalString=t.BmpString=t.RelativeObjectIdentifier=t.Utf8String=t.ObjectIdentifier=t.Enumerated=t.Integer=t.BitString=t.OctetString=t.Null=t.Set=t.Sequence=t.Boolean=t.EndOfContent=t.Constructed=t.Primitive=t.BaseBlock=t.ValueBlock=t.HexBlock=void 0;var r=[new Uint8Array([1])];var n="0123456789";var i=function(){function e(e){if(e===void 0){e={}}this.blockLength=(0,br.getParametersValue)(e,"blockLength",0);this.error=(0,br.getParametersValue)(e,"error","");this.warnings=(0,br.getParametersValue)(e,"warnings",[]);if("valueBeforeDecode"in e)this.valueBeforeDecode=e.valueBeforeDecode.slice(0);else this.valueBeforeDecode=new ArrayBuffer(0)}e.blockName=function(){return"baseBlock"};e.prototype.toJSON=function(){return{blockName:this.constructor.blockName(),blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:(0,br.bufferToHexCodes)(this.valueBeforeDecode,0,this.valueBeforeDecode.byteLength)}};return e}();var o=function(e){return function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.isHexOnly=(0,br.getParametersValue)(t,"isHexOnly",false);if("valueHex"in t)r.valueHex=t.valueHex.slice(0);else r.valueHex=new ArrayBuffer(0);return r}t.blockName=function(){return"hexBlock"};t.prototype.fromBER=function(e,t,r){if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var n=new Uint8Array(e,t,r);if(n.length===0){this.warnings.push("Zero buffer length");return t}this.valueHex=e.slice(t,t+r);this.blockLength=r;return t+r};t.prototype.toBER=function(e){if(e===void 0){e=false}if(this.isHexOnly!==true){this.error='Flag "isHexOnly" is not set, abort';return new ArrayBuffer(0)}if(e===true)return new ArrayBuffer(this.valueHex.byteLength);return this.valueHex.slice(0)};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.blockName=this.constructor.blockName();t.isHexOnly=this.isHexOnly;t.valueHex=(0,br.bufferToHexCodes)(this.valueHex,0,this.valueHex.byteLength);return t};return t}(e)};t.HexBlock=o;var a=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this)||this;if("idBlock"in t){r.isHexOnly=(0,br.getParametersValue)(t.idBlock,"isHexOnly",false);r.valueHex=(0,br.getParametersValue)(t.idBlock,"valueHex",new ArrayBuffer(0));r.tagClass=(0,br.getParametersValue)(t.idBlock,"tagClass",-1);r.tagNumber=(0,br.getParametersValue)(t.idBlock,"tagNumber",-1);r.isConstructed=(0,br.getParametersValue)(t.idBlock,"isConstructed",false)}else{r.tagClass=-1;r.tagNumber=-1;r.isConstructed=false}return r}t.blockName=function(){return"identificationBlock"};t.prototype.toBER=function(e){if(e===void 0){e=false}var t=0;var r;var n;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:this.error="Unknown tag class";return new ArrayBuffer(0)}if(this.isConstructed)t|=32;if(this.tagNumber<31&&!this.isHexOnly){r=new ArrayBuffer(1);n=new Uint8Array(r);if(!e){var i=this.tagNumber;i&=31;t|=i;n[0]=t}return r}if(this.isHexOnly===false){var o=(0,br.utilToBase)(this.tagNumber,7);var a=new Uint8Array(o);var s=o.byteLength;r=new ArrayBuffer(s+1);n=new Uint8Array(r);n[0]=t|31;if(!e){for(var u=0;u<s-1;u++)n[u+1]=a[u]|128;n[s]=a[s-1]}return r}r=new ArrayBuffer(this.valueHex.byteLength+1);n=new Uint8Array(r);n[0]=t|31;if(e===false){var c=new Uint8Array(this.valueHex);for(var u=0;u<c.length-1;u++)n[u+1]=c[u]|128;n[this.valueHex.byteLength]=c[c.length-1]}return r};t.prototype.fromBER=function(e,t,r){if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var n=new Uint8Array(e,t,r);if(n.length===0){this.error="Zero buffer length";return-1}var i=n[0]&192;switch(i){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:this.error="Unknown tag class";return-1}this.isConstructed=(n[0]&32)===32;this.isHexOnly=false;var o=n[0]&31;if(o!==31){this.tagNumber=o;this.blockLength=1}else{var a=1;this.valueHex=new ArrayBuffer(255);var s=255;var u=new Uint8Array(this.valueHex);while(n[a]&128){u[a-1]=n[a]&127;a++;if(a>=n.length){this.error="End of input reached before message was fully decoded";return-1}if(a===s){s+=255;var c=new ArrayBuffer(s);var l=new Uint8Array(c);for(var f=0;f<u.length;f++)l[f]=u[f];this.valueHex=new ArrayBuffer(s);u=new Uint8Array(this.valueHex)}}this.blockLength=a+1;u[a-1]=n[a]&127;var h=new ArrayBuffer(a);var v=new Uint8Array(h);for(var f=0;f<a;f++)v[f]=u[f];this.valueHex=new ArrayBuffer(a);u=new Uint8Array(this.valueHex);u.set(v);if(this.blockLength<=9)this.tagNumber=(0,br.utilFromBase)(u,7);else{this.isHexOnly=true;this.warnings.push("Tag too long, represented as hex-coded")}}if(this.tagClass===1&&this.isConstructed){switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:this.error="Constructed encoding used for primitive type";return-1}}return t+this.blockLength};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.blockName=this.constructor.blockName();t.tagClass=this.tagClass;t.tagNumber=this.tagNumber;t.isConstructed=this.isConstructed;return t};return t}(o(i));var s=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this)||this;if("lenBlock"in t){r.isIndefiniteForm=(0,br.getParametersValue)(t.lenBlock,"isIndefiniteForm",false);r.longFormUsed=(0,br.getParametersValue)(t.lenBlock,"longFormUsed",false);r.length=(0,br.getParametersValue)(t.lenBlock,"length",0)}else{r.isIndefiniteForm=false;r.longFormUsed=false;r.length=0}return r}t.blockName=function(){return"lengthBlock"};t.prototype.fromBER=function(e,t,r){if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var n=new Uint8Array(e,t,r);if(n.length===0){this.error="Zero buffer length";return-1}if(n[0]===255){this.error="Length block 0xFF is reserved by standard";return-1}this.isIndefiniteForm=n[0]===128;if(this.isIndefiniteForm===true){this.blockLength=1;return t+this.blockLength}this.longFormUsed=!!(n[0]&128);if(this.longFormUsed===false){this.length=n[0];this.blockLength=1;return t+this.blockLength}var i=n[0]&127;if(i>8){this.error="Too big integer";return-1}if(i+1>n.length){this.error="End of input reached before message was fully decoded";return-1}var o=new Uint8Array(i);for(var a=0;a<i;a++)o[a]=n[a+1];if(o[i-1]===0)this.warnings.push("Needlessly long encoded length");this.length=(0,br.utilFromBase)(o,8);if(this.longFormUsed&&this.length<=127)this.warnings.push("Unneccesary usage of long length form");this.blockLength=i+1;return t+this.blockLength};t.prototype.toBER=function(e){if(e===void 0){e=false}var t;var r;if(this.length>127)this.longFormUsed=true;if(this.isIndefiniteForm){t=new ArrayBuffer(1);if(e===false){r=new Uint8Array(t);r[0]=128}return t}if(this.longFormUsed===true){var n=(0,br.utilToBase)(this.length,8);if(n.byteLength>127){this.error="Too big length";return new ArrayBuffer(0)}t=new ArrayBuffer(n.byteLength+1);if(e===true)return t;var i=new Uint8Array(n);r=new Uint8Array(t);r[0]=n.byteLength|128;for(var o=0;o<n.byteLength;o++)r[o+1]=i[o];return t}t=new ArrayBuffer(1);if(e===false){r=new Uint8Array(t);r[0]=this.length}return t};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.blockName=this.constructor.blockName();t.isIndefiniteForm=this.isIndefiniteForm;t.longFormUsed=this.longFormUsed;t.length=this.length;return t};return t}(i);var u=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}return e.call(this,t)||this}t.blockName=function(){return"valueBlock"};t.prototype.fromBER=function(e,t,r){throw TypeError('User need to make a specific function in a class which extends "ValueBlock"')};t.prototype.toBER=function(e){if(e===void 0){e=false}throw TypeError('User need to make a specific function in a class which extends "ValueBlock"')};return t}(i);t.ValueBlock=u;var c=function(e){__extends(t,e);function t(t,r){if(t===void 0){t={}}if(r===void 0){r=u}var n=e.call(this,t)||this;if("name"in t)n.name=t.name;if("optional"in t)n.optional=t.optional;if("primitiveSchema"in t)n.primitiveSchema=t.primitiveSchema;n.idBlock=new a(t);n.lenBlock=new s(t);n.valueBlock=new r(t);return n}t.blockName=function(){return"BaseBlock"};t.prototype.fromBER=function(e,t,r){var n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm===true?r:this.lenBlock.length);if(n===-1){this.error=this.valueBlock.error;return n}if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;if(this.valueBlock.error.length===0)this.blockLength+=this.valueBlock.blockLength;return n};t.prototype.toBER=function(e){if(e===void 0){e=false}var t;var r=this.idBlock.toBER(e);var n=this.valueBlock.toBER(true);this.lenBlock.length=n.byteLength;var i=this.lenBlock.toBER(e);t=(0,br.utilConcatBuf)(r,i);var o;if(e===false)o=this.valueBlock.toBER(e);else o=new ArrayBuffer(this.lenBlock.length);t=(0,br.utilConcatBuf)(t,o);if(this.lenBlock.isIndefiniteForm===true){var a=new ArrayBuffer(2);if(e===false){var s=new Uint8Array(a);s[0]=0;s[1]=0}t=(0,br.utilConcatBuf)(t,a)}return t};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.idBlock=this.idBlock.toJSON();t.lenBlock=this.lenBlock.toJSON();t.valueBlock=this.valueBlock.toJSON();if("name"in this)t.name=this.name;if("optional"in this)t.optional=this.optional;if("primitiveSchema"in this)t.primitiveSchema=this.primitiveSchema.toJSON();return t};return t}(i);t.BaseBlock=c;var l=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;if("valueHex"in t)r.valueHex=t.valueHex.slice(0);else r.valueHex=new ArrayBuffer(0);r.isHexOnly=(0,br.getParametersValue)(t,"isHexOnly",true);return r}t.prototype.fromBER=function(e,t,r){if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var n=new Uint8Array(e,t,r);if(n.length===0){this.warnings.push("Zero buffer length");return t}this.valueHex=new ArrayBuffer(n.length);var i=new Uint8Array(this.valueHex);for(var o=0;o<n.length;o++)i[o]=n[o];this.blockLength=r;return t+r};t.prototype.toBER=function(e){if(e===void 0){e=false}return this.valueHex.slice(0)};t.blockName=function(){return"PrimitiveValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.valueHex=(0,br.bufferToHexCodes)(this.valueHex,0,this.valueHex.byteLength);t.isHexOnly=this.isHexOnly;return t};return t}(u);var f=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,l)||this;r.idBlock.isConstructed=false;return r}t.blockName=function(){return"PRIMITIVE"};return t}(c);t.Primitive=f;var h=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.value=(0,br.getParametersValue)(t,"value",[]);r.isIndefiniteForm=(0,br.getParametersValue)(t,"isIndefiniteForm",false);return r}t.prototype.fromBER=function(e,t,r){var n=t;var i=r;if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var o=new Uint8Array(e,t,r);if(o.length===0){this.warnings.push("Zero buffer length");return t}function a(e,t){if(e===true)return 1;return t}var s=t;while(a(this.isIndefiniteForm,r)>0){var u=ue(e,s,r);if(u.offset===-1){this.error=u.result.error;this.warnings.concat(u.result.warnings);return-1}s=u.offset;this.blockLength+=u.result.blockLength;r-=u.result.blockLength;this.value.push(u.result);if(this.isIndefiniteForm===true&&u.result.constructor.blockName()===d.blockName())break}if(this.isIndefiniteForm===true){if(this.value[this.value.length-1].constructor.blockName()===d.blockName())this.value.pop();else this.warnings.push("No EndOfContent block encoded")}this.valueBeforeDecode=e.slice(n,n+i);return s};t.prototype.toBER=function(e){if(e===void 0){e=false}var t=new ArrayBuffer(0);for(var r=0;r<this.value.length;r++){var n=this.value[r].toBER(e);t=(0,br.utilConcatBuf)(t,n)}return t};t.blockName=function(){return"ConstructedValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(n){}t.isIndefiniteForm=this.isIndefiniteForm;t.value=[];for(var r=0;r<this.value.length;r++)t.value.push(this.value[r].toJSON());return t};return t}(u);var v=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,h)||this;r.idBlock.isConstructed=true;return r}t.blockName=function(){return"CONSTRUCTED"};t.prototype.fromBER=function(e,t,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;var n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm===true?r:this.lenBlock.length);if(n===-1){this.error=this.valueBlock.error;return n}if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;if(this.valueBlock.error.length===0)this.blockLength+=this.valueBlock.blockLength;return n};return t}(c);t.Constructed=v;var p=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}return e.call(this,t)||this}t.prototype.fromBER=function(e,t,r){return t};t.prototype.toBER=function(e){if(e===void 0){e=false}return new ArrayBuffer(0)};t.blockName=function(){return"EndOfContentValueBlock"};return t}(u);var d=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,p)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=0;return r}t.blockName=function(){return"EndOfContent"};return t}(c);t.EndOfContent=d;var y=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.value=(0,br.getParametersValue)(t,"value",false);r.isHexOnly=(0,br.getParametersValue)(t,"isHexOnly",false);if("valueHex"in t)r.valueHex=t.valueHex.slice(0);else{r.valueHex=new ArrayBuffer(1);if(r.value===true){var n=new Uint8Array(r.valueHex);n[0]=255}}return r}t.prototype.fromBER=function(e,t,r){if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var n=new Uint8Array(e,t,r);if(r>1)this.warnings.push("Boolean value encoded in more then 1 octet");this.isHexOnly=true;this.valueHex=new ArrayBuffer(n.length);var i=new Uint8Array(this.valueHex);for(var o=0;o<n.length;o++)i[o]=n[o];if(br.utilDecodeTC.call(this)!==0)this.value=true;else this.value=false;this.blockLength=r;return t+r};t.prototype.toBER=function(e){if(e===void 0){e=false}return this.valueHex};t.blockName=function(){return"BooleanValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.value=this.value;t.isHexOnly=this.isHexOnly;t.valueHex=(0,br.bufferToHexCodes)(this.valueHex,0,this.valueHex.byteLength);return t};return t}(u);var g=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,y)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=1;return r}t.blockName=function(){return"Boolean"};return t}(c);t.Boolean=g;var m=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=16;return r}t.blockName=function(){return"Sequence"};return t}(v);t.Sequence=m;var b=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=17;return r}t.blockName=function(){return"Set"};return t}(v);t.Set=b;var w=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,i)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=5;return r}t.blockName=function(){return"Null"};t.prototype.fromBER=function(e,t,r){if(this.lenBlock.length>0)this.warnings.push("Non-zero length of value block for Null type");if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;this.blockLength+=r;if(t+r>e.byteLength){this.error="End of input reached before message was fully decoded (inconsistent offset and length values)";return-1}return t+r};t.prototype.toBER=function(e){if(e===void 0){e=false}var t=new ArrayBuffer(2);if(e===true)return t;var r=new Uint8Array(t);r[0]=5;r[1]=0;return t};return t}(c);t.Null=w;var k=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.isConstructed=(0,br.getParametersValue)(t,"isConstructed",false);return r}t.prototype.fromBER=function(t,r,n){var i=0;if(this.isConstructed===true){this.isHexOnly=false;i=h.prototype.fromBER.call(this,t,r,n);if(i===-1)return i;for(var o=0;o<this.value.length;o++){var a=this.value[o].constructor.blockName();if(a===d.blockName()){if(this.isIndefiniteForm===true)break;else{this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only";return-1}}if(a!==B.blockName()){this.error="OCTET STRING may consists of OCTET STRINGs only";return-1}}}else{this.isHexOnly=true;i=e.prototype.fromBER.call(this,t,r,n);this.blockLength=n}return i};t.prototype.toBER=function(e){if(e===void 0){e=false}if(this.isConstructed===true)return h.prototype.toBER.call(this,e);var t=new ArrayBuffer(this.valueHex.byteLength);if(e===true)return t;if(this.valueHex.byteLength===0)return t;t=this.valueHex.slice(0);return t};t.blockName=function(){return"OctetStringValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.isConstructed=this.isConstructed;t.isHexOnly=this.isHexOnly;t.valueHex=(0,br.bufferToHexCodes)(this.valueHex,0,this.valueHex.byteLength);return t};return t}(o(h));var B=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,k)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=4;return r}t.prototype.fromBER=function(t,r,n){this.valueBlock.isConstructed=this.idBlock.isConstructed;this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;if(n===0){if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;return r}return e.prototype.fromBER.call(this,t,r,n)};t.blockName=function(){return"OctetString"};t.prototype.isEqual=function(e){if(e instanceof t===false)return false;if(JSON.stringify(this)!==JSON.stringify(e))return false;return true};return t}(c);t.OctetString=B;var _=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.unusedBits=(0,br.getParametersValue)(t,"unusedBits",0);r.isConstructed=(0,br.getParametersValue)(t,"isConstructed",false);r.blockLength=r.valueHex.byteLength;return r}t.prototype.fromBER=function(e,t,r){if(r===0)return t;var n=-1;if(this.isConstructed===true){n=h.prototype.fromBER.call(this,e,t,r);if(n===-1)return n;for(var i=0;i<this.value.length;i++){var o=this.value[i].constructor.blockName();if(o===d.blockName()){if(this.isIndefiniteForm===true)break;else{this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only";return-1}}if(o!==N.blockName()){this.error="BIT STRING may consists of BIT STRINGs only";return-1}if(this.unusedBits>0&&this.value[i].valueBlock.unusedBits>0){this.error='Usign of "unused bits" inside constructive BIT STRING allowed for least one only';return-1}this.unusedBits=this.value[i].valueBlock.unusedBits;if(this.unusedBits>7){this.error="Unused bits for BitString must be in range 0-7";return-1}}return n}if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var a=new Uint8Array(e,t,r);this.unusedBits=a[0];if(this.unusedBits>7){this.error="Unused bits for BitString must be in range 0-7";return-1}this.valueHex=new ArrayBuffer(a.length-1);var s=new Uint8Array(this.valueHex);for(var i=0;i<r-1;i++)s[i]=a[i+1];this.blockLength=a.length;return t+r};t.prototype.toBER=function(e){if(e===void 0){e=false}if(this.isConstructed===true)return h.prototype.toBER.call(this,e);if(e===true)return new ArrayBuffer(this.valueHex.byteLength+1);if(this.valueHex.byteLength===0)return new ArrayBuffer(0);var t=new Uint8Array(this.valueHex);var r=new ArrayBuffer(this.valueHex.byteLength+1);var n=new Uint8Array(r);n[0]=this.unusedBits;for(var i=0;i<this.valueHex.byteLength;i++)n[i+1]=t[i];return r};t.blockName=function(){return"BitStringValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.unusedBits=this.unusedBits;t.isConstructed=this.isConstructed;t.isHexOnly=this.isHexOnly;t.valueHex=(0,br.bufferToHexCodes)(this.valueHex,0,this.valueHex.byteLength);return t};return t}(o(h));var N=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,_)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=3;return r}t.blockName=function(){return"BitString"};t.prototype.fromBER=function(t,r,n){if(n===0)return r;this.valueBlock.isConstructed=this.idBlock.isConstructed;this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;return e.prototype.fromBER.call(this,t,r,n)};t.prototype.isEqual=function(e){if(e instanceof t===false)return false;if(JSON.stringify(this)!==JSON.stringify(e))return false;return true};return t}(c);t.BitString=N;var E=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;if("value"in t)r.valueDec=t.value;return r}Object.defineProperty(t.prototype,"valueHex",{get:function(){return this._valueHex},set:function(e){this._valueHex=e.slice(0);if(e.byteLength>=4){this.warnings.push("Too big Integer for decoding, hex only");this.isHexOnly=true;this._valueDec=0}else{this.isHexOnly=false;if(e.byteLength>0)this._valueDec=br.utilDecodeTC.call(this)}},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"valueDec",{get:function(){return this._valueDec},set:function(e){this._valueDec=e;this.isHexOnly=false;this._valueHex=(0,br.utilEncodeTC)(e)},enumerable:true,configurable:true});t.prototype.fromDER=function(e,t,r,n){if(n===void 0){n=0}var i=this.fromBER(e,t,r);if(i===-1)return i;var o=new Uint8Array(this._valueHex);if(o[0]===0&&(o[1]&128)!==0){var a=new ArrayBuffer(this._valueHex.byteLength-1);var s=new Uint8Array(a);s.set(new Uint8Array(this._valueHex,1,this._valueHex.byteLength-1));this._valueHex=a.slice(0)}else{if(n!==0){if(this._valueHex.byteLength<n){if(n-this._valueHex.byteLength>1)n=this._valueHex.byteLength+1;var a=new ArrayBuffer(n);var s=new Uint8Array(a);s.set(o,n-this._valueHex.byteLength);this._valueHex=a.slice(0)}}}return i};t.prototype.toDER=function(e){if(e===void 0){e=false}var t=new Uint8Array(this._valueHex);switch(true){case(t[0]&128)!==0:{var r=new ArrayBuffer(this._valueHex.byteLength+1);var n=new Uint8Array(r);n[0]=0;n.set(t,1);this._valueHex=r.slice(0)}break;case t[0]===0&&(t[1]&128)===0:{var r=new ArrayBuffer(this._valueHex.byteLength-1);var n=new Uint8Array(r);n.set(new Uint8Array(this._valueHex,1,this._valueHex.byteLength-1));this._valueHex=r.slice(0)}break}return this.toBER(e)};t.prototype.fromBER=function(t,r,n){var i=e.prototype.fromBER.call(this,t,r,n);if(i===-1)return i;this.blockLength=n;return r+n};t.prototype.toBER=function(e){if(e===void 0){e=false}return this.valueHex.slice(0)};t.blockName=function(){return"IntegerValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.valueDec=this.valueDec;return t};t.prototype.toString=function(){function e(e,t){var r=new Uint8Array([0]);var n=new Uint8Array(e);var i=new Uint8Array(t);var o=n.slice(0);var a=o.length-1;var s=i.slice(0);var u=s.length-1;var c=0;var l=u<a?a:u;var f=0;for(var h=l;h>=0;h--,f++){switch(true){case f<s.length:c=o[a-f]+s[u-f]+r[0];break;default:c=o[a-f]+r[0]}r[0]=c/10;switch(true){case f>=o.length:o=(0,br.utilConcatView)(new Uint8Array([c%10]),o);break;default:o[a-f]=c%10}}if(r[0]>0)o=(0,br.utilConcatView)(r,o);return o.slice(0)}function t(e){if(e>=r.length){for(var t=r.length;t<=e;t++){var n=new Uint8Array([0]);var i=r[t-1].slice(0);for(var o=i.length-1;o>=0;o--){var a=new Uint8Array([(i[o]<<1)+n[0]]);n[0]=a[0]/10;i[o]=a[0]%10}if(n[0]>0)i=(0,br.utilConcatView)(n,i);r.push(i)}}return r[e]}function i(e,t){var r=0;var n=new Uint8Array(e);var i=new Uint8Array(t);var o=n.slice(0);var a=o.length-1;var s=i.slice(0);var u=s.length-1;var c;var l=0;for(var f=u;f>=0;f--,l++){c=o[a-l]-s[u-l]-r;switch(true){case c<0:r=1;o[a-l]=c+10;break;default:r=0;o[a-l]=c}}if(r>0){for(var f=a-u+1;f>=0;f--,l++){c=o[a-l]-r;if(c<0){r=1;o[a-l]=c+10}else{r=0;o[a-l]=c;break}}}return o.slice()}var o=this._valueHex.byteLength*8-1;var a=new Uint8Array(this._valueHex.byteLength*8/3);var s=0;var u;var c=new Uint8Array(this._valueHex);var l="";var f=false;for(var h=this._valueHex.byteLength-1;h>=0;h--){u=c[h];for(var v=0;v<8;v++){if((u&1)===1){switch(s){case o:a=i(t(s),a);l="-";break;default:a=e(a,t(s))}}s++;u>>=1}}for(var v=0;v<a.length;v++){if(a[v])f=true;if(f)l+=n.charAt(a[v])}if(f===false)l+=n.charAt(0);return l};return t}(o(u));var A=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,E)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=2;return r}t.blockName=function(){return"Integer"};t.prototype.isEqual=function(e){if(e instanceof t){if(this.valueBlock.isHexOnly&&e.valueBlock.isHexOnly)return(0,br.isEqualBuffer)(this.valueBlock.valueHex,e.valueBlock.valueHex);if(this.valueBlock.isHexOnly===e.valueBlock.isHexOnly)return this.valueBlock.valueDec===e.valueBlock.valueDec;return false}if(e instanceof ArrayBuffer)return(0,br.isEqualBuffer)(this.valueBlock.valueHex,e);return false};t.prototype.convertToDER=function(){var e=new t({valueHex:this.valueBlock.valueHex});e.valueBlock.toDER();return e};t.prototype.convertFromDER=function(){var e=this.valueBlock.valueHex.byteLength%2?this.valueBlock.valueHex.byteLength+1:this.valueBlock.valueHex.byteLength;var r=new t({valueHex:this.valueBlock.valueHex});r.valueBlock.fromDER(r.valueBlock.valueHex,0,r.valueBlock.valueHex.byteLength,e);return r};return t}(c);t.Integer=A;var I=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=10;return r}t.blockName=function(){return"Enumerated"};return t}(A);t.Enumerated=I;var S=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.valueDec=(0,br.getParametersValue)(t,"valueDec",-1);r.isFirstSid=(0,br.getParametersValue)(t,"isFirstSid",false);return r}t.blockName=function(){return"sidBlock"};t.prototype.fromBER=function(e,t,r){if(r===0)return t;if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var n=new Uint8Array(e,t,r);this.valueHex=new ArrayBuffer(r);var i=new Uint8Array(this.valueHex);for(var o=0;o<r;o++){i[o]=n[o]&127;this.blockLength++;if((n[o]&128)===0)break}var a=new ArrayBuffer(this.blockLength);var s=new Uint8Array(a);for(var o=0;o<this.blockLength;o++)s[o]=i[o];this.valueHex=a.slice(0);i=new Uint8Array(this.valueHex);if((n[this.blockLength-1]&128)!==0){this.error="End of input reached before message was fully decoded";return-1}if(i[0]===0)this.warnings.push("Needlessly long format of SID encoding");if(this.blockLength<=8)this.valueDec=(0,br.utilFromBase)(i,7);else{this.isHexOnly=true;this.warnings.push("Too big SID for decoding, hex only")}return t+this.blockLength};t.prototype.toBER=function(e){if(e===void 0){e=false}var t;var r;if(this.isHexOnly){if(e===true)return new ArrayBuffer(this.valueHex.byteLength);var n=new Uint8Array(this.valueHex);t=new ArrayBuffer(this.blockLength);r=new Uint8Array(t);for(var i=0;i<this.blockLength-1;i++)r[i]=n[i]|128;r[this.blockLength-1]=n[this.blockLength-1];return t}var o=(0,br.utilToBase)(this.valueDec,7);if(o.byteLength===0){this.error="Error during encoding SID value";return new ArrayBuffer(0)}t=new ArrayBuffer(o.byteLength);if(e===false){var a=new Uint8Array(o);r=new Uint8Array(t);for(var i=0;i<o.byteLength-1;i++)r[i]=a[i]|128;r[o.byteLength-1]=a[o.byteLength-1]}return t};t.prototype.toString=function(){var e="";if(this.isHexOnly===true)e=(0,br.bufferToHexCodes)(this.valueHex,0,this.valueHex.byteLength);else{if(this.isFirstSid){var t=this.valueDec;if(this.valueDec<=39)e="0.";else{if(this.valueDec<=79){e="1.";t-=40}else{e="2.";t-=80}}e+=t.toString()}else e=this.valueDec.toString()}return e};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.valueDec=this.valueDec;t.isFirstSid=this.isFirstSid;return t};return t}(o(i));var x=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.fromString((0,br.getParametersValue)(t,"value",""));return r}t.prototype.fromBER=function(e,t,r){var n=t;while(r>0){var i=new S;n=i.fromBER(e,n,r);if(n===-1){this.blockLength=0;this.error=i.error;return n}if(this.value.length===0)i.isFirstSid=true;this.blockLength+=i.blockLength;r-=i.blockLength;this.value.push(i)}return n};t.prototype.toBER=function(e){if(e===void 0){e=false}var t=new ArrayBuffer(0);for(var r=0;r<this.value.length;r++){var n=this.value[r].toBER(e);if(n.byteLength===0){this.error=this.value[r].error;return new ArrayBuffer(0)}t=(0,br.utilConcatBuf)(t,n)}return t};t.prototype.fromString=function(e){this.value=[];var t=0;var r=0;var n="";var i=false;do{r=e.indexOf(".",t);if(r===-1)n=e.substr(t);else n=e.substr(t,r-t);t=r+1;if(i){var o=this.value[0];var a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return false}var s=parseInt(n,10);if(isNaN(s))return true;o.valueDec=s+a;i=false}else{var o=new S;o.valueDec=parseInt(n,10);if(isNaN(o.valueDec))return true;if(this.value.length===0){o.isFirstSid=true;i=true}this.value.push(o)}}while(r!==-1);return true};t.prototype.toString=function(){var e="";var t=false;for(var r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;var n=this.value[r].toString();if(r!==0)e=e+".";if(t){n="{"+n+"}";if(this.value[r].isFirstSid)e="2.{"+n+" - 80}";else e+=n}else e+=n}return e};t.blockName=function(){return"ObjectIdentifierValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(n){}t.value=this.toString();t.sidArray=[];for(var r=0;r<this.value.length;r++)t.sidArray.push(this.value[r].toJSON());return t};return t}(u);var D=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,x)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=6;return r}t.blockName=function(){return"ObjectIdentifier"};return t}(c);t.ObjectIdentifier=D;var C=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.isHexOnly=true;r.value="";return r}t.blockName=function(){return"Utf8StringValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.value=this.value;return t};return t}(o(i));var O=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,C)||this;if("value"in t)r.fromString(t.value);r.idBlock.tagClass=1;r.idBlock.tagNumber=12;return r}t.blockName=function(){return"Utf8String"};t.prototype.fromBER=function(e,t,r){var n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm===true?r:this.lenBlock.length);if(n===-1){this.error=this.valueBlock.error;return n}this.fromBuffer(this.valueBlock.valueHex);if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;if(this.valueBlock.error.length===0)this.blockLength+=this.valueBlock.blockLength;return n};t.prototype.fromBuffer=function(e){this.valueBlock.value=String.fromCharCode.apply(null,new Uint8Array(e));try{this.valueBlock.value=decodeURIComponent(escape(this.valueBlock.value))}catch(t){this.warnings.push('Error during "decodeURIComponent": '+t+", using raw string")}};t.prototype.fromString=function(e){var t=unescape(encodeURIComponent(e));var r=t.length;this.valueBlock.valueHex=new ArrayBuffer(r);var n=new Uint8Array(this.valueBlock.valueHex);for(var i=0;i<r;i++)n[i]=t.charCodeAt(i);this.valueBlock.value=e};return t}(c);t.Utf8String=O;var K=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.valueDec=(0,br.getParametersValue)(t,"valueDec",-1);return r}t.blockName=function(){return"relativeSidBlock"};t.prototype.fromBER=function(e,t,r){if(r===0)return t;if((0,br.checkBufferParams)(this,e,t,r)===false)return-1;var n=new Uint8Array(e,t,r);this.valueHex=new ArrayBuffer(r);var i=new Uint8Array(this.valueHex);for(var o=0;o<r;o++){i[o]=n[o]&127;this.blockLength++;if((n[o]&128)===0)break}var a=new ArrayBuffer(this.blockLength);var s=new Uint8Array(a);for(var o=0;o<this.blockLength;o++)s[o]=i[o];this.valueHex=a.slice(0);i=new Uint8Array(this.valueHex);if((n[this.blockLength-1]&128)!==0){this.error="End of input reached before message was fully decoded";return-1}if(i[0]===0)this.warnings.push("Needlessly long format of SID encoding");if(this.blockLength<=8)this.valueDec=(0,br.utilFromBase)(i,7);else{this.isHexOnly=true;this.warnings.push("Too big SID for decoding, hex only")}return t+this.blockLength};t.prototype.toBER=function(e){if(e===void 0){e=false}var t;var r;if(this.isHexOnly){if(e===true)return new ArrayBuffer(this.valueHex.byteLength);var n=new Uint8Array(this.valueHex);t=new ArrayBuffer(this.blockLength);r=new Uint8Array(t);for(var i=0;i<this.blockLength-1;i++)r[i]=n[i]|128;r[this.blockLength-1]=n[this.blockLength-1];return t}var o=(0,br.utilToBase)(this.valueDec,7);if(o.byteLength===0){this.error="Error during encoding SID value";return new ArrayBuffer(0)}t=new ArrayBuffer(o.byteLength);if(e===false){var a=new Uint8Array(o);r=new Uint8Array(t);for(var i=0;i<o.byteLength-1;i++)r[i]=a[i]|128;r[o.byteLength-1]=a[o.byteLength-1]}return t};t.prototype.toString=function(){var e="";if(this.isHexOnly===true)e=(0,br.bufferToHexCodes)(this.valueHex,0,this.valueHex.byteLength);else{e=this.valueDec.toString()}return e};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.valueDec=this.valueDec;return t};return t}(o(i));var T=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.fromString((0,br.getParametersValue)(t,"value",""));return r}t.prototype.fromBER=function(e,t,r){var n=t;while(r>0){var i=new K;n=i.fromBER(e,n,r);if(n===-1){this.blockLength=0;this.error=i.error;return n}this.blockLength+=i.blockLength;r-=i.blockLength;this.value.push(i)}return n};t.prototype.toBER=function(e){if(e===void 0){e=false}var t=new ArrayBuffer(0);for(var r=0;r<this.value.length;r++){var n=this.value[r].toBER(e);if(n.byteLength===0){this.error=this.value[r].error;return new ArrayBuffer(0)}t=(0,br.utilConcatBuf)(t,n)}return t};t.prototype.fromString=function(e){this.value=[];var t=0;var r=0;var n="";do{r=e.indexOf(".",t);if(r===-1)n=e.substr(t);else n=e.substr(t,r-t);t=r+1;var i=new K;i.valueDec=parseInt(n,10);if(isNaN(i.valueDec))return true;this.value.push(i)}while(r!==-1);return true};t.prototype.toString=function(){var e="";var t=false;for(var r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;var n=this.value[r].toString();if(r!==0)e=e+".";if(t){n="{"+n+"}";e+=n}else e+=n}return e};t.blockName=function(){return"RelativeObjectIdentifierValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(n){}t.value=this.toString();t.sidArray=[];for(var r=0;r<this.value.length;r++)t.sidArray.push(this.value[r].toJSON());return t};return t}(u);var U=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,T)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=13;return r}t.blockName=function(){return"RelativeObjectIdentifier"};return t}(c);t.RelativeObjectIdentifier=U;var L=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.isHexOnly=true;r.value="";return r}t.blockName=function(){return"BmpStringValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.value=this.value;return t};return t}(o(i));var H=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,L)||this;if("value"in t)r.fromString(t.value);r.idBlock.tagClass=1;r.idBlock.tagNumber=30;return r}t.blockName=function(){return"BmpString"};t.prototype.fromBER=function(e,t,r){var n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm===true?r:this.lenBlock.length);if(n===-1){this.error=this.valueBlock.error;return n}this.fromBuffer(this.valueBlock.valueHex);if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;if(this.valueBlock.error.length===0)this.blockLength+=this.valueBlock.blockLength;return n};t.prototype.fromBuffer=function(e){var t=e.slice(0);var r=new Uint8Array(t);for(var n=0;n<r.length;n+=2){var i=r[n];r[n]=r[n+1];r[n+1]=i}this.valueBlock.value=String.fromCharCode.apply(null,new Uint16Array(t))};t.prototype.fromString=function(e){var t=e.length;this.valueBlock.valueHex=new ArrayBuffer(t*2);var r=new Uint8Array(this.valueBlock.valueHex);for(var n=0;n<t;n++){var i=(0,br.utilToBase)(e.charCodeAt(n),8);var o=new Uint8Array(i);if(o.length>2)continue;var a=2-o.length;for(var s=o.length-1;s>=0;s--)r[n*2+s+a]=o[s]}this.valueBlock.value=e};return t}(c);t.BmpString=H;var X=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.isHexOnly=true;r.value="";return r}t.blockName=function(){return"UniversalStringValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.value=this.value;return t};return t}(o(i));var R=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,X)||this;if("value"in t)r.fromString(t.value);r.idBlock.tagClass=1;r.idBlock.tagNumber=28;return r}t.blockName=function(){return"UniversalString"};t.prototype.fromBER=function(e,t,r){var n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm===true?r:this.lenBlock.length);if(n===-1){this.error=this.valueBlock.error;return n}this.fromBuffer(this.valueBlock.valueHex);if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;if(this.valueBlock.error.length===0)this.blockLength+=this.valueBlock.blockLength;return n};t.prototype.fromBuffer=function(e){var t=e.slice(0);var r=new Uint8Array(t);for(var n=0;n<r.length;n+=4){r[n]=r[n+3];r[n+1]=r[n+2];r[n+2]=0;r[n+3]=0}this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))};t.prototype.fromString=function(e){var t=e.length;this.valueBlock.valueHex=new ArrayBuffer(t*4);var r=new Uint8Array(this.valueBlock.valueHex);for(var n=0;n<t;n++){var i=(0,br.utilToBase)(e.charCodeAt(n),8);var o=new Uint8Array(i);if(o.length>4)continue;var a=4-o.length;for(var s=o.length-1;s>=0;s--)r[n*4+s+a]=o[s]}this.valueBlock.value=e};return t}(c);t.UniversalString=R;var P=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.value="";r.isHexOnly=true;return r}t.blockName=function(){return"SimpleStringValueBlock"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.value=this.value;return t};return t}(o(i));var q=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t,P)||this;if("value"in t)r.fromString(t.value);return r}t.blockName=function(){return"SIMPLESTRING"};t.prototype.fromBER=function(e,t,r){var n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm===true?r:this.lenBlock.length);if(n===-1){this.error=this.valueBlock.error;return n}this.fromBuffer(this.valueBlock.valueHex);if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;if(this.valueBlock.error.length===0)this.blockLength+=this.valueBlock.blockLength;return n};t.prototype.fromBuffer=function(e){this.valueBlock.value=String.fromCharCode.apply(null,new Uint8Array(e))};t.prototype.fromString=function(e){var t=e.length;this.valueBlock.valueHex=new ArrayBuffer(t);var r=new Uint8Array(this.valueBlock.valueHex);for(var n=0;n<t;n++)r[n]=e.charCodeAt(n);this.valueBlock.value=e};return t}(c);var j=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=18;return r}t.blockName=function(){return"NumericString"};return t}(q);t.NumericString=j;var V=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=19;return r}t.blockName=function(){return"PrintableString"};return t}(q);t.PrintableString=V;var J=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=20;return r}t.blockName=function(){return"TeletexString"};return t}(q);t.TeletexString=J;var F=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=21;return r}t.blockName=function(){return"VideotexString"};return t}(q);t.VideotexString=F;var M=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=22;return r}t.blockName=function(){return"IA5String"};return t}(q);t.IA5String=M;var G=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=25;return r}t.blockName=function(){return"GraphicString"};return t}(q);t.GraphicString=G;var z=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=26;return r}t.blockName=function(){return"VisibleString"};return t}(q);t.VisibleString=z;var W=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=27;return r}t.blockName=function(){return"GeneralString"};return t}(q);t.GeneralString=W;var Y=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=29;return r}t.blockName=function(){return"CharacterString"};return t}(q);t.CharacterString=Y;var Z=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.year=0;r.month=0;r.day=0;r.hour=0;r.minute=0;r.second=0;if("value"in t){r.fromString(t.value);r.valueBlock.valueHex=new ArrayBuffer(t.value.length);var n=new Uint8Array(r.valueBlock.valueHex);for(var i=0;i<t.value.length;i++)n[i]=t.value.charCodeAt(i)}if("valueDate"in t){r.fromDate(t.valueDate);r.valueBlock.valueHex=r.toBuffer()}r.idBlock.tagClass=1;r.idBlock.tagNumber=23;return r}t.prototype.fromBER=function(e,t,r){var n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm===true?r:this.lenBlock.length);if(n===-1){this.error=this.valueBlock.error;return n}this.fromBuffer(this.valueBlock.valueHex);if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;if(this.valueBlock.error.length===0)this.blockLength+=this.valueBlock.blockLength;return n};t.prototype.fromBuffer=function(e){this.fromString(String.fromCharCode.apply(null,new Uint8Array(e)))};t.prototype.toBuffer=function(){var e=this.toString();var t=new ArrayBuffer(e.length);var r=new Uint8Array(t);for(var n=0;n<e.length;n++)r[n]=e.charCodeAt(n);return t};t.prototype.fromDate=function(e){this.year=e.getUTCFullYear();this.month=e.getUTCMonth()+1;this.day=e.getUTCDate();this.hour=e.getUTCHours();this.minute=e.getUTCMinutes();this.second=e.getUTCSeconds()};t.prototype.toDate=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))};t.prototype.fromString=function(e){var t=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/gi;var r=t.exec(e);if(r===null){this.error="Wrong input string for convertion";return}var n=parseInt(r[1],10);if(n>=50)this.year=1900+n;else this.year=2e3+n;this.month=parseInt(r[2],10);this.day=parseInt(r[3],10);this.hour=parseInt(r[4],10);this.minute=parseInt(r[5],10);this.second=parseInt(r[6],10)};t.prototype.toString=function(){var e=new Array(7);e[0]=(0,br.padNumber)(this.year<2e3?this.year-1900:this.year-2e3,2);e[1]=(0,br.padNumber)(this.month,2);e[2]=(0,br.padNumber)(this.day,2);e[3]=(0,br.padNumber)(this.hour,2);e[4]=(0,br.padNumber)(this.minute,2);e[5]=(0,br.padNumber)(this.second,2);e[6]="Z";return e.join("")};t.blockName=function(){return"UTCTime"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.year=this.year;t.month=this.month;t.day=this.day;t.hour=this.hour;t.minute=this.minute;t.second=this.second;return t};return t}(z);t.UTCTime=Z;var $=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.year=0;r.month=0;r.day=0;r.hour=0;r.minute=0;r.second=0;r.millisecond=0;if("value"in t){r.fromString(t.value);r.valueBlock.valueHex=new ArrayBuffer(t.value.length);var n=new Uint8Array(r.valueBlock.valueHex);for(var i=0;i<t.value.length;i++)n[i]=t.value.charCodeAt(i)}if("valueDate"in t){r.fromDate(t.valueDate);r.valueBlock.valueHex=r.toBuffer()}r.idBlock.tagClass=1;r.idBlock.tagNumber=24;return r}t.prototype.fromBER=function(e,t,r){var n=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm===true?r:this.lenBlock.length);if(n===-1){this.error=this.valueBlock.error;return n}this.fromBuffer(this.valueBlock.valueHex);if(this.idBlock.error.length===0)this.blockLength+=this.idBlock.blockLength;if(this.lenBlock.error.length===0)this.blockLength+=this.lenBlock.blockLength;if(this.valueBlock.error.length===0)this.blockLength+=this.valueBlock.blockLength;return n};t.prototype.fromBuffer=function(e){this.fromString(String.fromCharCode.apply(null,new Uint8Array(e)))};t.prototype.toBuffer=function(){var e=this.toString();var t=new ArrayBuffer(e.length);var r=new Uint8Array(t);for(var n=0;n<e.length;n++)r[n]=e.charCodeAt(n);return t};t.prototype.fromDate=function(e){this.year=e.getUTCFullYear();this.month=e.getUTCMonth()+1;this.day=e.getUTCDate();this.hour=e.getUTCHours();this.minute=e.getUTCMinutes();this.second=e.getUTCSeconds();this.millisecond=e.getUTCMilliseconds()};t.prototype.toDate=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond))};t.prototype.fromString=function(e){var t=false;var r="";var n="";var i=0;var o;var a=0;var s=0;if(e[e.length-1]==="Z"){r=e.substr(0,e.length-1);t=true}else{var u=new Number(e[e.length-1]);if(isNaN(u.valueOf()))throw new Error("Wrong input string for convertion");r=e}if(t){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for convertion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for convertion")}else{var c=1;var l=r.indexOf("+");var f="";if(l===-1){l=r.indexOf("-");c=-1}if(l!==-1){f=r.substr(l+1);r=r.substr(0,l);if(f.length!==2&&f.length!==4)throw new Error("Wrong input string for convertion");var u=new Number(f.substr(0,2));if(isNaN(u.valueOf()))throw new Error("Wrong input string for convertion");a=c*u;if(f.length===4){u=new Number(f.substr(2,2));if(isNaN(u.valueOf()))throw new Error("Wrong input string for convertion");s=c*u}}}var h=r.indexOf(".");if(h===-1)h=r.indexOf(",");if(h!==-1){var v=new Number("0"+r.substr(h));if(isNaN(v.valueOf()))throw new Error("Wrong input string for convertion");i=v.valueOf();n=r.substr(0,h)}else n=r;switch(true){case n.length===8:o=/(\d{4})(\d{2})(\d{2})/gi;if(h!==-1)throw new Error("Wrong input string for convertion");break;case n.length===10:o=/(\d{4})(\d{2})(\d{2})(\d{2})/gi;if(h!==-1){var p=60*i;this.minute=Math.floor(p);p=60*(p-this.minute);this.second=Math.floor(p);p=1e3*(p-this.second);this.millisecond=Math.floor(p)}break;case n.length===12:o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/gi;if(h!==-1){var p=60*i;this.second=Math.floor(p);p=1e3*(p-this.second);this.millisecond=Math.floor(p)}break;case n.length===14:o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/gi;if(h!==-1){var p=1e3*i;this.millisecond=Math.floor(p)}break;default:throw new Error("Wrong input string for convertion")}var d=o.exec(n);if(d===null)throw new Error("Wrong input string for convertion");for(var y=1;y<d.length;y++){switch(y){case 1:this.year=parseInt(d[y],10);break;case 2:this.month=parseInt(d[y],10);break;case 3:this.day=parseInt(d[y],10);break;case 4:this.hour=parseInt(d[y],10)+a;break;case 5:this.minute=parseInt(d[y],10)+s;break;case 6:this.second=parseInt(d[y],10);break;default:throw new Error("Wrong input string for convertion")}}if(t===false){var g=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=g.getUTCFullYear();this.month=g.getUTCMonth();this.day=g.getUTCDay();this.hour=g.getUTCHours();this.minute=g.getUTCMinutes();this.second=g.getUTCSeconds();this.millisecond=g.getUTCMilliseconds()}};t.prototype.toString=function(){var e=[];e.push((0,br.padNumber)(this.year,4));e.push((0,br.padNumber)(this.month,2));e.push((0,br.padNumber)(this.day,2));e.push((0,br.padNumber)(this.hour,2));e.push((0,br.padNumber)(this.minute,2));e.push((0,br.padNumber)(this.second,2));if(this.millisecond!==0){e.push(".");e.push((0,br.padNumber)(this.millisecond,3))}e.push("Z");return e.join("")};t.blockName=function(){return"GeneralizedTime"};t.prototype.toJSON=function(){var t={};try{t=e.prototype.toJSON.call(this)}catch(r){}t.year=this.year;t.month=this.month;t.day=this.day;t.hour=this.hour;t.minute=this.minute;t.second=this.second;t.millisecond=this.millisecond;return t};return t}(z);t.GeneralizedTime=$;var Q=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=31;return r}t.blockName=function(){return"DATE"};return t}(O);t.DATE=Q;var ee=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=32;return r}t.blockName=function(){return"TimeOfDay"};return t}(O);t.TimeOfDay=ee;var te=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=33;return r}t.blockName=function(){return"DateTime"};return t}(O);t.DateTime=te;var re=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=34;return r}t.blockName=function(){return"Duration"};return t}(O);t.Duration=re;var ne=function(e){__extends(t,e);function t(t){if(t===void 0){t={}}var r=e.call(this,t)||this;r.idBlock.tagClass=1;r.idBlock.tagNumber=14;return r}t.blockName=function(){return"TIME"};return t}(O);t.TIME=ne;var ie=function(){function e(e){if(e===void 0){e={}}this.value=(0,br.getParametersValue)(e,"value",[]);this.optional=(0,br.getParametersValue)(e,"optional",false)}return e}();t.Choice=ie;var oe=function(){function e(e){if(e===void 0){e={}}this.name=(0,br.getParametersValue)(e,"name","");this.optional=(0,br.getParametersValue)(e,"optional",false)}return e}();t.Any=oe;var ae=function(){function e(e){if(e===void 0){e={}}this.name=(0,br.getParametersValue)(e,"name","");this.optional=(0,br.getParametersValue)(e,"optional",false);this.value=(0,br.getParametersValue)(e,"value",new oe);this.local=(0,br.getParametersValue)(e,"local",false)}return e}();t.Repeated=ae;var se=function(){function e(e){if(e===void 0){e={}}this.data=(0,br.getParametersValue)(e,"data",new ArrayBuffer(0))}e.prototype.fromBER=function(e,t,r){this.data=e.slice(t,r);return t+r};e.prototype.toBER=function(e){if(e===void 0){e=false}return this.data};return e}();t.RawData=se;function ue(e,t,r){var n=t;function o(e,t){if(e instanceof t)return e;var r=new t;r.idBlock=e.idBlock;r.lenBlock=e.lenBlock;r.warnings=e.warnings;r.valueBeforeDecode=e.valueBeforeDecode.slice(0);return r}var a=new c({},Object);var s=new i;if((0,br.checkBufferParams)(s,e,t,r)===false){a.error=s.error;return{offset:-1,result:a}}var u=new Uint8Array(e,t,r);if(u.length===0){this.error="Zero buffer length";return{offset:-1,result:a}}var l=a.idBlock.fromBER(e,t,r);a.warnings.concat(a.idBlock.warnings);if(l===-1){a.error=a.idBlock.error;return{offset:-1,result:a}}t=l;r-=a.idBlock.blockLength;l=a.lenBlock.fromBER(e,t,r);a.warnings.concat(a.lenBlock.warnings);if(l===-1){a.error=a.lenBlock.error;return{offset:-1,result:a}}t=l;r-=a.lenBlock.blockLength;if(a.idBlock.isConstructed===false&&a.lenBlock.isIndefiniteForm===true){a.error="Indefinite length form used for primitive encoding form";return{offset:-1,result:a}}var h=c;switch(a.idBlock.tagClass){case 1:if(a.idBlock.tagNumber>=37&&a.idBlock.isHexOnly===false){a.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard";return{offset:-1,result:a}}switch(a.idBlock.tagNumber){case 0:if(a.idBlock.isConstructed===true&&a.lenBlock.length>0){a.error="Type [UNIVERSAL 0] is reserved";return{offset:-1,result:a}}h=d;break;case 1:h=g;break;case 2:h=A;break;case 3:h=N;break;case 4:h=B;break;case 5:h=w;break;case 6:h=D;break;case 10:h=I;break;case 12:h=O;break;case 13:h=U;break;case 14:h=ne;break;case 15:a.error="[UNIVERSAL 15] is reserved by ASN.1 standard";return{offset:-1,result:a};case 16:h=m;break;case 17:h=b;break;case 18:h=j;break;case 19:h=V;break;case 20:h=J;break;case 21:h=F;break;case 22:h=M;break;case 23:h=Z;break;case 24:h=$;break;case 25:h=G;break;case 26:h=z;break;case 27:h=W;break;case 28:h=R;break;case 29:h=Y;break;case 30:h=H;break;case 31:h=Q;break;case 32:h=ee;break;case 33:h=te;break;case 34:h=re;break;default:{var p=void 0;if(a.idBlock.isConstructed===true)p=new v;else p=new f;p.idBlock=a.idBlock;p.lenBlock=a.lenBlock;p.warnings=a.warnings;a=p;l=a.fromBER(e,t,r)}}break;case 2:case 3:case 4:default:{if(a.idBlock.isConstructed===true)h=v;else h=f}}a=o(a,h);l=a.fromBER(e,t,a.lenBlock.isIndefiniteForm===true?r:a.lenBlock.length);a.valueBeforeDecode=e.slice(n,n+a.blockLength);return{offset:l,result:a}}function ce(e){if(e.byteLength===0){var t=new c({},Object);t.error="Input buffer has zero length";return{offset:-1,result:t}}return ue(e,0,e.byteLength)}function le(e,t,r){if(r instanceof ie){for(var n=0;n<r.value.length;n++){var i=le(e,t,r.value[n]);if(i.verified===true){return{verified:true,result:e}}}{var o={verified:false,result:{error:"Wrong values for Choice type"}};if(r.hasOwnProperty("name"))o.name=r.name;return o}}if(r instanceof oe){if(r.hasOwnProperty("name"))e[r.name]=t;return{verified:true,result:e}}if(e instanceof Object===false){return{verified:false,result:{error:"Wrong root object"}}}if(t instanceof Object===false){return{verified:false,result:{error:"Wrong ASN.1 data"}}}if(r instanceof Object===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}if("idBlock"in r===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}if("fromBER"in r.idBlock===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}if("toBER"in r.idBlock===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}var a=r.idBlock.toBER(false);if(a.byteLength===0){return{verified:false,result:{error:"Error encoding idBlock for ASN.1 schema"}}}var s=r.idBlock.fromBER(a,0,a.byteLength);if(s===-1){return{verified:false,result:{error:"Error decoding idBlock for ASN.1 schema"}}}if(r.idBlock.hasOwnProperty("tagClass")===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}if(r.idBlock.tagClass!==t.idBlock.tagClass){return{verified:false,result:e}}if(r.idBlock.hasOwnProperty("tagNumber")===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}if(r.idBlock.tagNumber!==t.idBlock.tagNumber){return{verified:false,result:e}}if(r.idBlock.hasOwnProperty("isConstructed")===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}if(r.idBlock.isConstructed!==t.idBlock.isConstructed){return{verified:false,result:e}}if("isHexOnly"in r.idBlock===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}if(r.idBlock.isHexOnly!==t.idBlock.isHexOnly){return{verified:false,result:e}}if(r.idBlock.isHexOnly===true){if("valueHex"in r.idBlock===false){return{verified:false,result:{error:"Wrong ASN.1 schema"}}}var u=new Uint8Array(r.idBlock.valueHex);var c=new Uint8Array(t.idBlock.valueHex);if(u.length!==c.length){return{verified:false,result:e}}for(var l=0;l<u.length;l++){if(u[l]!==c[1]){return{verified:false,result:e}}}}if(r.hasOwnProperty("name")){r.name=r.name.replace(/^\s+|\s+$/g,"");if(r.name!=="")e[r.name]=t}if(r.idBlock.isConstructed===true){var f=0;var i={verified:false};var h=r.valueBlock.value.length;if(h>0){if(r.valueBlock.value[0]instanceof ae)h=t.valueBlock.value.length}if(h===0){return{verified:true,result:e}}if(t.valueBlock.value.length===0&&r.valueBlock.value.length!==0){var v=true;for(var l=0;l<r.valueBlock.value.length;l++)v=v&&(r.valueBlock.value[l].optional||false);if(v===true){return{verified:true,result:e}}if(r.hasOwnProperty("name")){r.name=r.name.replace(/^\s+|\s+$/g,"");if(r.name!=="")delete e[r.name]}e.error="Inconsistent object length";return{verified:false,result:e}}for(var l=0;l<h;l++){if(l-f>=t.valueBlock.value.length){if(r.valueBlock.value[l].optional===false){var o={verified:false,result:e};e.error="Inconsistent length between ASN.1 data and schema";if(r.hasOwnProperty("name")){r.name=r.name.replace(/^\s+|\s+$/g,"");if(r.name!==""){delete e[r.name];o.name=r.name}}return o}}else{if(r.valueBlock.value[0]instanceof ae){i=le(e,t.valueBlock.value[l],r.valueBlock.value[0].value);if(i.verified===false){if(r.valueBlock.value[0].optional===true)f++;else{if(r.hasOwnProperty("name")){r.name=r.name.replace(/^\s+|\s+$/g,"");if(r.name!=="")delete e[r.name]}return i}}if("name"in r.valueBlock.value[0]&&r.valueBlock.value[0].name.length>0){var p={};if("local"in r.valueBlock.value[0]&&r.valueBlock.value[0].local===true)p=t;else p=e;if(typeof p[r.valueBlock.value[0].name]==="undefined")p[r.valueBlock.value[0].name]=[];p[r.valueBlock.value[0].name].push(t.valueBlock.value[l])}}else{i=le(e,t.valueBlock.value[l-f],r.valueBlock.value[l]);if(i.verified===false){if(r.valueBlock.value[l].optional===true)f++;else{if(r.hasOwnProperty("name")){r.name=r.name.replace(/^\s+|\s+$/g,"");if(r.name!=="")delete e[r.name]}return i}}}}}if(i.verified===false){var o={verified:false,result:e};if(r.hasOwnProperty("name")){r.name=r.name.replace(/^\s+|\s+$/g,"");if(r.name!==""){delete e[r.name];o.name=r.name}}return o}return{verified:true,result:e}}if("primitiveSchema"in r&&"valueHex"in t.valueBlock){var d=ce(t.valueBlock.valueHex);if(d.offset===-1){var o={verified:false,result:d.result};if(r.hasOwnProperty("name")){r.name=r.name.replace(/^\s+|\s+$/g,"");if(r.name!==""){delete e[r.name];o.name=r.name}}return o}return le(e,d.result,r.primitiveSchema)}return{verified:true,result:e}}function fe(e,t){if(t instanceof Object===false){return{verified:false,result:{error:"Wrong ASN.1 schema type"}}}var r=ce(e);if(r.offset===-1){return{verified:false,result:r.result}}return le(r.result,r.result,t)}function he(e){}}));var kr=Yt(wr);var Br=wr.fromBER;var _r=wr.compareSchema;var Nr=wr.verifySchema;var Er=wr.fromJSON;var Ar=wr.RawData;var Ir=wr.Repeated;var Sr=wr.Any;var xr=wr.Choice;var Dr=wr.TIME;var Cr=wr.Duration;var Or=wr.DateTime;var Kr=wr.TimeOfDay;var Tr=wr.DATE;var Ur=wr.GeneralizedTime;var Lr=wr.UTCTime;var Hr=wr.CharacterString;var Xr=wr.GeneralString;var Rr=wr.VisibleString;var Pr=wr.GraphicString;var qr=wr.IA5String;var jr=wr.VideotexString;var Vr=wr.TeletexString;var Jr=wr.PrintableString;var Fr=wr.NumericString;var Mr=wr.UniversalString;var Gr=wr.BmpString;var zr=wr.RelativeObjectIdentifier;var Wr=wr.Utf8String;var Yr=wr.ObjectIdentifier;var Zr=wr.Enumerated;var $r=wr.Integer;var Qr=wr.BitString;var en=wr.OctetString;var tn=wr.Null;var rn=wr.Set;var nn=wr.Sequence;var on=wr.Boolean;var an=wr.EndOfContent;var sn=wr.Constructed;var un=wr.Primitive;var cn=wr.BaseBlock;var ln=wr.ValueBlock;var fn=wr.HexBlock;var hn=Object.freeze({__proto__:null,default:kr,__moduleExports:wr,fromBER:Br,compareSchema:_r,verifySchema:Nr,fromJSON:Er,RawData:Ar,Repeated:Ir,Any:Sr,Choice:xr,TIME:Dr,Duration:Cr,DateTime:Or,TimeOfDay:Kr,DATE:Tr,GeneralizedTime:Ur,UTCTime:Lr,CharacterString:Hr,GeneralString:Xr,VisibleString:Rr,GraphicString:Pr,IA5String:qr,VideotexString:jr,TeletexString:Vr,PrintableString:Jr,NumericString:Fr,UniversalString:Mr,BmpString:Gr,RelativeObjectIdentifier:zr,Utf8String:Wr,ObjectIdentifier:Yr,Enumerated:Zr,Integer:$r,BitString:Qr,OctetString:en,Null:tn,Set:rn,Sequence:nn,Boolean:on,EndOfContent:an,Constructed:sn,Primitive:un,BaseBlock:cn,ValueBlock:ln,HexBlock:fn});var vn={fromASN:function(e){return e instanceof tn?null:e.valueBeforeDecode},toASN:function(e){if(e===null){return new tn}var t=Br(e);if(t.result.error){throw new Error(t.result.error)}return t.result}};var pn={fromASN:function(e){return!e.valueBlock.valueDec&&e.valueBlock.valueHex.byteLength>0?e.valueBlock.toString():e.valueBlock.valueDec},toASN:function(e){return new $r({value:e})}};var dn={fromASN:function(e){return e.valueBlock.valueDec},toASN:function(e){return new Zr({value:e})}};var yn={fromASN:function(e){return e.valueBlock.valueHex},toASN:function(e){return new $r({valueHex:e})}};var gn={fromASN:function(e){return e.valueBlock.valueHex},toASN:function(e){return new Qr({valueHex:e})}};var mn={fromASN:function(e){return e.valueBlock.toString()},toASN:function(e){return new Yr({value:e})}};var bn={fromASN:function(e){return e.valueBlock.value},toASN:function(e){return new on({value:e})}};var wn={fromASN:function(e){return e.valueBlock.valueHex},toASN:function(e){return new en({valueHex:e})}};function kn(e){return{fromASN:function(e){return e.valueBlock.value},toASN:function(t){return new e({value:t})}}}var Bn=kn(Wr);var _n=kn(Gr);var Nn=kn(Mr);var En=kn(Fr);var An=kn(Jr);var In=kn(Vr);var Sn=kn(jr);var xn=kn(qr);var Dn=kn(Pr);var Cn=kn(Rr);var On=kn(Xr);var Kn=kn(Hr);var Tn={fromASN:function(e){return e.toDate()},toASN:function(e){return new Lr({valueDate:e})}};var Un={fromASN:function(e){return e.toDate()},toASN:function(e){return new Ur({valueDate:e})}};var Ln={fromASN:function(e){return null},toASN:function(e){return new tn}};var Hn=Object.freeze({__proto__:null,AsnAnyConverter:vn,AsnIntegerConverter:pn,AsnEnumeratedConverter:dn,AsnIntegerArrayBufferConverter:yn,AsnBitStringConverter:gn,AsnObjectIdentifierConverter:mn,AsnBooleanConverter:bn,AsnOctetStringConverter:wn,AsnUtf8StringConverter:Bn,AsnBmpStringConverter:_n,AsnUniversalStringConverter:Nn,AsnNumericStringConverter:En,AsnPrintableStringConverter:An,AsnTeletexStringConverter:In,AsnVideotexStringConverter:Sn,AsnIA5StringConverter:xn,AsnGraphicStringConverter:Dn,AsnVisibleStringConverter:Cn,AsnGeneralStringConverter:On,AsnCharacterStringConverter:Kn,AsnUTCTimeConverter:Tn,AsnGeneralizedTimeConverter:Un,AsnNullConverter:Ln});var Xn;(function(e){e[e["Sequence"]=0]="Sequence";e[e["Set"]=1]="Set";e[e["Choice"]=2]="Choice"})(Xn||(Xn={}));var Rn;(function(e){e[e["Any"]=1]="Any";e[e["Boolean"]=2]="Boolean";e[e["OctetString"]=3]="OctetString";e[e["BitString"]=4]="BitString";e[e["Integer"]=5]="Integer";e[e["Enumerated"]=6]="Enumerated";e[e["ObjectIdentifier"]=7]="ObjectIdentifier";e[e["Utf8String"]=8]="Utf8String";e[e["BmpString"]=9]="BmpString";e[e["UniversalString"]=10]="UniversalString";e[e["NumericString"]=11]="NumericString";e[e["PrintableString"]=12]="PrintableString";e[e["TeletexString"]=13]="TeletexString";e[e["VideotexString"]=14]="VideotexString";e[e["IA5String"]=15]="IA5String";e[e["GraphicString"]=16]="GraphicString";e[e["VisibleString"]=17]="VisibleString";e[e["GeneralString"]=18]="GeneralString";e[e["CharacterString"]=19]="CharacterString";e[e["UTCTime"]=20]="UTCTime";e[e["GeneralizedTime"]=21]="GeneralizedTime";e[e["DATE"]=22]="DATE";e[e["TimeOfDay"]=23]="TimeOfDay";e[e["DateTime"]=24]="DateTime";e[e["Duration"]=25]="Duration";e[e["TIME"]=26]="TIME";e[e["Null"]=27]="Null"})(Rn||(Rn={}));function Pn(e){if(e&&e.prototype){if(e.prototype.toASN&&e.prototype.fromASN){return true}else{return Pn(e.prototype)}}else{return!!(e&&e.toASN&&e.fromASN)}}function qn(e,t){if(!(e&&t)){return false}if(e.byteLength!==t.byteLength){return false}var r=new Uint8Array(e);var n=new Uint8Array(t);for(var i=0;i<e.byteLength;i++){if(r[i]!==n[i]){return false}}return true}var jn=function(){function e(){this.items=new WeakMap}e.prototype.has=function(e){return this.items.has(e)};e.prototype.get=function(e){var t,r,n,i;var o=this.items.get(e);if(!o){throw new Error("Cannot get schema for '"+((i=(n=(r=(t=e)===null||t===void 0?void 0:t.prototype)===null||r===void 0?void 0:r.constructor)===null||n===void 0?void 0:n.name)!==null&&i!==void 0?i:e)+"' target")}return o};e.prototype.cache=function(e){var t=this.get(e);if(!t.schema){t.schema=this.create(e,true)}};e.prototype.createDefault=function(e){var t={type:Xn.Sequence,items:{}};var r=this.findParentSchema(e);if(r){Object.assign(t,r);t.items=Object.assign({},t.items,r.items)}return t};e.prototype.create=function(e,t){var r=this.items.get(e)||this.createDefault(e);var n=[];for(var i in r.items){var o=r.items[i];var a=t?i:"";var s=void 0;if(typeof o.type==="number"){var u=Rn[o.type];var c=hn[u];if(!c){throw new Error("Cannot get ASN1 class by name '"+u+"'")}s=new c({name:a})}else if(Pn(o.type)){var l=new o.type;s=l.toSchema(a)}else{s=new Sr({name:a})}var f=!!o.optional||o.defaultValue!==undefined;if(o.repeated){s.name="";var h=o.repeated==="set"?rn:nn;s=new h({name:"",value:[new Ir({name:a,value:s})]})}if(o.context!==null&&o.context!==undefined){if(o.implicit){if(typeof o.type==="number"||Pn(o.type)){var h=o.repeated?sn:un;n.push(new h({name:a,optional:f,idBlock:{tagClass:3,tagNumber:o.context}}))}else{this.cache(o.type);var v=!!o.repeated;var p=!v?this.get(o.type).schema:s;p=p.valueBlock?p.valueBlock.value:p.value;n.push(new sn({name:!v?a:"",optional:f,idBlock:{tagClass:3,tagNumber:o.context},value:p}))}}else{n.push(new sn({optional:f,idBlock:{tagClass:3,tagNumber:o.context},value:[s]}))}}else{s.optional=f;n.push(s)}}switch(r.type){case Xn.Sequence:return new nn({value:n,name:""});case Xn.Set:return new rn({value:n,name:""});case Xn.Choice:return new xr({value:n,name:""});default:throw new Error("Unsupported ASN1 type in use")}};e.prototype.set=function(e,t){this.items.set(e,t);return this};e.prototype.findParentSchema=function(e){var t=e.__proto__;if(t){var r=this.items.get(t);return r||this.findParentSchema(t)}return null};return e}();var Vn=new jn;var Jn=function(e){return function(t){var r;if(!Vn.has(t)){r=Vn.createDefault(t);Vn.set(t,r)}else{r=Vn.get(t)}Object.assign(r,e)}};var Fn=function(e){return function(t,r){var n;if(!Vn.has(t.constructor)){n=Vn.createDefault(t.constructor);Vn.set(t.constructor,n)}else{n=Vn.get(t.constructor)}var i=Object.assign({},e);if(typeof i.type==="number"&&!i.converter){var o="Asn"+Rn[e.type]+"Converter";var a=Hn[o];if(!a){throw new Error("Cannot get '"+o+"' for property '"+r+"' of "+t.constructor.name)}i.converter=a}n.items[r]=i}};var Mn=function(){function e(){}e.serialize=function(e){if(e instanceof cn){return e.toBER(false)}return this.toASN(e).toBER(false)};e.toASN=function(t){var r=this;if(t&&Pn(t.constructor)){return t.toASN()}var n=t.constructor;var i=Vn.get(n);Vn.cache(n);var o=[];if(i.itemType){o=t.map((function(e){return r.toAsnItem({type:i.itemType},"[]",n,e)}))}else{for(var a in i.items){var s=i.items[a];var u=t[a];if(u===undefined||s.defaultValue===u||typeof s.defaultValue==="object"&&typeof u==="object"&&qn(this.serialize(s.defaultValue),this.serialize(u))){continue}var c=e.toAsnItem(s,a,n,u);if(typeof s.context==="number"){if(s.implicit){if(!s.repeated&&(typeof s.type==="number"||Pn(s.type))){var l={};l.valueHex=c.valueBlock.toBER();o.push(new un(Object.assign({optional:s.optional,idBlock:{tagClass:3,tagNumber:s.context}},l)))}else{o.push(new sn({optional:s.optional,idBlock:{tagClass:3,tagNumber:s.context},value:c.valueBlock.value}))}}else{o.push(new sn({optional:s.optional,idBlock:{tagClass:3,tagNumber:s.context},value:[c]}))}}else if(s.repeated){o=o.concat(c)}else{o.push(c)}}}var f;switch(i.type){case Xn.Sequence:f=new nn({value:o});break;case Xn.Set:f=new rn({value:o});break;case Xn.Choice:if(!o[0]){throw new Error("Schema '"+n.name+"' has wrong data. Choice cannot be empty.")}f=o[0];break}return f};e.toAsnItem=function(e,t,r,n){var i=this;var o;if(typeof e.type==="number"){var a=e.converter;if(!a){throw new Error("Property '"+t+"' doesn't have converter for type "+Rn[e.type]+" in schema '"+r.name+"'")}if(e.repeated){var s=Array.from(n,(function(e){return a.toASN(e)}));var u=e.repeated==="sequence"?nn:rn;o=new u({value:s})}else{o=a.toASN(n)}}else{if(e.repeated){var s=Array.from(n,(function(e){return i.toASN(e)}));var u=e.repeated==="sequence"?nn:rn;o=new u({value:s})}else{o=this.toASN(n)}}return o};return e}();var Gn=function(e){__extends(t,e);function t(t,r){var n=e.call(this,r?t+". See the inner exception for more details.":t)||this;n.message=t;n.innerError=r;return n}return t}(Error);var zn=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Gn);var Wn;(function(e){e[e["Any"]=0]="Any";e[e["Boolean"]=1]="Boolean";e[e["Number"]=2]="Number";e[e["String"]=3]="String"})(Wn||(Wn={}));function Yn(e,t){switch(t){case Wn.Boolean:return typeof e==="boolean";case Wn.Number:return typeof e==="number";case Wn.String:return typeof e==="string"}return true}function Zn(e,t){if(!Yn(e,t)){throw new TypeError("Value must be "+Wn[t])}}function $n(e){if(e&&e.prototype){if(e.prototype.toJSON&&e.prototype.fromJSON){return true}else{return $n(e.prototype)}}else{return!!(e&&e.toJSON&&e.fromJSON)}}var Qn=function(){function e(){this.items=new Map}e.prototype.has=function(e){return this.items.has(e)||!!this.findParentSchema(e)};e.prototype.get=function(e){var t=this.items.get(e)||this.findParentSchema(e);if(!t){throw new Error("Cannot get schema for current target")}return t};e.prototype.create=function(e){var t={names:{}};var r=this.findParentSchema(e);if(r){Object.assign(t,r);t.names={};for(var n in r.names){t.names[n]=Object.assign({},r.names[n])}}t.target=e;return t};e.prototype.set=function(e,t){this.items.set(e,t);return this};e.prototype.findParentSchema=function(e){var t=e.__proto__;if(t){var r=this.items.get(t);return r||this.findParentSchema(t)}return null};return e}();var ei="default";var ti=new Qn;var ri=function(){function e(e){this.pattern=new RegExp(e)}e.prototype.validate=function(e){var t=new RegExp(this.pattern.source,this.pattern.flags);if(typeof e!=="string"){throw new zn("Incoming value must be string")}if(!t.exec(e)){throw new zn("Value doesn't match to pattern '"+t.toString()+"'")}};return e}();var ni=function(){function e(e,t){if(e===void 0){e=Number.MIN_VALUE}if(t===void 0){t=Number.MAX_VALUE}this.min=e;this.max=t}e.prototype.validate=function(e){Zn(e,Wn.Number);if(!(this.min<=e&&e<=this.max)){var t=this.min===Number.MIN_VALUE?"MIN":this.min;var r=this.max===Number.MAX_VALUE?"MAX":this.max;throw new zn("Value doesn't match to diapason ["+t+","+r+"]")}};return e}();var ii=function(){function e(e,t){if(e===void 0){e=Number.MIN_VALUE}if(t===void 0){t=Number.MAX_VALUE}this.min=e;this.max=t}e.prototype.validate=function(e){Zn(e,Wn.Number);if(!(this.min<e&&e<this.max)){var t=this.min===Number.MIN_VALUE?"MIN":this.min;var r=this.max===Number.MAX_VALUE?"MAX":this.max;throw new zn("Value doesn't match to diapason ("+t+","+r+")")}};return e}();var oi=function(){function e(e,t,r){this.length=e;this.minLength=t;this.maxLength=r}e.prototype.validate=function(e){if(this.length!==undefined){if(e.length!==this.length){throw new zn("Value length must be exactly "+this.length+".")}return}if(this.minLength!==undefined){if(e.length<this.minLength){throw new zn("Value length must be more than "+this.minLength+".")}}if(this.maxLength!==undefined){if(e.length>this.maxLength){throw new zn("Value length must be less than "+this.maxLength+".")}}};return e}();var ai=function(){function e(e){this.enumeration=e}e.prototype.validate=function(e){Zn(e,Wn.String);if(!this.enumeration.includes(e)){throw new zn("Value must be one of "+this.enumeration.map((function(e){return"'"+e+"'"})).join(", "))}};return e}();function si(e){var t=[];if(e.pattern){t.push(new ri(e.pattern))}if(e.type===Wn.Number||e.type===Wn.Any){if(e.minInclusive!==undefined||e.maxInclusive!==undefined){t.push(new ni(e.minInclusive,e.maxInclusive))}if(e.minExclusive!==undefined||e.maxExclusive!==undefined){t.push(new ii(e.minExclusive,e.maxExclusive))}if(e.enumeration!==undefined){t.push(new ai(e.enumeration))}}if(e.type===Wn.String||e.repeated||e.type===Wn.Any){if(e.length!==undefined||e.minLength!==undefined||e.maxLength!==undefined){t.push(new oi(e.length,e.minLength,e.maxLength))}}return t}var ui=function(e){if(e===void 0){e={}}return function(t,r){var n="Cannot set type for "+r+" property of "+t.constructor.name+" schema";var i;if(!ti.has(t.constructor)){i=ti.create(t.constructor);ti.set(t.constructor,i)}else{i=ti.get(t.constructor);if(i.target!==t.constructor){i=ti.create(t.constructor);ti.set(t.constructor,i)}}var o={type:Wn.Any,validations:[]};var a=Object.assign(o,e);a.validations=si(a);if(typeof a.type!=="number"){if(!ti.has(a.type)&&!$n(a.type)){throw new Error(n+". Assigning type doesn't have schema.")}}var s;if(Array.isArray(e.schema)){s=e.schema}else{s=[e.schema||ei]}for(var u=0,c=s;u<c.length;u++){var l=c[u];if(!i.names[l]){i.names[l]={}}var f=i.names[l];f[r]=a}}};var ci=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(Error);var li=function(){function e(){}e.toArrayBuffer=function(e){var t=e.replace(/-{5}(BEGIN|END) .*-{5}/g,"").replace("\r","").replace("\n","");return o.FromBase64(t)};e.toUint8Array=function(e){var t=this.toArrayBuffer(e);return new Uint8Array(t)};e.fromBufferSource=function(e,t){var r=o.ToBase64(e);var n;var i=0;var a=[];while(true){n=r.slice(i,i=i+64);if(n.length){a.push(n);if(n.length<64){break}}else{break}}var s=t.toUpperCase();return"-----BEGIN "+s+"-----\n"+a.join("\n")+"\n-----END "+s+"-----"};e.isPEM=function(e){return/-----BEGIN .+-----[A-Za-z0-9+\/\+\=\s\n]+-----END .+-----/i.test(e)};e.getTagName=function(e){if(!this.isPEM(e)){throw new Error("Bad parameter. Incoming data is not right PEM")}var t=/-----BEGIN (.+)-----/.exec(e);if(!t){throw new Error("Cannot get tag from PEM")}return t[1]};e.hasTagName=function(e,t){var r=this.getTagName(e);return t.toLowerCase()===r.toLowerCase()};e.isCertificate=function(e){return this.hasTagName(e,"certificate")};e.isCertificateRequest=function(e){return this.hasTagName(e,"certificate request")};e.isCRL=function(e){return this.hasTagName(e,"x509 crl")};e.isPublicKey=function(e){return this.hasTagName(e,"public key")};return e}();var fi=function(){function e(e){if(e){this.value=e}}return e}();Wt([Fn({type:Rn.ObjectIdentifier})],fi.prototype,"value",void 0);fi=Wt([Jn({type:Xn.Choice})],fi);var hi=function(){function e(e){Object.assign(this,e)}return e}();Wt([Fn({type:Rn.ObjectIdentifier})],hi.prototype,"algorithm",void 0);Wt([Fn({type:Rn.Any,optional:true})],hi.prototype,"parameters",void 0);var vi=function(){function e(){this.version=0;this.privateKeyAlgorithm=new hi;this.privateKey=new ArrayBuffer(0)}return e}();Wt([Fn({type:Rn.Integer})],vi.prototype,"version",void 0);Wt([Fn({type:hi})],vi.prototype,"privateKeyAlgorithm",void 0);Wt([Fn({type:Rn.OctetString})],vi.prototype,"privateKey",void 0);Wt([Fn({type:Rn.Any,optional:true})],vi.prototype,"attributes",void 0);var pi=function(){function e(){this.publicKeyAlgorithm=new hi;this.publicKey=new ArrayBuffer(0)}return e}();Wt([Fn({type:hi})],pi.prototype,"publicKeyAlgorithm",void 0);Wt([Fn({type:Rn.BitString})],pi.prototype,"publicKey",void 0);var di={fromJSON:function(e){return o.FromBase64Url(e)},toJSON:function(e){return o.ToBase64Url(new Uint8Array(e))}};var yi={fromASN:function(e){var t=e.valueBlock.valueHex;return!new Uint8Array(t)[0]?e.valueBlock.valueHex.slice(1):e.valueBlock.valueHex},toASN:function(e){var t=new Uint8Array(e)[0]>127?Buffer.concat([Buffer.from([0]),Buffer.from(e)]):Buffer.from(e);return new $r({valueHex:new Uint8Array(t).buffer})}};var gi=Object.freeze({__proto__:null,JsonBase64UrlArrayBufferConverter:di,AsnIntegerArrayBufferConverter:yi});var mi=function(){function e(){this.version=0;this.modulus=new ArrayBuffer(0);this.publicExponent=new ArrayBuffer(0);this.privateExponent=new ArrayBuffer(0);this.prime1=new ArrayBuffer(0);this.prime2=new ArrayBuffer(0);this.exponent1=new ArrayBuffer(0);this.exponent2=new ArrayBuffer(0);this.coefficient=new ArrayBuffer(0)}return e}();Wt([Fn({type:Rn.Integer,converter:pn})],mi.prototype,"version",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"n",converter:di})],mi.prototype,"modulus",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"e",converter:di})],mi.prototype,"publicExponent",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"d",converter:di})],mi.prototype,"privateExponent",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"p",converter:di})],mi.prototype,"prime1",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"q",converter:di})],mi.prototype,"prime2",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"dp",converter:di})],mi.prototype,"exponent1",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"dq",converter:di})],mi.prototype,"exponent2",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"qi",converter:di})],mi.prototype,"coefficient",void 0);Wt([Fn({type:Rn.Any,optional:true})],mi.prototype,"otherPrimeInfos",void 0);var bi=function(){function e(){this.modulus=new ArrayBuffer(0);this.publicExponent=new ArrayBuffer(0)}return e}();Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"n",converter:di})],bi.prototype,"modulus",void 0);Wt([Fn({type:Rn.Integer,converter:yi}),ui({name:"e",converter:di})],bi.prototype,"publicExponent",void 0);var wi=function(){function e(e){this.value=new ArrayBuffer(0);if(e){this.value=e}}e.prototype.toJSON=function(){var e=new Uint8Array(this.value);if(e[0]!==4){throw new ci("Wrong ECPoint. Current version supports only Uncompressed (0x04) point")}e=new Uint8Array(this.value.slice(1));var t=e.length/2;var r=0;var n={x:o.ToBase64Url(e.buffer.slice(r,r+t)),y:o.ToBase64Url(e.buffer.slice(r+t,r+t+t))};return n};e.prototype.fromJSON=function(e){if(!("x"in e)){throw new Error("x: Missing required property")}if(!("y"in e)){throw new Error("y: Missing required property")}var t=o.FromBase64Url(e.x);var r=o.FromBase64Url(e.y);var n=Buffer.concat([new Uint8Array([4]),new Uint8Array(t),new Uint8Array(r)]);this.value=new Uint8Array(n).buffer;return this};return e}();Wt([Fn({type:Rn.OctetString})],wi.prototype,"value",void 0);wi=Wt([Jn({type:Xn.Choice})],wi);var ki=function(){function e(){this.version=1;this.privateKey=new ArrayBuffer(0)}e.prototype.fromJSON=function(e){if(!("d"in e)){throw new Error("d: Missing required property")}this.privateKey=o.FromBase64Url(e.d);if("x"in e){var t=new wi;t.fromJSON(e);this.publicKey=Mn.toASN(t).valueBlock.valueHex}return this};e.prototype.toJSON=function(){var e={};e.d=o.ToBase64Url(this.privateKey);if(this.publicKey){Object.assign(e,new wi(this.publicKey).toJSON())}return e};return e}();Wt([Fn({type:Rn.Integer,converter:pn})],ki.prototype,"version",void 0);Wt([Fn({type:Rn.OctetString})],ki.prototype,"privateKey",void 0);Wt([Fn({context:0,type:Rn.Any,optional:true})],ki.prototype,"parameters",void 0);Wt([Fn({context:1,type:Rn.BitString,optional:true})],ki.prototype,"publicKey",void 0);var Bi={fromASN:function(e){var t=new Uint8Array(e.valueBlock.valueHex);return t[0]===0?t.buffer.slice(1):t.buffer},toASN:function(e){var t=new Uint8Array(e);if(t[0]>127){var r=new Uint8Array(t.length+1);r.set(t,1);return new $r({valueHex:r.buffer})}return new $r({valueHex:e})}};var _i=Object.freeze({__proto__:null,AsnIntegerWithoutPaddingConverter:Bi});var Ni=function(){function e(){this.r=new ArrayBuffer(0);this.s=new ArrayBuffer(0)}e.fromWebCryptoSignature=function(e){var t=a.toUint8Array(e);var r=t.byteLength/2;var n=new this;n.r=n.removePadding(t.slice(0,r));n.s=n.removePadding(t.slice(r,r*2));return n};e.prototype.toWebCryptoSignature=function(e){e=this.getPointSize();var t=this.addPadding(e,a.toUint8Array(this.r));var r=this.addPadding(e,a.toUint8Array(this.s));var n=new Uint8Array(t.byteLength+r.byteLength);n.set(t,0);n.set(r,t.length);return n.buffer};e.prototype.getPointSize=function(){var e=Math.max(this.r.byteLength,this.s.byteLength);switch(e){case 31:case 32:return 32;case 47:case 48:return 48;case 65:case 66:return 66}throw new Error("Unsupported EC point size")};e.prototype.addPadding=function(e,t){var r=new Uint8Array(e);var n=a.toUint8Array(t);r.set(n,e-n.length);return r};e.prototype.removePadding=function(e){var t=a.toUint8Array(e);for(var r=0;r<t.length;r++){if(!t[r]){continue}return t.slice(r)}return new Uint8Array(0)};return e}();Wt([Fn({type:Rn.Integer,converter:Bi})],Ni.prototype,"r",void 0);Wt([Fn({type:Rn.Integer,converter:Bi})],Ni.prototype,"s",void 0);var Ei=Object.freeze({__proto__:null,converters:_i,get ObjectIdentifier(){return fi},AlgorithmIdentifier:hi,PrivateKeyInfo:vi,PublicKeyInfo:pi,RsaPrivateKey:mi,RsaPublicKey:bi,EcPrivateKey:ki,get EcPublicKey(){return wi},EcDsaSignature:Ni});var Ai=Object.freeze({__proto__:null,converters:gi});function Ii(e){return e}function Si(e){return e instanceof Object&&"name"in e&&"hash"in e}function xi(e){if(e instanceof Ne){return e}var t=new Ne;if(typeof e==="string"){t.fromAlgorithm({name:e})}else if(Si(e)){var r=Object.assign({},e);r.hash=xi(e.hash);t.fromAlgorithm(r)}else{t.fromAlgorithm(Object.assign({},e))}return t}function Di(e){return e instanceof Ae}function Ci(e){return e instanceof Ve}function Oi(e,t){if(!(e&&(typeof e==="object"||typeof e==="string"))){throw new TypeError(t+": Is wrong type. Must be Object or String")}if(typeof e==="object"&&!("name"in e)){throw new TypeError(t+": Required property 'name' is missed")}}function Ki(e,t){if(!Di(e)){throw new TypeError(t+": Is not type CryptoKey")}}function Ti(e,t){if(!Ci(e)){throw new TypeError(t+": Is not type CryptoCertificate")}}function Ui(e,t){if(!a.isBufferSource(e)){throw new TypeError(t+": Is wrong type. Must be ArrayBuffer or ArrayBuffer view")}}function Li(e,t){if(!Array.isArray(e)){throw new TypeError(t+": Is not type Array")}}function Hi(e,t,r){if(typeof e!==t){throw new TypeError(r+": Is not type '"+t+"'")}}var Xi=["raw","pem","x509","request"];var Ri=function(){function e(e){this.provider=e}e.isX509Certificate=function(e){return e instanceof Je};e.isCertificateRequest=function(e){return e instanceof Fe};e.prototype.indexOf=function(e){return me(this,void 0,void 0,(function(){var t,r;return __generator(this,(function(n){switch(n.label){case 0:Ti(e,"item");t=new tt;t.providerID=this.provider.id;t.item=e;return[4,this.provider.client.send(t)];case 1:r=n.sent();return[2,r?o.ToUtf8String(r):null]}}))}))};e.prototype.hasItem=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return[4,this.indexOf(e)];case 1:t=r.sent();return[2,!!t]}}))}))};e.prototype.exportCert=function(e,t){return me(this,void 0,void 0,(function(){var r,n,i,o;return __generator(this,(function(a){switch(a.label){case 0:Hi(e,"string","format");Ti(t,"item");r=new et;r.providerID=this.provider.id;r.format="raw";r.item=t;return[4,this.provider.client.send(r)];case 1:n=a.sent();if(e==="raw"){return[2,n]}else{i="";switch(t.type){case"x509":{i="CERTIFICATE";break}case"request":{i="CERTIFICATE REQUEST";break}default:throw new Error("Cannot create PEM for unknown type of certificate item")}o=li.fromBufferSource(n,i);return[2,o]}return[2]}}))}))};e.prototype.importCert=function(e,t,r,n){return me(this,void 0,void 0,(function(){var i,o,s,u,c;return __generator(this,(function(l){switch(l.label){case 0:Hi(e,"string","format");if(!~Xi.indexOf(e)){throw new TypeError("format: Is invalid value. Must be "+Xi.join(", "))}if(e==="pem"){Hi(t,"string","data")}else{Ui(t,"data")}Oi(r,"algorithm");Li(n,"keyUsages");i=xi(r);if(a.isBufferSource(t)){o=a.toArrayBuffer(t)}else if(typeof t==="string"){o=li.toArrayBuffer(t)}else{throw new TypeError("data: Is not type String, ArrayBuffer or ArrayBufferView")}s=new Qe;s.providerID=this.provider.id;s.format="raw";s.data=o;s.algorithm=i;s.keyUsages=n;return[4,this.provider.client.send(s)];case 1:u=l.sent();return[4,Ve.importProto(u)];case 2:c=l.sent();if((e==="request"||e==="x509")&&c.type!==e){throw new TypeError("Imported item is not "+e)}return[2,this.prepareCertItem(c)]}}))}))};e.prototype.keys=function(){return me(this,void 0,void 0,(function(){var e,t,r;return __generator(this,(function(n){switch(n.label){case 0:e=new Ye;e.providerID=this.provider.id;return[4,this.provider.client.send(e)];case 1:t=n.sent();if(t){r=o.ToUtf8String(t).split(",");return[2,r]}return[2,[]]}}))}))};e.prototype.getItem=function(e,t,r){return me(this,void 0,void 0,(function(){var n,i,o;return __generator(this,(function(a){switch(a.label){case 0:Hi(e,"string","key");if(t){Oi(t,"algorithm");Li(r,"keyUsages")}n=new We;n.providerID=this.provider.id;n.key=e;if(t){n.algorithm=xi(t);n.keyUsages=r}return[4,this.provider.client.send(n)];case 1:i=a.sent();if(!(i&&i.byteLength))return[3,3];return[4,Ve.importProto(i)];case 2:o=a.sent();return[2,this.prepareCertItem(o)];case 3:throw new Error("Cannot get CryptoCertificate from storage by index")}}))}))};e.prototype.setItem=function(e){return me(this,void 0,void 0,(function(){var t,r;return __generator(this,(function(n){switch(n.label){case 0:Ti(e,"value");t=new ze;t.providerID=this.provider.id;t.item=e;return[4,this.provider.client.send(t)];case 1:r=n.sent();return[2,o.ToUtf8String(r)]}}))}))};e.prototype.removeItem=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:Hi(e,"string","key");t=new Ze;t.providerID=this.provider.id;t.key=e;return[4,this.provider.client.send(t)];case 1:r.sent();return[2]}}))}))};e.prototype.clear=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:e=new $e;e.providerID=this.provider.id;return[4,this.provider.client.send(e)];case 1:t.sent();return[2]}}))}))};e.prototype.getChain=function(e){return me(this,void 0,void 0,(function(){var t,r,n;return __generator(this,(function(i){switch(i.label){case 0:Ti(e,"value");t=new rt;t.providerID=this.provider.id;t.item=e;return[4,this.provider.client.send(t)];case 1:r=i.sent();return[4,Ge.importProto(r)];case 2:n=i.sent();return[2,n.items]}}))}))};e.prototype.getCRL=function(e){return me(this,void 0,void 0,(function(){var t,r;return __generator(this,(function(n){switch(n.label){case 0:Hi(e,"string","url");t=new nt;t.providerID=this.provider.id;t.url=e;return[4,this.provider.client.send(t)];case 1:r=n.sent();return[2,r]}}))}))};e.prototype.getOCSP=function(e,t,r){return me(this,void 0,void 0,(function(){var n,i,o;return __generator(this,(function(s){switch(s.label){case 0:Hi(e,"string","url");Ui(t,"request");n=new ot;n.providerID=this.provider.id;n.url=e;n.request=a.toArrayBuffer(t);if(r){for(i in r){n.options[i]=r[i]}}return[4,this.provider.client.send(n)];case 1:o=s.sent();return[2,o]}}))}))};e.prototype.findPrivateKey=function(e){return me(this,void 0,void 0,(function(){var t,r,n,i,o;return __generator(this,(function(a){switch(a.label){case 0:if(!(typeof e==="string"))return[3,1];r=e;return[3,3];case 1:return[4,this.provider.certStorage.indexOf(e)];case 2:r=a.sent();a.label=3;case 3:t=r;if(!t){t=""}n=t.split("-"),i=n[2];return[4,this.provider.keyStorage.keys()];case 4:o=a.sent().find((function(e){var t=e.split("-"),r=t[0],n=t[2];return r==="private"&&n===i}));if(!o){return[2,null]}return[4,this.provider.keyStorage.getItem(o)];case 5:return[2,a.sent()]}}))}))};e.prototype.prepareCertItem=function(e){return me(this,void 0,void 0,(function(){var t,r,n;return __generator(this,(function(i){switch(i.label){case 0:return[4,e.exportProto()];case 1:t=i.sent();n=e.type;switch(n){case"x509":return[3,2];case"request":return[3,4]}return[3,6];case 2:return[4,Je.importProto(t)];case 3:r=i.sent();return[3,7];case 4:return[4,Fe.importProto(t)];case 5:r=i.sent();return[3,7];case 6:throw new Error("Unsupported CertificateItem type '"+e.type+"'");case 7:r.provider=this.provider;return[2,r]}}))}))};return e}();var Pi=function(){function e(e){this.service=e}e.prototype.keys=function(){return me(this,void 0,void 0,(function(){var e,t,r;return __generator(this,(function(n){switch(n.label){case 0:e=new ut;e.providerID=this.service.id;return[4,this.service.client.send(e)];case 1:t=n.sent();if(t){r=o.ToUtf8String(t).split(",");return[2,r]}return[2,[]]}}))}))};e.prototype.indexOf=function(e){return me(this,void 0,void 0,(function(){var t,r;return __generator(this,(function(n){switch(n.label){case 0:Ki(e,"item");t=new ft;t.providerID=this.service.id;t.item=e;return[4,this.service.client.send(t)];case 1:r=n.sent();return[2,r?o.ToUtf8String(r):null]}}))}))};e.prototype.hasItem=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return[4,this.indexOf(e)];case 1:t=r.sent();return[2,!!t]}}))}))};e.prototype.getItem=function(e,t,r,n){return me(this,void 0,void 0,(function(){var i,o,a;return __generator(this,(function(s){switch(s.label){case 0:Hi(e,"string","key");if(t){Oi(t,"algorithm");Hi(r,"boolean","extractable");Li(n,"usages")}i=new st;i.providerID=this.service.id;i.key=e;if(t){i.algorithm=xi(t);i.extractable=r;i.keyUsages=n}return[4,this.service.client.send(i)];case 1:o=s.sent();if(!(o&&o.byteLength))return[3,3];return[4,Ae.importProto(o)];case 2:a=s.sent();return[3,4];case 3:throw new Error("Cannot get CryptoKey from key storage by index");case 4:return[2,a]}}))}))};e.prototype.setItem=function(e){return me(this,void 0,void 0,(function(){var t,r;return __generator(this,(function(n){switch(n.label){case 0:Ki(e,"value");t=new at;t.providerID=this.service.id;t.item=e;return[4,this.service.client.send(t)];case 1:r=n.sent();return[2,o.ToUtf8String(r)]}}))}))};e.prototype.removeItem=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:Hi(e,"string","key");t=new ct;t.providerID=this.service.id;t.key=e;return[4,this.service.client.send(t)];case 1:r.sent();return[2]}}))}))};e.prototype.clear=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:e=new lt;e.providerID=this.service.id;return[4,this.service.client.send(e)];case 1:t.sent();return[2]}}))}))};return e}();var qi=function(){function e(e){this.service=e}e.prototype.encrypt=function(e,t,r){return me(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this.encryptData(e,t,r,"encrypt")]}))}))};e.prototype.decrypt=function(e,t,r){return me(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,this.encryptData(e,t,r,"decrypt")]}))}))};e.prototype.deriveBits=function(e,t,r){return me(this,void 0,void 0,(function(){var n,i,o,a;return __generator(this,(function(s){switch(s.label){case 0:Oi(e,"algorithm");Ki(t,"baseKey");Hi(r,"number","length");n=xi(e);Ki(n.public,"algorithm.public");i=n;return[4,Ii(n.public).exportProto()];case 1:i.public=s.sent();o=new Nt;o.providerID=this.service.id;o.algorithm=n;o.key=t;o.length=r;return[4,this.service.client.send(o)];case 2:a=s.sent();return[2,a]}}))}))};e.prototype.deriveKey=function(e,t,r,n,i){return me(this,void 0,void 0,(function(){var o,a,s,u,c;return __generator(this,(function(l){switch(l.label){case 0:Oi(e,"algorithm");Ki(t,"baseKey");Oi(r,"algorithm");Hi(n,"boolean","extractable");Li(i,"keyUsages");o=xi(e);Ki(o.public,"algorithm.public");a=o;return[4,Ii(o.public).exportProto()];case 1:a.public=l.sent();s=xi(r);u=new Et;u.providerID=this.service.id;u.algorithm=o;u.derivedKeyType.fromAlgorithm(s);u.key=t;u.extractable=n;u.usage=i;return[4,this.service.client.send(u)];case 2:c=l.sent();return[4,Ae.importProto(c)];case 3:return[2,l.sent()]}}))}))};e.prototype.digest=function(e,t){return me(this,void 0,void 0,(function(){return __generator(this,(function(r){return[2,j().crypto.subtle.digest(e,t)]}))}))};e.prototype.generateKey=function(e,t,r){return me(this,void 0,void 0,(function(){var n,i,o,a,s,u;return __generator(this,(function(c){switch(c.label){case 0:Oi(e,"algorithm");Hi(t,"boolean","extractable");Li(r,"keyUsages");n=xi(e);i=new bt;i.providerID=this.service.id;i.algorithm=n;i.extractable=t;i.usage=r;return[4,this.service.client.send(i)];case 1:o=c.sent();c.label=2;case 2:c.trys.push([2,4,,6]);return[4,Ie.importProto(o)];case 3:a=c.sent();return[2,a];case 4:s=c.sent();return[4,Ae.importProto(o)];case 5:u=c.sent();return[2,u];case 6:return[2]}}))}))};e.prototype.exportKey=function(e,t){return me(this,void 0,void 0,(function(){var r,n;return __generator(this,(function(i){switch(i.label){case 0:Hi(e,"string","format");Ki(t,"key");r=new St;r.providerID=this.service.id;r.format=e;r.key=t;return[4,this.service.client.send(r)];case 1:n=i.sent();if(e==="jwk"){return[2,JSON.parse(o.ToBinary(n))]}else{return[2,n]}return[2]}}))}))};e.prototype.importKey=function(e,t,r,n,i){return me(this,void 0,void 0,(function(){var s,u,c,l;return __generator(this,(function(f){switch(f.label){case 0:Hi(e,"string","format");Oi(r,"algorithm");Hi(n,"boolean","extractable");Li(i,"keyUsages");s=xi(r);if(e==="jwk"){u=o.FromUtf8String(JSON.stringify(t))}else{Ui(t,"keyData");u=a.toArrayBuffer(t)}c=new xt;c.providerID=this.service.id;c.algorithm=s;c.keyData=u;c.format=e;c.extractable=n;c.keyUsages=i;return[4,this.service.client.send(c)];case 1:l=f.sent();return[4,Ae.importProto(l)];case 2:return[2,f.sent()]}}))}))};e.prototype.sign=function(e,t,r){return me(this,void 0,void 0,(function(){var n,i,o,s;return __generator(this,(function(u){switch(u.label){case 0:Oi(e,"algorithm");Ki(t,"key");Ui(r,"data");n=xi(e);i=a.toArrayBuffer(r);o=new wt;o.providerID=this.service.id;o.algorithm=n;o.key=t;o.data=i;return[4,this.service.client.send(o)];case 1:s=u.sent();return[2,s]}}))}))};e.prototype.verify=function(e,t,r,n){return me(this,void 0,void 0,(function(){var i,o,s,u,c;return __generator(this,(function(l){switch(l.label){case 0:Oi(e,"algorithm");Ki(t,"key");Ui(r,"signature");Ui(n,"data");i=xi(e);o=a.toArrayBuffer(r);s=a.toArrayBuffer(n);u=new kt;u.providerID=this.service.id;u.algorithm=i;u.key=t;u.data=s;u.signature=o;return[4,this.service.client.send(u)];case 1:c=l.sent();return[2,!!new Uint8Array(c)[0]]}}))}))};e.prototype.wrapKey=function(e,t,r,n){return me(this,void 0,void 0,(function(){var i,o,a;return __generator(this,(function(s){switch(s.label){case 0:Hi(e,"string","format");Ki(t,"key");Ki(r,"wrappingKey");Oi(n,"wrapAlgorithm");i=xi(n);o=new It;o.providerID=this.service.id;o.wrapAlgorithm=i;o.key=t;o.wrappingKey=r;o.format=e;return[4,this.service.client.send(o)];case 1:a=s.sent();return[2,a]}}))}))};e.prototype.unwrapKey=function(e,t,r,n,i,o,s){return me(this,void 0,void 0,(function(){var u,c,l,f,h;return __generator(this,(function(v){switch(v.label){case 0:Hi(e,"string","format");Ui(t,"wrappedKey");Ki(r,"unwrappingKey");Oi(n,"unwrapAlgorithm");Oi(i,"unwrappedKeyAlgorithm");Hi(o,"boolean","extractable");Li(s,"keyUsages");u=xi(n);c=xi(i);l=a.toArrayBuffer(t);f=new At;f.providerID=this.service.id;f.format=e;f.unwrapAlgorithm=u;f.unwrappedKeyAlgorithm=c;f.unwrappingKey=r;f.wrappedKey=l;f.extractable=o;f.keyUsage=s;return[4,this.service.client.send(f)];case 1:h=v.sent();return[4,Ae.importProto(h)];case 2:return[2,v.sent()]}}))}))};e.prototype.encryptData=function(e,t,r,n){return me(this,void 0,void 0,(function(){var i,o,s,u,c;return __generator(this,(function(l){switch(l.label){case 0:Oi(e,"algorithm");Ki(t,"key");Ui(r,"data");i=xi(e);o=a.toArrayBuffer(r);if(n==="encrypt"){s=Bt}else{s=_t}u=new s;u.providerID=this.service.id;u.algorithm=i;u.key=t;u.data=o;return[4,this.service.client.send(u)];case 1:c=l.sent();return[2,c]}}))}))};return e}();var ji=function(){function e(e,t){this.client=e;this.id=t;this.subtle=new qi(this);this.keyStorage=new Pi(this);this.certStorage=new Ri(this)}e.prototype.getRandomValues=function(e){return j().crypto.getRandomValues(e)};e.prototype.login=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){e=new Re;e.providerID=this.id;return[2,this.client.send(e)]}))}))};e.prototype.logout=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){e=new Pe;e.providerID=this.id;return[2,this.client.send(e)]}))}))};e.prototype.reset=function(){return me(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){e=new je;e.providerID=this.id;return[2,this.client.send(e)]}))}))};e.prototype.isLoggedIn=function(){return me(this,void 0,void 0,(function(){var e,t;return __generator(this,(function(r){switch(r.label){case 0:e=new qe;e.providerID=this.id;return[4,this.client.send(e)];case 1:t=r.sent();return[2,!!new Uint8Array(t)[0]]}}))}))};return e}();var Vi=function(){var e=function(e){__extends(t,e);function t(t){var r=e.call(this)||this;r.client=new zt(t.storage);r.cardReader=new Dt(r.client);return r}Object.defineProperty(t.prototype,"state",{get:function(){return this.client.state},enumerable:true,configurable:true});t.prototype.connect=function(e,r){var n=this;if(e===void 0){e=t.FORTIFY}this.removeAllListeners();this.client.connect(e,r).on("error",(function(e){n.emit("error",e.error)})).on("event",(function(e){(function(){return me(n,void 0,void 0,(function(){var t,r,n,i,o,a,s;return __generator(this,(function(u){switch(u.label){case 0:t=e.action;switch(t){case gt.ACTION:return[3,1];case yt.ACTION:return[3,4]}return[3,7];case 1:i=(n=gt).importProto;return[4,e.exportProto()];case 2:return[4,i.apply(n,[u.sent()])];case 3:r=u.sent();this.emit("token",r);u.label=4;case 4:s=(a=yt).importProto;return[4,e.exportProto()];case 5:return[4,s.apply(a,[u.sent()])];case 6:o=u.sent();this.emit("auth",o);u.label=7;case 7:return[2]}}))}))})()})).on("listening",(function(t){n.emit("listening",e)})).on("close",(function(e){n.emit("close",e.remoteAddress)}));return this};t.prototype.close=function(){this.client.close()};t.prototype.on=function(t,r){console.log("SocketProvider:on",t);return e.prototype.on.call(this,t,r)};t.prototype.once=function(t,r){return e.prototype.once.call(this,t,r)};t.prototype.info=function(){return me(this,void 0,void 0,(function(){var e,t,r;return __generator(this,(function(n){switch(n.label){case 0:e=new pt;return[4,this.client.send(e)];case 1:t=n.sent();return[4,vt.importProto(t)];case 2:r=n.sent();return[2,r]}}))}))};t.prototype.challenge=function(){return me(this,void 0,void 0,(function(){return __generator(this,(function(e){return[2,this.client.challenge()]}))}))};t.prototype.isLoggedIn=function(){return me(this,void 0,void 0,(function(){return __generator(this,(function(e){return[2,this.client.isLoggedIn()]}))}))};t.prototype.login=function(){return me(this,void 0,void 0,(function(){return __generator(this,(function(e){return[2,this.client.login()]}))}))};t.prototype.getCrypto=function(e){return me(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:t=new dt;t.cryptoID=e;return[4,this.client.send(t)];case 1:r.sent();return[2,new ji(this.client,e)]}}))}))};return t}(g);e.FORTIFY="127.0.0.1:31337";return e}();var Ji=function(){function e(){}return e}();var Fi=Zt((function(e){(function(){function t(e){return Array.prototype.slice.call(e)}function r(e){return new Promise((function(t,r){e.onsuccess=function(){t(e.result)};e.onerror=function(){r(e.error)}}))}function n(e,t,n){var i;var o=new Promise((function(o,a){i=e[t].apply(e,n);r(i).then(o,a)}));o.request=i;return o}function i(e,t,r){var i=n(e,t,r);return i.then((function(e){if(!e)return;return new l(e,i.request)}))}function o(e,t,r){r.forEach((function(r){Object.defineProperty(e.prototype,r,{get:function(){return this[t][r]},set:function(e){this[t][r]=e}})}))}function a(e,t,r,i){i.forEach((function(i){if(!(i in r.prototype))return;e.prototype[i]=function(){return n(this[t],i,arguments)}}))}function s(e,t,r,n){n.forEach((function(n){if(!(n in r.prototype))return;e.prototype[n]=function(){return this[t][n].apply(this[t],arguments)}}))}function u(e,t,r,n){n.forEach((function(n){if(!(n in r.prototype))return;e.prototype[n]=function(){return i(this[t],n,arguments)}}))}function c(e){this._index=e}o(c,"_index",["name","keyPath","multiEntry","unique"]);a(c,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]);u(c,"_index",IDBIndex,["openCursor","openKeyCursor"]);function l(e,t){this._cursor=e;this._request=t}o(l,"_cursor",["direction","key","primaryKey","value"]);a(l,"_cursor",IDBCursor,["update","delete"]);["advance","continue","continuePrimaryKey"].forEach((function(e){if(!(e in IDBCursor.prototype))return;l.prototype[e]=function(){var t=this;var n=arguments;return Promise.resolve().then((function(){t._cursor[e].apply(t._cursor,n);return r(t._request).then((function(e){if(!e)return;return new l(e,t._request)}))}))}}));function f(e){this._store=e}f.prototype.createIndex=function(){return new c(this._store.createIndex.apply(this._store,arguments))};f.prototype.index=function(){return new c(this._store.index.apply(this._store,arguments))};o(f,"_store",["name","keyPath","indexNames","autoIncrement"]);a(f,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]);u(f,"_store",IDBObjectStore,["openCursor","openKeyCursor"]);s(f,"_store",IDBObjectStore,["deleteIndex"]);function h(e){this._tx=e;this.complete=new Promise((function(t,r){e.oncomplete=function(){t()};e.onerror=function(){r(e.error)};e.onabort=function(){r(e.error)}}))}h.prototype.objectStore=function(){return new f(this._tx.objectStore.apply(this._tx,arguments))};o(h,"_tx",["objectStoreNames","mode"]);s(h,"_tx",IDBTransaction,["abort"]);function v(e,t,r){this._db=e;this.oldVersion=t;this.transaction=new h(r)}v.prototype.createObjectStore=function(){return new f(this._db.createObjectStore.apply(this._db,arguments))};o(v,"_db",["name","version","objectStoreNames"]);s(v,"_db",IDBDatabase,["deleteObjectStore","close"]);function p(e){this._db=e}p.prototype.transaction=function(){return new h(this._db.transaction.apply(this._db,arguments))};o(p,"_db",["name","version","objectStoreNames"]);s(p,"_db",IDBDatabase,["close"]);["openCursor","openKeyCursor"].forEach((function(e){[f,c].forEach((function(r){if(!(e in r.prototype))return;r.prototype[e.replace("open","iterate")]=function(){var r=t(arguments);var n=r[r.length-1];var i=this._store||this._index;var o=i[e].apply(i,r.slice(0,-1));o.onsuccess=function(){n(o.result)}}}))}));[c,f].forEach((function(e){if(e.prototype.getAll)return;e.prototype.getAll=function(e,t){var r=this;var n=[];return new Promise((function(i){r.iterateCursor(e,(function(e){if(!e){i(n);return}n.push(e.value);if(t!==undefined&&n.length==t){i(n);return}e.continue()}))}))}}));var d={open:function(e,t,r){var i=n(indexedDB,"open",[e,t]);var o=i.request;if(o){o.onupgradeneeded=function(e){if(r){r(new v(o.result,e.oldVersion,o.transaction))}}}return i.then((function(e){return new p(e)}))},delete:function(e){return n(indexedDB,"deleteDatabase",[e])}};{e.exports=d;e.exports.default=e.exports}})()}));var Mi=Zt((function(e){if(typeof indexedDB!="undefined"){e.exports=Fi}else{e.exports={open:function(){return Promise.reject("IDB requires a browser environment")},delete:function(){return Promise.reject("IDB requires a browser environment")}}}}));var Gi=function(){var e=function(e){__extends(t,e);function t(t){var r=e.call(this)||this;r.db=t;return r}t.create=function(){return me(this,void 0,void 0,(function(){var e;var r=this;return __generator(this,(function(n){switch(n.label){case 0:return[4,Mi.open(this.STORAGE_NAME,2,(function(e){if(e.oldVersion===1){e.deleteObjectStore(r.SESSION_STORAGE);e.deleteObjectStore(r.IDENTITY_STORAGE);e.deleteObjectStore(r.REMOTE_STORAGE)}e.createObjectStore(r.SESSION_STORAGE);e.createObjectStore(r.IDENTITY_STORAGE);e.createObjectStore(r.REMOTE_STORAGE)}))];case 1:e=n.sent();return[2,new t(e)]}}))}))};t.prototype.loadWrapKey=function(){return me(this,void 0,void 0,(function(){var e,r;return __generator(this,(function(n){switch(n.label){case 0:return[4,this.db.transaction(t.IDENTITY_STORAGE).objectStore(t.IDENTITY_STORAGE).get(t.WRAP_KEY)];case 1:e=n.sent();if(!e)return[3,4];Jt.iv=e.iv;if(!(e.key instanceof ArrayBuffer))return[3,3];return[4,j().crypto.subtle.importKey("raw",e.key,{name:Jt.name,length:256},true,["encrypt","decrypt","wrapKey","unwrapKey"])];case 2:r=n.sent();return[2,{key:r,iv:e.iv}];case 3:return[2,{key:e.key,iv:e.iv}];case 4:return[2,null]}}))}))};t.prototype.saveWrapKey=function(e){return me(this,void 0,void 0,(function(){var r,n;return __generator(this,(function(i){switch(i.label){case 0:if(!(Pt()||qt()))return[3,2];return[4,j().crypto.subtle.exportKey("raw",e.key)];case 1:n=i.sent();r={key:n,iv:e.iv};return[3,3];case 2:r=Object.assign({},e);i.label=3;case 3:return[4,this.db.transaction(t.IDENTITY_STORAGE,"readwrite").objectStore(t.IDENTITY_STORAGE).put(r,t.WRAP_KEY)];case 4:i.sent();return[2]}}))}))};t.prototype.loadIdentity=function(){return me(this,void 0,void 0,(function(){var e,r,n,i,o,a,s;return __generator(this,(function(u){switch(u.label){case 0:return[4,this.db.transaction(t.IDENTITY_STORAGE).objectStore(t.IDENTITY_STORAGE).get(t.IDENTITY)];case 1:e=u.sent();r=null;if(!e)return[3,9];if(!(Rt()||Pt()||qt()))return[3,7];return[4,this.loadWrapKey()];case 2:n=u.sent();if(!(n&&n.key.usages.some((function(e){return e==="encrypt"}))&&e.exchangeKey.privateKey instanceof ArrayBuffer)){return[2,null]}i=e.exchangeKey;return[4,j().crypto.subtle.unwrapKey("jwk",e.exchangeKey.privateKey,n.key,Jt,jt,false,["deriveKey","deriveBits"])];case 3:i.privateKey=u.sent();o=e.signingKey;return[4,j().crypto.subtle.unwrapKey("jwk",e.signingKey.privateKey,n.key,Jt,Vt,false,["sign"])];case 4:o.privateKey=u.sent();a=e.exchangeKey;return[4,j().crypto.subtle.unwrapKey("jwk",e.exchangeKey.publicKey,n.key,Jt,jt,true,[])];case 5:a.publicKey=u.sent();s=e.signingKey;return[4,j().crypto.subtle.unwrapKey("jwk",e.signingKey.publicKey,n.key,Jt,Vt,true,["verify"])];case 6:s.publicKey=u.sent();u.label=7;case 7:return[4,G.fromJSON(e)];case 8:r=u.sent();u.label=9;case 9:return[2,r]}}))}))};t.prototype.saveIdentity=function(e){return me(this,void 0,void 0,(function(){var r,n,i,o,a,s,u,c,l;return __generator(this,(function(f){switch(f.label){case 0:if(!(Rt()||Pt()||qt()))return[3,7];n={};return[4,j().crypto.subtle.generateKey({name:Jt.name,length:256},Pt()||qt(),["wrapKey","unwrapKey","encrypt","decrypt"])];case 1:r=(n.key=f.sent(),n.iv=j().crypto.getRandomValues(new Uint8Array(Jt.iv)).buffer,n);return[4,this.saveWrapKey(r)];case 2:f.sent();return[4,j().crypto.subtle.generateKey(e.exchangeKey.privateKey.algorithm,true,["deriveKey","deriveBits"])];case 3:i=f.sent();e.exchangeKey.privateKey=i.privateKey;return[4,Mt(e.exchangeKey.publicKey,i.publicKey)];case 4:f.sent();return[4,j().crypto.subtle.generateKey(e.signingKey.privateKey.algorithm,true,["sign","verify"])];case 5:o=f.sent();e.signingKey.privateKey=o.privateKey;return[4,Mt(e.signingKey.publicKey,o.publicKey)];case 6:f.sent();f.label=7;case 7:return[4,e.toJSON()];case 8:a=f.sent();if(!r)return[3,13];s=a.exchangeKey;return[4,j().crypto.subtle.wrapKey("jwk",e.exchangeKey.privateKey,r.key,Jt)];case 9:s.privateKey=f.sent();u=a.signingKey;return[4,j().crypto.subtle.wrapKey("jwk",e.signingKey.privateKey,r.key,Jt)];case 10:u.privateKey=f.sent();c=a.exchangeKey;return[4,j().crypto.subtle.wrapKey("jwk",e.exchangeKey.publicKey.key,r.key,Jt)];case 11:c.publicKey=f.sent();l=a.signingKey;return[4,j().crypto.subtle.wrapKey("jwk",e.signingKey.publicKey.key,r.key,Jt)];case 12:l.publicKey=f.sent();f.label=13;case 13:return[4,this.db.transaction(t.IDENTITY_STORAGE,"readwrite").objectStore(t.IDENTITY_STORAGE).put(a,t.IDENTITY)];case 14:f.sent();return[2]}}))}))};t.prototype.loadRemoteIdentity=function(e){return me(this,void 0,void 0,(function(){var r,n,i,o,a;return __generator(this,(function(s){switch(s.label){case 0:return[4,this.db.transaction(t.REMOTE_STORAGE).objectStore(t.REMOTE_STORAGE).get(e)];case 1:r=s.sent();n=null;if(!r)return[3,7];return[4,this.loadWrapKey()];case 2:i=s.sent();if(!i)return[3,5];o=r;return[4,j().crypto.subtle.unwrapKey("jwk",r.exchangeKey,i.key,Jt,jt,true,[])];case 3:o.exchangeKey=s.sent();a=r;return[4,j().crypto.subtle.unwrapKey("jwk",r.signingKey,i.key,Jt,Vt,true,["verify"])];case 4:a.signingKey=s.sent();s.label=5;case 5:return[4,z.fromJSON(r)];case 6:n=s.sent();s.label=7;case 7:return[2,n]}}))}))};t.prototype.saveRemoteIdentity=function(e,r){return me(this,void 0,void 0,(function(){var n,i,o,a;return __generator(this,(function(s){switch(s.label){case 0:return[4,r.toJSON()];case 1:n=s.sent();return[4,this.loadWrapKey()];case 2:i=s.sent();if(!i)return[3,5];o=n;return[4,j().crypto.subtle.wrapKey("jwk",n.exchangeKey,i.key,Jt)];case 3:o.exchangeKey=s.sent();a=n;return[4,j().crypto.subtle.wrapKey("jwk",n.signingKey,i.key,Jt)];case 4:a.signingKey=s.sent();s.label=5;case 5:return[4,this.db.transaction(t.REMOTE_STORAGE,"readwrite").objectStore(t.REMOTE_STORAGE).put(n,e)];case 6:s.sent();return[2]}}))}))};t.prototype.loadSession=function(e){return me(this,void 0,void 0,(function(){var r,n,i,o;return __generator(this,(function(a){switch(a.label){case 0:return[4,this.db.transaction(t.SESSION_STORAGE).objectStore(t.SESSION_STORAGE).get(e)];case 1:r=a.sent();n=null;if(!r)return[3,5];return[4,this.loadIdentity()];case 2:i=a.sent();if(!i){throw new Error("Identity is empty")}return[4,this.loadRemoteIdentity(e)];case 3:o=a.sent();if(!o){throw new Error("Remote identity is not found")}return[4,pe.fromJSON(i,o,r)];case 4:n=a.sent();a.label=5;case 5:return[2,n]}}))}))};t.prototype.saveSession=function(e,r){return me(this,void 0,void 0,(function(){var n;return __generator(this,(function(i){switch(i.label){case 0:return[4,r.toJSON()];case 1:n=i.sent();return[4,this.db.transaction(t.SESSION_STORAGE,"readwrite").objectStore(t.SESSION_STORAGE).put(n,e)];case 2:i.sent();return[2]}}))}))};return t}(Ji);e.STORAGE_NAME="webcrypto-remote";e.IDENTITY_STORAGE="identity";e.SESSION_STORAGE="sessions";e.REMOTE_STORAGE="remoteIdentity";e.WRAP_KEY="wkey";e.IDENTITY="identity";return e}();var zi=function(e){__extends(t,e);function t(){var t=e.apply(this,arguments)||this;t.remoteIdentities={};t.sessions={};return t}t.prototype.loadIdentity=function(){return me(this,void 0,void 0,(function(){return __generator(this,(function(e){return[2,this.identity||null]}))}))};t.prototype.saveIdentity=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){this.identity=e;return[2]}))}))};t.prototype.loadRemoteIdentity=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this.remoteIdentities[e]||null]}))}))};t.prototype.saveRemoteIdentity=function(e,t){return me(this,void 0,void 0,(function(){return __generator(this,(function(r){this.remoteIdentities[e]=t;return[2]}))}))};t.prototype.loadSession=function(e){return me(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this.sessions[e]||null]}))}))};t.prototype.saveSession=function(e,t){return me(this,void 0,void 0,(function(){return __generator(this,(function(r){this.sessions[e]=t;return[2]}))}))};return t}(Ji);e.BrowserStorage=Gi;e.CertificateStorage=Ri;e.CryptoServerError=Tt;e.KeyStorage=Pi;e.MemoryStorage=zi;e.RatchetStorage=Ji;e.SocketCrypto=ji;e.SocketProvider=Vi;e.getEngine=j;e.setEngine=q;return e}({},protobuf,fetch,WebSocket);self.WebcryptoSocket=e}}}));